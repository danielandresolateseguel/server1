<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración - Gastronomía</title>
  <link rel="stylesheet" href="index.css" />
  <link rel="icon" href="data:,">
  <script src="js/admin-wa-helper.js?v=3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Global CSRF Token
    let CSRF_TOKEN = '';

    // Function to fetch CSRF token from backend
    async function fetchCsrfToken() {
        try {
            const res = await fetch('/api/auth/csrf', { credentials: 'include' });
            if (res.ok) {
                const data = await res.json();
                if (data.token) {
                    CSRF_TOKEN = data.token;
                    console.log('CSRF Token loaded:', CSRF_TOKEN);
                }
            }
        } catch (e) {
            console.error('Error loading CSRF token:', e);
        }
    }
  </script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    header { display:flex; flex-direction: column; align-items: stretch; gap: 8px; margin-bottom: 16px; }
    .header-main { display:flex; align-items:center; gap: 8px; width: 100%; }
    .header-rest { display:flex; align-items:center; gap: 8px; flex: 1 1 auto; }
    .header-end { display:flex; align-items:center; gap: 10px; margin-left: auto; }
    @media (min-width: 961px) {
      .header-main { flex-wrap: nowrap; }
      .header-rest { order: 2; flex: 1 1 auto; }
      .header-end { order: 3; margin-left: auto; }
    }
    .controls { display:flex; flex-direction: column; gap:8px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap: nowrap; }
    .subcontrols { display:flex; gap:12px; align-items:center; flex-wrap: wrap; width:100%; }
    .controls.two-lines { flex-wrap: wrap; }
    .controls input, .controls select { height: 32px; }
    .controls button { height: 32px; padding: 0 12px; }
    #tenant-input { width: 220px; }
    #status-filter { width: 140px; }
    #search-input { flex: 1 1 280px; }
    .mobile-filters summary { cursor: pointer; padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
    .mobile-filters > div { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
    .right-actions { display:flex; gap:12px; align-items:center; flex-wrap: nowrap; margin-left: auto; }
    .controls .right-actions { order: 2; }
    .controls details.mobile-filters { order: 3; }
    .controls.two-lines details.mobile-filters[open] { flex: 1 0 100%; }
    .status-badge { padding: 2px 8px; border-radius: 8px; font-size: 12px; color:#fff; }
    .status-pendiente { background:#8a8a8a; }
    .status-preparacion { background:#1976d2; }
    .status-listo { background:#2e7d32; }
    .status-en_camino { background:#fb8c00; }
    .status-entregado { background:#6a1b9a; }
    .status-cancelado { background:#c62828; }
    table { width:100%; border-collapse: collapse; }
    body { max-width: 100vw; overflow-x: hidden; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }
    .actions { display:flex; gap:8px; align-items:center; }
    .small { font-size: 12px; color: #666; }
    .pill { display:inline-block; padding:2px 6px; background:#eee; border-radius: 12px; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr; grid-template-areas: "orders"; gap: 16px; align-items:start; }
    .grid > div:first-child { grid-area: orders; }
    .sla-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-left:6px; background:#bbb; }
    .sla-warning { background:#ff9800; }
    .sla-critical { background:#f44336; }
    .sla-label { margin-left:4px; font-size:12px; color:#666; }
    .delivered summary, .inventory summary { cursor:pointer; padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; }
    .canceled summary, .archived summary { cursor:pointer; padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; }
    .pager { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .phone-row { display:inline-flex; align-items:center; gap:6px; }
    .phone-action { width:28px; height:28px; min-height:0; padding:0; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background: var(--kds-accent); color:#fff; text-decoration:none; }
    .phone-action:hover { background: #3f5f8a; }
    .phone-action svg { width:16px; height:16px; fill:#fff; }
    .status-quick { display:inline-flex; gap:4px; flex-wrap:nowrap; margin-bottom:6px; }
    .status-action { width:24px; height:24px; min-height:0; padding:0; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-size:12px; line-height:1; transition: background-color 0.2s ease; cursor: pointer; }
    .status-action.preparacion { background:#1976d2; color:#fff; }
    .status-action.listo { background:#2e7d32; color:#fff; }
    .status-action.en_camino { background:#fb8c00; color:#fff; }
    .status-action.mesa { background:#fb8c00; color:#fff; }
    .status-action.entregado { background:#6a1b9a; color:#fff; }
    .status-action.cancelado { background:#c62828; color:#fff; }
    .kds-tooltip { position: fixed; display:none; background: rgba(33,33,33,0.92); color:#fff; font-size:12px; padding:6px 8px; border-radius:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.18); z-index: 10001; }
    .kds-tooltip.active { display:block; }
    .status-action.preparacion:hover { background:#1565c0; }
    .status-action.listo:hover { background:#1b5e20; }
    .status-action.en_camino:hover, .status-action.mesa:hover { background:#f57c00; }
    .status-action.entregado:hover { background:#4a148c; }
    .status-action.cancelado:hover { background:#b71c1c; }

    :root { --kds-bg: #f5f7fb; --kds-card-bg: #ffffff; --kds-border: #e6e8ee; --kds-text: #2c3e50; --kds-accent: #4a6fa5; 
      --st-pendiente: #90caf9; --st-preparacion: #ffd54f; --st-listo: #81c784; --st-en_camino: #4fc3f7; --st-entregado: #b0bec5; --st-cancelado: #ef9a9a; --st-overdue: #f44336; }
    body { background: var(--kds-bg); color: var(--kds-text); }
    header h1 { font-size: 1.2rem; font-weight: 600; color: #425b76; margin: 0; }
    button { min-height: 32px; padding: 0 12px; border: none; border-radius: 8px; background: var(--kds-accent); color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    button:hover { background: #3f5f8a; }
    .controls input, .controls select { border: 1px solid var(--kds-border); border-radius: 8px; padding: 0 10px; background: #fff; }
    table { background: var(--kds-card-bg); border: 1px solid var(--kds-border); border-radius: 8px; overflow: hidden; }
    th { background: #f0f3f8; font-weight: 600; color: #415a77; }
    tbody tr:nth-child(odd) { background: #fafcff; }
    tbody tr:hover { background: #eef3fb; }
    #order-detail, #login-box { box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
    .status-badge { font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .pill { background: #edf2ff; color: #4a6fa5; }
    .pill-mesa { font-weight: 700; }
    .sla-label { font-weight: 600; color: #445; }
    .sla-dot { transition: background-color 0.2s ease; }
    .delivered summary, .canceled summary, .archived summary, .inventory summary { background: #f0f3f8; border-color: var(--kds-border); }
    .actions button, .pager button { border-radius: 8px; }
    button { touch-action: manipulation; }
    .archived .copy-phone { background:#0f766e; color:#fff; }
    .archived .copy-phone:hover { background:#0b5e58; }
    .archived .view-detail { background:#1f2937; color:#fff; }
    
    /* New Order Modal Styles */
    .kds-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }
    .kds-modal.active {
      display: flex;
    }
    .kds-modal-content {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      width: 95%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: modalSlideUp 0.3s ease-out;
    }
    @keyframes modalSlideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #new-order-products .product-card-mini {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
      background: #fff;
    }
    #new-order-products .product-card-mini:hover {
      border-color: var(--kds-accent);
      background: #f0f7ff;
    }
    #new-order-cart-items .cart-item-mini {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
  .archived .view-detail:hover { background:#111827; }

    /* Product Edit Modal */
    #product-edit-modal .modal-body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { #product-edit-modal .modal-body-grid { grid-template-columns: 1fr; } }
    
    .edit-form-group { margin-bottom: 12px; }
    .edit-form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555; }
    .edit-form-group input, .edit-form-group textarea { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .edit-form-group textarea { resize: vertical; min-height: 60px; }

    /* Preview Card - matching user image style */
    .preview-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 320px;
      margin: 0 auto;
      border: 1px solid #eee;
    }
    .preview-image-placeholder {
      width: 100%;
      height: 180px;
      background-color: #333;
      background-image: url('https://images.unsplash.com/photo-1513104890138-7c749659a591?auto=format&fit=crop&w=600&q=80'); /* Pizza placeholder */
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .preview-content { padding: 16px; }
    .preview-title { font-size: 18px; font-weight: 700; color: #000; margin-bottom: 8px; line-height: 1.2; }
    .preview-desc { font-size: 14px; color: #444; margin-bottom: 16px; line-height: 1.4; min-height: 40px; }
    .preview-price { font-size: 20px; font-weight: 800; color: #000; margin-bottom: 16px; }
    .preview-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #ff6d00;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      cursor: default;
    }
    #metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .metric-card { background: var(--kds-card-bg); border: 1px solid var(--kds-border); border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .metric-label { font-size: 12px; color: #415a77; }
    .metric-value { font-size: 22px; font-weight: 700; color: #2c3e50; }
    .metric-sub { margin-top: 6px; font-size: 12px; color: #666; }
    .metric-card.delivered .metric-value { color: #2e7d32; }
    .metric-card.canceled .metric-value { color: #c62828; }
    .metric-card.money .metric-value { color: #1f2937; }
    body.no-auth header .toolbar, body.no-auth header .subcontrols { display: none !important; }
    body.no-auth .header-rest, body.no-auth .header-end { display: none !important; }
    body.no-auth .header-main > :not(h1) { display: none !important; }
    body.no-auth #top-controls, body.no-auth #metrics, body.no-auth #analytics, body.no-auth #cash-box, body.no-auth #cash-history, body.no-auth section.grid { display: none !important; }
    body.no-auth #login-box { display: block !important; }
    #cash-history { display:grid; grid-template-columns: 1fr; gap: 10px; }
    .history-card { background: var(--kds-card-bg); border: 1px solid var(--kds-border); border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th, .history-table td { border: 1px solid var(--kds-border); padding: 6px 8px; font-size: 12px; }
    .history-mobile { display: none; }
    .delivered-mobile, .canceled-mobile, .inventory-mobile, .archived-mobile { display:none; }
    #orders-mobile { display: none; }
      @media (max-width: 960px) {
      #orders-table { display: none; }
      #orders-mobile { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .history-table { display: none; }
      .history-mobile { display: grid; grid-template-columns: 1fr; gap: 8px; }
      .history-mobile .hm-row { background: #fff; border: 1px solid var(--kds-border); border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .history-mobile .hm-header { font-weight: 700; color: #425b76; margin-bottom: 6px; }
      .history-mobile .hm-meta { font-size: 12px; color: #6b7280; margin-bottom: 6px; }
      .history-mobile .hm-metrics { display: grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap: 6px; margin-bottom: 8px; }
      .history-mobile .hm-metrics .item { font-size: 13px; color: #1f2937; }
      .history-mobile .hm-actions { display: flex; gap: 8px; }
      #delivered-box table { display:none; }
      #delivered-box .delivered-mobile { display:grid; grid-template-columns: 1fr; gap:8px; }
      #canceled-box table { display:none; }
      #canceled-box .canceled-mobile { display:grid; grid-template-columns: 1fr; gap:8px; }
      #inventory-box table { display:none; }
      #inventory-box .inventory-mobile { display:grid; grid-template-columns: 1fr; gap:8px; }
      #archived-box table { display:none; }
      #archived-box .archived-mobile { display:grid; grid-template-columns: 1fr; gap:8px; }
      .card { background:#fff; border:1px solid var(--kds-border); border-radius:12px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); display:grid; grid-template-columns: 1fr; grid-template-rows: auto auto auto; gap:8px; align-items:flex-start; }
      .card .card-content { grid-column: 1; grid-row: 1; }
      .card .title { font-weight:700; color:#425b76; margin-bottom:4px; }
      .card .meta { font-size:12px; color:#6b7280; margin-bottom:6px; }
      .card .grid { display:grid; grid-template-columns: 1fr auto; gap:6px; align-items: center; }
      .card .grid .total-tip { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .card .state-line { grid-row: 2; }
      .card .actions { display:flex; gap:8px; margin-top:0; grid-column:1 / -1; grid-row:3; flex-direction:row; flex-wrap: wrap; align-items:center; justify-content:flex-start; width: 100%; }
      .card .actions .status-quick { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(42px, 1fr)); gap: 8px; }
      .card .actions .status-action { width: 100%; height: 36px; border-radius: 8px; }
      .card .actions .ver-detalle { width: 100%; }
    }
    .history-actions { display:flex; gap:8px; align-items:center; }
    #top-controls button { border: 1px solid var(--kds-border); border-radius: 8px; padding: 6px 10px; background:#fff; color:#2c3e50; }
    #top-controls button:hover { background:#f0f3f8; }
    .eye-btn { display:inline-flex; align-items:center; justify-content:center; height: 24px; padding: 0 8px; border: 1px solid var(--kds-border); border-radius: 8px; background:#fff; color:#2c3e50; }
    .eye-btn svg { width:16px; height:16px; display:block; }
    @media (max-width: 720px) {
      #top-controls { gap:6px; }
      #top-controls .top-actions { gap:6px; }
      #top-controls button { padding: 6px 8px; font-size: 13px; }
    }
    #cash-box { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
    #top-controls { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap: nowrap; }
    #top-controls .small { white-space: nowrap; }
    #top-controls .top-actions { display:flex; align-items:center; gap:8px; flex-wrap: nowrap; }
    .cash-card { background: var(--kds-card-bg); border: 1px solid var(--kds-border); border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .cash-title { font-weight: 700; color:#425b76; }
    .cash-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap: wrap; }
    .cash-row input, .cash-row textarea { border: 1px solid var(--kds-border); border-radius: 8px; padding: 6px 10px; }
    .cash-row input { height: 32px; }
    .cash-row textarea { width: 100%; min-height: 56px; }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; grid-template-areas: "orders"; }
    }
    /* Panel de detalle */
    #order-detail { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    #order-detail h3 { margin-top: 12px; margin-bottom: 8px; }
    .detail-items-table { width:100%; border-collapse: collapse; }
    .detail-items-table th, .detail-items-table td { border-bottom:1px solid #eee; padding:6px 8px; font-size:14px; }
    .detail-summary { margin-top: 8px; font-weight: 600; }
    .kds-modal { position: fixed; inset: 0; display: none; z-index: 10000; }
    .kds-modal.active { display: flex; align-items: center; justify-content: center; }
    .kds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 0; }
    .kds-modal-content { position: relative; z-index: 1; background: #fff; border: 1px solid var(--kds-border); border-radius: 12px; width: min(92vw, 820px); max-height: 88vh; overflow: auto; box-shadow: 0 12px 24px rgba(0,0,0,0.18); padding: 12px; }
    .kds-modal-close { position: absolute; right: 10px; top: 10px; }
    .kds-confirm { width: min(92vw, 420px); padding: 16px; }
    .auth-bar { display:flex; gap:8px; align-items:center; }
    .auth-badge { display:inline-block; padding: 2px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; }
    .auth-badge.on { background:#2e7d32; color:#fff; }
    .auth-badge.off { background:#b0bec5; color:#fff; }
    @media (max-width: 720px) {
      .archived .controls { flex-direction: row !important; align-items: center !important; flex-wrap: wrap !important; }
      .archived .controls > * { width: auto !important; }
      .archived .controls button { width: auto !important; flex: 0 0 auto !important; }
    }

    /* Responsivo: evitar scroll horizontal en móviles */
    @media (max-width: 720px) {
      header h1 { font-size: 1.2rem; width: 100%; margin: 8px 0; text-align: left; }
      .controls { flex-direction: column; align-items: stretch; gap: 8px; }
      .toolbar { flex-direction: column; align-items: stretch; gap: 8px; }
      .controls > * { width: 100%; }
      .controls label { width: 100%; }
      .controls input, .controls select, .controls button { width: 100%; }
      #tenant-input, #status-filter { width: 100% !important; }
      #search-input { flex: 0 0 auto; width: 100% !important; }
      .mobile-filters > div { flex-direction: column; align-items: stretch; gap: 6px; }
      .right-actions { flex-wrap: wrap; margin-left: 0; width: 100%; justify-content: space-between; }
      .auth-bar { width: 100%; justify-content: space-between; }
      header .controls { margin-top: 0; }
      .mobile-filters summary { padding: 8px 12px; }
      table { table-layout: fixed; }
      th, td { padding: 6px; font-size: 13px; word-break: break-word; }
      th:nth-child(2), td:nth-child(2) { display: none; }
      .actions { flex-wrap: wrap; gap: 8px; }
      .actions select { max-width: 100%; }
      .actions button { flex: 0 0 auto; width: 100%; }
      .status-quick { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .status-quick .status-action { width: 100%; height: 36px; font-size: 14px; border-radius: 8px; }
      .ver-detalle { width: 100%; }

      #orders-table { display: none !important; }
      #orders-mobile { display: grid; grid-template-columns: 1fr; gap: 12px; }
    }
    @media (max-width: 960px) {
      header { flex-direction: column; align-items: stretch; justify-content: flex-start; gap: 8px; }
      .header-main { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
      .header-end { margin-left: 0; gap: 8px; }
      .header-rest { flex: 0 0 100%; display: flex; flex-wrap: wrap; gap: 8px; }
      header h1 { width: 100%; margin: 8px 0; text-align: left; }
      .controls { flex-direction: column; align-items: stretch; gap: 8px; }
      .toolbar { flex-direction: column; align-items: stretch; gap: 8px; }
      .controls > * { width: 100%; }
      .controls label { width: 100%; }
      .controls input, .controls select, .controls button { width: 100%; }
      #tenant-input, #status-filter { width: 100% !important; }
      #search-input { flex: 0 0 auto; width: 100% !important; }
      .right-actions { flex-wrap: wrap; margin-left: 0; width: 100%; justify-content: space-between; }
      .auth-bar { width: 100%; justify-content: space-between; }
    }
    @media (min-width: 961px) {
      #orders-table thead { display: none; }
      #orders-table { display: block; border: none; box-shadow: none; background: transparent; }
      #orders-table tbody { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, 280px); justify-content: start; margin: 0; }
      #orders-table tbody tr { display: block; background: var(--kds-card-bg); border: 1px solid var(--kds-border); border-radius: 12px; padding: 10px 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
      #orders-table tbody tr td { display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center; border: none; padding: 7px 0; }
      #orders-table tbody tr td::before { display: inline-block; font-weight: 600; color: #445; pointer-events: none; }
      #orders-table tbody tr td:nth-child(1)::before { content: 'ID'; }
      #orders-table tbody tr td:nth-child(2)::before { content: 'Fecha'; }
      #orders-table tbody tr td:nth-child(3)::before { content: 'Tipo'; }
      #orders-table tbody tr td:nth-child(4)::before { content: 'Destino'; }
      #orders-table tbody tr td:nth-child(5)::before { content: 'Teléfono'; }
      #orders-table tbody tr td:nth-child(6)::before { content: 'Total'; }
      #orders-table tbody tr td:nth-child(7)::before { content: 'Estado'; }
      #orders-table tbody tr td:nth-child(8)::before { content: 'Acciones'; }
      #orders-table tbody tr td.actions { grid-template-columns: 1fr; }
      #orders-table tbody tr td.actions select { width: 100%; margin-bottom: 8px; }
      #orders-table tbody tr td.actions button { width: 100%; margin-bottom: 8px; }
      #orders-table tbody tr td.items-preview { display: block; padding: 4px 0; }
      #orders-table tbody tr td.items-preview::before { display: none; }
      #orders-table tbody tr td.items-preview .small { color: #666; }
      #orders-table tbody tr td .order-total-tip { display: block; margin: 4px 0 0 0; }
    }
    @media (min-width: 1600px) {
      #orders-table tbody { grid-template-columns: repeat(5, 280px); max-width: calc(5 * 280px + 4 * 12px); margin: 0; justify-content: start; }
    }
    #orders-table tbody tr.card-overdue { border-color: var(--st-overdue); box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.3), 0 6px 16px rgba(0,0,0,0.08); }
    /* Contorno por estado en tarjetas */
    #orders-table tbody tr.card-pendiente { border-color: var(--st-pendiente); box-shadow: 0 0 0 2px rgba(144,202,249,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    #orders-table tbody tr.card-preparacion { border-color: var(--st-preparacion); box-shadow: 0 0 0 2px rgba(255,213,79,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    #orders-table tbody tr.card-listo { border-color: var(--st-listo); box-shadow: 0 0 0 2px rgba(129,199,132,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    #orders-table tbody tr.card-en_camino { border-color: var(--st-en_camino); box-shadow: 0 0 0 2px rgba(79,195,247,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    #orders-table tbody tr.card-entregado { border-color: var(--st-entregado); box-shadow: 0 0 0 2px rgba(176,190,197,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    #orders-table tbody tr.card-cancelado { border-color: var(--st-cancelado); box-shadow: 0 0 0 2px rgba(239,154,154,0.25), 0 6px 16px rgba(0,0,0,0.08); }
    @page { size: A4; margin: 12mm; }
    @media print {
      html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body * { visibility: hidden; }
      #order-detail, #order-detail * { visibility: visible; }
      #order-detail { position: absolute; left: 0; top: 0; width: 100%; font-size: 12px; line-height: 1.3; }
      .detail-items-table { width: 100%; border-collapse: collapse; }
      .detail-items-table thead { display: table-header-group; }
      .detail-items-table tr { page-break-inside: avoid; }
      .detail-items-table th, .detail-items-table td { padding: 4px; }
    }
    @media print {
      html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body.print-modal * { visibility: hidden !important; }
      body.print-modal #order-detail-modal,
      body.print-modal #order-detail-modal * { visibility: visible !important; }
      body.print-modal .kds-modal-overlay { display: none !important; }
      body.print-modal .kds-modal-content { box-shadow: none; border: 0; padding: 0; }
      body.print-modal #order-detail { visibility: hidden; }
      body.print-modal #detail-modal-body { position: static; width: 100%; font-size: 12px; line-height: 1.3; }
      body.print-modal .detail-items-table { width: 100%; border-collapse: collapse; }
      body.print-modal .detail-items-table thead { display: table-header-group; }
      body.print-modal .detail-items-table tr { page-break-inside: avoid; }
      body.print-modal .detail-items-table th, body.print-modal .detail-items-table td { padding: 4px; }
    }
    @media print {
      html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body.print-ticket * { visibility: hidden !important; }
      body.print-ticket #order-detail-modal,
      body.print-ticket #order-detail-modal * { visibility: visible !important; }
      body.print-ticket .kds-modal-overlay { display: none !important; }
      body.print-ticket .kds-modal-content { width: 80mm; max-width: none; padding: 0; border: 0; box-shadow: none; }
      body.print-ticket #detail-modal-body { font-family: 'Courier New', monospace; font-size: 12pt; line-height: 1.4; color:#000; }
      body.print-ticket .d-id { font-size: 16pt; font-weight: 700; }
      body.print-ticket .d-tenant, body.print-ticket .d-type, body.print-ticket .d-status { display:none !important; }
      body.print-ticket .timeline { display:none !important; }
      body.print-ticket .d-date, body.print-ticket .d-dest, body.print-ticket .d-phone, body.print-ticket .d-notes { margin: 2px 0; }
      body.print-ticket h3, body.print-ticket .detail-summary, body.print-ticket .tip-section { display: none !important; }
      body.print-ticket .detail-items-table { width: 100%; border-collapse: collapse; }
      body.print-ticket .detail-items-table thead { display: none; }
      body.print-ticket .detail-items-table td { border-bottom: 1px solid #000; }
      body.print-ticket .detail-items-table tr { page-break-inside: avoid; }
      body.print-ticket .detail-items-table th:nth-child(3),
      body.print-ticket .detail-items-table th:nth-child(4),
      body.print-ticket .detail-items-table td:nth-child(3),
      body.print-ticket .detail-items-table td:nth-child(4) { display: none; }
      body.print-ticket .detail-items-table td:nth-child(2) { text-transform: uppercase; }
      body.print-ticket .pill, body.print-ticket .status-badge { display: none; }
      body.print-ticket .detail-items-table td.small {
        color: #000 !important;
        font-weight: bold;
        font-size: 11pt;
        border-bottom: none !important;
      }
    }

    /* Table Management Styles */
    #table-management {
      display: none;
      background: #fff;
      border: 1px solid var(--kds-border);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      min-height: 600px;
    }
    .table-map-container {
      position: relative;
      width: 100%;
      height: 600px;
      background-color: #f0f3f8;
      background-image: radial-gradient(#d1d5db 1px, transparent 1px);
      background-size: 20px 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      overflow: auto;
    }
    .table-item {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #fff;
      border: 2px solid #aaa;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      z-index: 10;
    }
    .table-item:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
      z-index: 20;
    }
    .table-item.round { border-radius: 50%; }
    .table-item.rect { border-radius: 8px; }
    .table-item.bar { border-radius: 4px; border-width: 3px; }
    
    .table-item.status-free { border-color: #4caf50; background: #e8f5e9; }
    .table-item.status-occupied { border-color: #f44336; background: #ffebee; }
    .table-item.status-reserved { border-color: #ff9800; background: #fff3e0; }
    .table-item.status-bill { border-color: #2196f3; background: #e3f2fd; }

    .table-label { font-weight: 700; font-size: 14px; color: #333; pointer-events: none; }
    .table-seats { font-size: 10px; color: #666; margin-top: 2px; pointer-events: none; }
    
    .table-item.selected {
      box-shadow: 0 0 0 3px #2196F3, 0 8px 12px rgba(0,0,0,0.15);
      z-index: 50;
    }
    
    .table-total {
      font-weight: 800;
      color: #d32f2f;
      background: rgba(255,255,255,0.95);
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 4px;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: 1px solid #ffcdd2;
      z-index: 15;
    }

    .tm-toolbar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }
    .tm-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%; }
    .tm-legend { display: flex; gap: 16px; margin-left: auto; align-items: center; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
  </style>
  </head>
<body>
  <header>
    <div class="header-main">
      <h1>Panel de Administración (KDS)</h1>
      <div class="header-end">
        <label class="small" style="display:flex; align-items:center; gap:6px;"><input id="sound-toggle" type="checkbox" checked /> Sonido</label>
        <div class="auth-bar">
          <span id="auth-status-badge" class="auth-badge off">Sin sesión</span>
          <button id="login-open-btn">Entrar</button>
          <button id="logout-btn" disabled>Salir</button>
        </div>
      </div>
      <div class="header-rest">
        <label>Establecimiento:
          <input id="tenant-input" list="tenants-list" type="text" value="gastronomia-local1" />
          <datalist id="tenants-list"></datalist>
        </label>

        <div style="display:flex; align-items:center; border:1px solid #ccc; border-radius:4px; background:#fff; padding-right:4px;">
          <input id="search-input" type="text" placeholder="Buscar por ID, nombre..." style="border:none; outline:none; height:30px; padding:0 8px; width:250px;" />
          <button id="search-btn" title="Buscar" style="border:none; background:none; cursor:pointer; padding:4px; display:flex; align-items:center; color:#555;">
            <svg viewBox="0 0 24 24" style="width:20px; height:20px;"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          </button>
        </div>
        <button id="btn-new-order" style="background: #2e7d32; color: #fff; font-weight: 600; display: flex; align-items: center; gap: 6px; padding: 0 16px;">
          <span style="font-size: 18px; line-height: 1;">+</span> Pedido
        </button>
      </div>
    </div>
    <div class="subcontrols">

      <button id="tables-open" style="background:#673ab7; color:#fff;">Gestión Mesas</button>
      <button id="carousel-open" style="background:#e91e63; color:#fff;">Carta Online</button>
    </div>
  </header>

  

  <div id="top-controls" style="display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom:8px;">
    <div class="small" style="font-weight:700; color:#415a77; display:flex; align-items:center; gap:6px;">Movimientos del día
      <button id="daily-eye" class="eye-btn" aria-label="Ocultar movimientos">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
      </button>
    </div>
    <div class="top-actions">
      <span class="small" style="display:flex; align-items:center; gap:6px;">Caja
        <span id="cash-status-label" class="small" style="padding:2px 6px; border-radius:12px; background:#b0bec5; color:#fff;">Sin datos</span>
        <button id="cash-eye-top" class="eye-btn" aria-label="Ocultar caja">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
        </button>
      </span>
      <span class="small" style="display:flex; align-items:center; gap:6px;">Historial
        <button id="history-eye-top" class="eye-btn" aria-label="Ocultar historial">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
        </button>
      </span>
    </div>
  </div>
  <div id="metrics" class="small" style="margin-bottom:12px;"></div>
  <div id="cash-box" style="margin-bottom:12px;"></div>
  <div id="cash-history" style="margin-bottom:12px;"></div>


  <div id="login-box" style="border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-bottom:16px; max-width:360px;">
    <h2>Ingresar</h2>
    <label style="display:block; margin-bottom:12px;">Establecimiento
      <input id="login-tenant" list="tenants-list" type="text" style="width:100%; height:32px;" />
    </label>
    <label style="display:block; margin-bottom:8px;">Usuario
      <input id="login-user" type="text" style="width:100%; height:32px;" />
    </label>
    <label style="display:block; margin-bottom:12px;">Clave
      <input id="login-pass" type="password" style="width:100%; height:32px;" />
    </label>
    <label style="display:flex; align-items:center; gap:8px; margin-top:4px;"><input id="login-show" type="checkbox" /> Ver clave</label>
    <label style="display:flex; align-items:center; gap:8px; margin-top:4px;"><input id="login-remember" type="checkbox" /> Recordar</label>
    <button id="login-btn" style="height:32px;">Entrar</button>
    <p class="small" id="login-error" style="color:#c62828; display:none; margin-top:8px;">Credenciales inválidas</p>
  </div>

  <section class="grid">
    <div style="display:flex; align-items:center; gap:8px;">
      <h2>Pedidos</h2>
      <button id="orders-reset-btn" title="Limpiar Pedidos Activos" style="background:#f44336; color:#fff;">
        <svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
      </button>
      <button id="orders-config-btn" title="Configuración de Pedidos" style="background:#607d8b;">
        <svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      </button>
      <button id="whatsapp-config-btn" title="Configuración de WhatsApp" style="background:#25D366;">
        <svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
      </button>
    </div>

    <!-- WHATSAPP CONFIG MODAL -->
    <div id="whatsapp-config-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:white; padding:20px; border-radius:8px; width:400px; box-shadow:0 2px 10px rgba(0,0,0,0.2); max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0;">Configuración WhatsApp</h3>
          <button id="cfg-whatsapp-close-btn" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <input type="checkbox" id="cfg-whatsapp-enabled-modal" checked>
          <span>Habilitar envío de mensajes</span>
        </label>
        
        <label style="display:block; margin-bottom:16px;">
          <span style="font-size:12px; display:block; margin-bottom:2px; font-weight:bold;">Número de WhatsApp:</span>
          <input type="text" id="cfg-whatsapp-number-modal" placeholder="+5492615893590" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </label>

        <label style="display:block; margin-bottom:16px;">
          <span style="font-size:12px; display:block; margin-bottom:2px; font-weight:bold;">Plantilla del Mensaje:</span>
          <div style="font-size:11px; color:#666; margin-bottom:4px;">
            Variables disponibles: {PEDIDO_INFO}, {ITEMS}, {TOTALES}, {NOTAS}
          </div>
          <textarea id="cfg-whatsapp-template-modal" rows="10" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-family:monospace; font-size:12px;"></textarea>
          <button id="cfg-whatsapp-restore-btn" style="margin-top:4px; background:none; border:none; color:#2196F3; font-size:11px; cursor:pointer; padding:0; text-decoration:underline;">Restaurar predeterminado</button>
        </label>

        <div style="text-align:right;">
          <button id="cfg-whatsapp-save-btn" style="background:#25D366; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">Guardar</button>
        </div>
      </div>
    </div>
      <table id="orders-table" class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Teléfono</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
      <tbody id="orders-tbody"></tbody>
    </table>
    <div id="orders-mobile" class="orders-mobile"></div>
    <p class="small" id="orders-count"></p>
    <div class="pager">
      <button id="prev-page">Anterior</button>
      <span id="page-info" class="small"></span>
      <button id="next-page">Siguiente</button>
    </div>
    <details class="delivered" id="delivered-box">
      <summary>Entregados</summary>
      <div class="pager" style="margin:8px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <label>Tamaño
            <select id="del-page-size">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </label>
          <button id="del-prev">Anterior</button>
          <button id="del-next">Siguiente</button>
          <span id="del-page-info" class="small" style="color:#666;"></span>
        </div>
        <button id="close-delivered-box" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar lista</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Teléfono</th>
            <th>Total Pagado</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="delivered-tbody"></tbody>
      </table>
      <div id="delivered-mobile" class="delivered-mobile"></div>
    </details>
    <details class="canceled" id="canceled-box">
      <summary>Cancelados</summary>
      <div class="pager" style="margin:8px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <label>Tamaño
            <select id="can-page-size">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </label>
          <button id="can-prev">Anterior</button>
          <button id="can-next">Siguiente</button>
          <span id="can-page-info" class="small" style="color:#666;"></span>
        </div>
        <button id="close-canceled-box" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar lista</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="canceled-tbody"></tbody>
      </table>
      <div id="canceled-mobile" class="canceled-mobile"></div>
    </details>
    <details class="inventory" id="inventory-box">
      <summary>Inventario</summary>
      <div class="actions" style="margin:8px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <button id="inv-create-btn" style="background-color:#4caf50; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">+ Nuevo Producto</button>
          <button id="inv-reload">Recargar</button>
          <span id="inv-hint" class="small">Editar stock requiere login</span>
        </div>
        <button id="close-inventory-box" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar lista</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Detalles</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="inventory-tbody"></tbody>
      </table>
      <div id="inventory-mobile" class="inventory-mobile"></div>
    </details>

    <details class="carousel" id="carousel-box">
      <summary>Carta Online (Carrusel)</summary>
      <div class="actions" style="margin:8px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <button id="car-create-btn" style="background-color:#4caf50; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">+ Nuevo Slide</button>
          <button id="car-reload">Recargar</button>
          <button id="header-config-open" style="background-color:#2196F3; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cabecera</button>
        </div>
        <button id="close-carousel-box" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar lista</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Imagen</th>
            <th>Título</th>
            <th>Texto</th>
            <th>Posición</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="carousel-tbody"></tbody>
      </table>
      <div id="carousel-mobile" class="carousel-mobile"></div>
    </details>
    <details class="archived" id="archived-box">
      <summary>Historial de Pedidos</summary>
      <div class="controls" style="margin:12px 0; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
        <!-- Search Bar Row -->
        <div style="margin-bottom: 12px;">
           <input id="arch-search" type="text" placeholder="Buscar por ID, Cliente o Dirección..." style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;" />
        </div>

        <!-- Filters Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; font-weight: 600; color: #495057;">Desde</label>
                <input id="arch-from" type="date" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;" />
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; font-weight: 600; color: #495057;">Hasta</label>
                <input id="arch-to" type="date" style="padding: 6px; border: 1px solid #ced4da; border-radius: 4px;" />
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; font-weight: 600; color: #495057;">Tipo de Pedido</label>
                <select id="arch-order-type" style="padding: 7px; border: 1px solid #ced4da; border-radius: 4px; background: white;">
                    <option value="">Todos</option>
                    <option value="mesa">Mesa</option>
                    <option value="direccion">Delivery</option>
                    <option value="retiro">Retiro</option>
                </select>
            </div>
             <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; font-weight: 600; color: #495057;">Filtrar por fecha</label>
                <select id="arch-date-mode" style="padding: 7px; border: 1px solid #ced4da; border-radius: 4px; background: white;">
                    <option value="archived" selected>Fecha de archivado</option>
                    <option value="order">Fecha de pedido</option>
                </select>
            </div>
        </div>

        <!-- Actions Row -->
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
             <button id="arch-export-btn" style="background: #fff; color: #28a745; border: 1px solid #28a745; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                Exportar CSV
             </button>
             <button id="arch-filter-btn" style="background: #007bff; color: white; border: none; padding: 8px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                Buscar
             </button>
        </div>
      </div>
      <div class="pager" style="margin:8px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <label>Tamaño
            <select id="arch-page-size">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </label>
          <button id="arch-prev">Anterior</button>
          <button id="arch-next">Siguiente</button>
          <button id="arch-reload">Recargar</button>
          <span id="arch-page-info" class="small" style="color:#666;"></span>
        </div>
        <button id="close-archived-box" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar lista</button>
      </div>
      <div id="archived-metrics" class="small" style="margin:6px 0;color:#444;"></div>
      <h3 class="small">Entregados archivados <span id="arch-del-count"></span></h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="archived-delivered-tbody"></tbody>
      </table>
      <div id="archived-mobile-del" class="archived-mobile"></div>
      <h3 class="small" style="margin-top:12px;">Cancelados archivados <span id="arch-can-count"></span></h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="archived-canceled-tbody"></tbody>
      </table>
      <div id="archived-mobile-can" class="archived-mobile"></div>
      <h3 class="small" style="margin-top:12px;">Limpiados archivados <span id="arch-reset-count"></span></h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Destino</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="archived-reset-tbody"></tbody>
      </table>
      <div id="archived-mobile-reset" class="archived-mobile"></div>
    </details>

    <div style="margin: 12px 0; border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fff;">
      <h3 style="margin: 0 0 8px 0; font-size: 1rem; color: #425b76;">Filtros y Exportación</h3>
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;">
        <details class="mobile-filters" id="more-filters" open style="flex: 1; min-width: 280px;">
          <summary>Más filtros de pedidos</summary>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <label>Desde <input id="from-date" type="date" /></label>
            <label>Hasta <input id="to-date" type="date" /></label>
            <label>Tamaño
              <select id="page-size">
                <option value="20">20</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </label>
          </div>
        </details>
        <button id="orders-export-btn" style="background:#e0e0e0; color:#333; border:1px solid #ccc; cursor:pointer; padding:8px 16px; border-radius:6px; display:flex; align-items:center; gap:6px; height:auto;">
          <svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
          Exportar pedidos (CSV)
        </button>
      </div>
    </div>
  </div>
  
  </section>

  <!-- Table Management Section -->
  <section id="table-management">
    <div class="tm-toolbar">
      <!-- Zone Controls -->
      <div class="tm-row" style="background: #f5f7fb; padding: 8px; border-radius: 6px;">
        <h2 style="margin:0; font-size:1.2rem; color:#425b76;">Salón:</h2>
        <select id="tm-zone-select" style="padding:6px; min-width: 150px; border:1px solid #ccc; border-radius:4px; font-weight:600;"></select>
        <button id="tm-edit-zone" title="Renombrar Salón" style="background:#fff; color:#333; border:1px solid #ccc; padding:6px;"><svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
        <button id="tm-add-zone" title="Nuevo Salón" style="background:#fff; color:#333; border:1px solid #ccc; padding:6px;">+ Nuevo</button>
        <button id="tm-del-zone" title="Eliminar Salón" style="background:#fff; color:#d32f2f; border:1px solid #ccc; padding:6px;"><svg style="width:16px;height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
      </div>

      <!-- Table Controls -->
      <div class="tm-row">
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="tm-shape-select" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <option value="rect">Rectangular</option>
            <option value="round">Redonda</option>
            <option value="bar">Barra</option>
          </select>
          <select id="tm-size-select" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <option value="small">Pequeña (2p)</option>
            <option value="medium" selected>Mediana (4p)</option>
            <option value="large">Grande (6-8p)</option>
            <option value="xlarge">Extra Grande</option>
          </select>
          <button id="tm-add-table" style="background:#fff; color:#333; border:1px solid #ccc;">+ Agregar</button>
          <button id="tm-merge-btn" style="background:#fff; color:#333; border:1px solid #ccc; margin-left: 4px;">🔗 Unir Mesas</button>
          <div id="tm-merge-controls" style="display:none; align-items:center; gap:8px; margin-left:8px;">
              <span id="tm-merge-msg" style="font-size:12px; color:#666;">Selecciona mesas...</span>
              <button id="tm-confirm-merge" style="background:#4caf50; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Confirmar</button>
              <button id="tm-cancel-merge" style="background:#f44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">X</button>
          </div>
        </div>

        <div style="height: 24px; width: 1px; background: #ddd; margin: 0 8px;"></div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="tm-rotate-btn" title="Rotar Seleccionada" disabled style="background:#fff; color:#333; border:1px solid #ccc; opacity: 0.5;">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24"><path fill="currentColor" d="M16.48 2.52c3.27 1.55 5.61 4.72 5.97 8.48h1.5C23.44 4.84 18.29 0 12 0l-1 2h1l4.48.52zM12 5c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9h-2c0 3.86-3.14 7-7 7s-7-3.14-7-7 3.14-7 7-7V5zM7.52 21.48C4.25 19.94 1.91 16.76 1.55 13H.05C.56 19.16 5.71 24 12 24l1-2h-1l-4.48-.52z"/></svg>
            Rotar
          </button>
          <button id="tm-del-btn" title="Eliminar Seleccionada" disabled style="background:#fff; color:#d32f2f; border:1px solid #ccc; opacity: 0.5;">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Eliminar
          </button>
        </div>

        <div class="tm-legend">
          <button id="tm-close-btn" style="background:#f44336; color:#fff; margin-right: 12px; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cerrar</button>
          <button id="tm-save-layout" style="background:#2196F3; color:#fff; margin-right: 12px;">Guardar Distribución</button>
          <div class="legend-item"><div class="legend-dot" style="background:#4caf50;"></div> Libre</div>
          <div class="legend-item"><div class="legend-dot" style="background:#f44336;"></div> Ocupada</div>
          <div class="legend-item"><div class="legend-dot" style="background:#ff9800;"></div> Reservada</div>
          <div class="legend-item"><div class="legend-dot" style="background:#2196f3;"></div> Cuenta</div>
        </div>
      </div>
    </div>
    
    <div id="restaurant-map" class="table-map-container">
      <!-- Tables will be rendered here by JS -->
    </div>
  </section>

  <div id="order-detail-modal" class="kds-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="kds-modal-overlay"></div>
      <div class="kds-modal-content">
        <button id="detail-modal-close" class="kds-modal-close">Cerrar</button>
        <button id="detail-modal-print" style="position:absolute; right:90px; top:10px; background:#607d8b; color:white; border:none; border-radius:4px; padding:6px 12px; font-weight:bold; cursor:pointer;">Imprimir</button>
        <div id="detail-modal-body"></div>
      </div>
  </div>

  <div id="confirm-modal" class="kds-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="kds-modal-overlay"></div>
    <div class="kds-modal-content kds-confirm">
      <p id="confirm-message" style="margin:0 0 12px 0;"></p>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="confirm-yes">Sí</button>
        <button id="confirm-no" style="background:#c62828;">No</button>
      </div>
    </div>
  </div>

  <div id="payment-modal" class="kds-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="kds-modal-overlay"></div>
    <div class="kds-modal-content kds-confirm" style="max-width: 350px;">
      <h3 style="margin:0 0 12px 0; font-size:16px; color:#333;">Seleccione medio de pago</h3>
      
      <div id="payment-details-box" style="margin-bottom:12px; padding:12px; background:#f0f7ff; border-radius:6px; border:1px solid #cce5ff; display:none;">
          <div id="pm-subtotal-row" style="font-size:14px; margin-bottom:4px; display:flex; justify-content:space-between; display:none;">
            <span>Subtotal:</span>
            <strong id="pm-subtotal">$0</strong>
          </div>
          <div id="pm-shipping-row" style="font-size:14px; margin-bottom:8px; display:flex; justify-content:space-between; display:none;">
            <span>Costo envío:</span>
            <strong id="pm-shipping">$0</strong>
          </div>
          <div id="pm-order-total-row" style="font-size:14px; margin-bottom:8px; display:flex; justify-content:space-between;">
            <span>Total pedido:</span>
            <strong id="pm-order-total">$0</strong>
          </div>
          <label id="pm-tip-row" style="display:flex; align-items:center; gap:8px; font-size:14px; cursor:pointer; padding:4px 0;">
             <input type="checkbox" id="pm-tip-toggle">
             <span>Propina 10%</span>
             <span id="pm-tip-amt" style="margin-left:auto; color:#666;">+$0</span>
          </label>
          <div style="margin-top:8px; font-size:18px; font-weight:700; color:#0056b3; border-top:1px solid #ddd; padding-top:8px; display:flex; justify-content:space-between;">
             <span>Total a cobrar:</span>
             <span id="pm-final-total">$0</span>
          </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:8px;">
        <button class="pay-option-btn" data-method="contado" style="padding:12px; text-align:left; font-size:14px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight:600;">Contado (Efectivo)</span>
          <svg style="width:16px;height:16px;opacity:0.5;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
        <button class="pay-option-btn" data-method="pos" style="padding:12px; text-align:left; font-size:14px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight:600;">POS / QR</span>
          <svg style="width:16px;height:16px;opacity:0.5;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
        <button class="pay-option-btn" data-method="transferencia" style="padding:12px; text-align:left; font-size:14px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight:600;">Transferencia</span>
          <svg style="width:16px;height:16px;opacity:0.5;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
        <button class="pay-option-btn" data-method="mixed" style="padding:12px; text-align:left; font-size:14px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight:600;">Pago Mixto (Dividir)</span>
          <svg style="width:16px;height:16px;opacity:0.5;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
        </button>

        <div id="mixed-payment-box" style="display:none; background:#f9f9f9; padding:12px; border:1px solid #ddd; border-radius:6px; margin-top:-4px;">
           <div style="font-size:12px; color:#666; margin-bottom:8px;">Ingrese los montos para cada medio:</div>
           
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
             <label style="font-size:13px; font-weight:600;">Efectivo</label>
             <input type="number" class="mixed-input" data-key="contado" value="0" min="0" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px; text-align:right;">
           </div>
           
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
             <label style="font-size:13px; font-weight:600;">POS / QR</label>
             <input type="number" class="mixed-input" data-key="pos" value="0" min="0" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px; text-align:right;">
           </div>
           
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
             <label style="font-size:13px; font-weight:600;">Transferencia</label>
             <input type="number" class="mixed-input" data-key="transferencia" value="0" min="0" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px; text-align:right;">
           </div>
           
           <div style="border-top:1px solid #ddd; margin-top:8px; padding-top:8px; display:flex; justify-content:space-between; font-size:13px;">
             <span>Total Ingresado:</span>
             <span id="mixed-total-entered">$0</span>
           </div>
           <div style="display:flex; justify-content:space-between; font-size:13px; color:#d9534f; font-weight:700;">
             <span>Faltante:</span>
             <span id="mixed-remaining">$0</span>
           </div>
           
           <button id="confirm-mixed-pay" disabled style="width:100%; margin-top:12px; background:#4caf50; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; opacity:0.5;">Confirmar Pago Mixto</button>
        </div>
      </div>
      <div style="margin-top:12px; text-align:right;">
        <button id="payment-cancel" style="background:#e0e0e0; color:#333; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="status-tooltip" class="kds-tooltip" aria-hidden="true"></div>

  <div id="product-edit-modal" class="kds-modal" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:10000;">
    <div class="kds-modal-overlay" style="position:absolute; inset:0; background:rgba(0,0,0,0.5);"></div>
    <div class="kds-modal-content" role="dialog" aria-modal="true" style="position:relative; background:#fff; width:90%; max-width:800px; margin:40px auto; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); max-height:90vh; display:flex; flex-direction:column;">
      <div class="modal-header" style="padding:16px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:18px; font-weight:700;">Editar Producto</h3>
        <button class="close-modal" style="background:transparent; color:#666; font-size:24px; padding:0; box-shadow:none;">&times;</button>
      </div>
      <div class="modal-body" style="padding:24px; overflow-y:auto; flex:1;">
        <div class="modal-body-grid">
          <div class="edit-form">
            <div class="edit-form-group">
              <label>ID del Producto</label>
              <input type="text" id="edit-prod-id" disabled style="background:#f5f5f5; color:#777;">
            </div>
            <div class="edit-form-group">
              <label>Nombre del Producto</label>
              <input type="text" id="edit-prod-name" placeholder="Ej: Pizza Napolitana">
            </div>
            <div class="edit-form-group">
              <label>Descripción / Detalles</label>
              <textarea id="edit-prod-details" placeholder="Ingredientes, detalles..."></textarea>
            </div>
            <div class="edit-form-group">
              <label>URL Imagen</label>
              <div style="display:flex; gap:8px;">
                <input type="text" id="edit-prod-image" placeholder="Ej: Imagenes/PIZZA.webp" style="flex:1;">
                <button id="edit-prod-trigger-upload" type="button" style="background:#4a6fa5; color:white; border:none; padding:0 12px; border-radius:4px; cursor:pointer;">Subir</button>
                <input type="file" id="edit-prod-file" accept="image/*" style="display:none;">
              </div>
              <div style="margin-top:4px;">
                 <button id="edit-prod-delete-img-btn" type="button" style="background:#d9534f; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px; display:none;">Eliminar imagen actual</button>
              </div>
            </div>
            <div class="edit-form-group">
              <label>Precio ($)</label>
              <input type="number" id="edit-prod-price" min="0">
            </div>
            <div class="edit-form-group">
              <label>Stock</label>
              <input type="number" id="edit-prod-stock" min="0">
            </div>
            <div class="edit-form-group">
              <label>Categorías de filtro (menú principal)</label>
              <select id="edit-prod-food-cats" multiple style="width:100%; padding:8px;">
                <option value="sandwich">Sándwich</option>
                <option value="pizzas">Pizzas</option>
                <option value="comen-dos">Comen dos</option>
                <option value="al-plato">Al plato</option>
                <option value="bebidas">Bebidas</option>
                <option value="cocteles">Cocteles</option>
                <option value="postres">Postres</option>
              </select>
              <small>Usado para los filtros de la carta online.</small>
            </div>
            <div class="edit-form-group">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="edit-prod-active" style="width:auto;"> Activo (visible en menú)
              </label>
            </div>
            <div class="small" style="color:#666; margin-top:8px;" id="edit-prod-last-mod"></div>
          </div>
          <div class="preview-section" style="background:#f9f9f9; padding:20px; border-radius:8px; display:flex; justify-content:center; align-items:flex-start;">
            <!-- Preview Card -->
            <div class="preview-card">
              <div class="preview-image-placeholder"></div>
              <div class="preview-content">
                <div class="preview-title" id="preview-title">Título Producto</div>
                <div class="preview-desc" id="preview-desc">Descripción del producto...</div>
                <div class="preview-price" id="preview-price">$0 ARS</div>
                <button class="preview-btn">Añadir al carrito</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="padding:16px 24px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
        <button class="cancel-btn" style="background:#f5f5f5; color:#333; box-shadow:none; border:1px solid #ddd;">Cancelar</button>
        <button class="save-btn" style="background:#4caf50;">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <div id="carousel-modal" class="kds-modal" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:10000;">
    <div class="kds-modal-overlay" style="position:absolute; inset:0; background:rgba(0,0,0,0.5);"></div>
    <div class="kds-modal-content" role="dialog" aria-modal="true" style="position:relative; background:#fff; width:90%; max-width:600px; margin:40px auto; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
      <div class="modal-header" style="padding:16px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:18px; font-weight:700;">Editar Slide</h3>
        <button class="close-modal" style="background:transparent; color:#666; font-size:24px; padding:0; box-shadow:none;">&times;</button>
      </div>
      <div class="modal-body" style="padding:24px; overflow-y:auto; flex:1;">
        <div class="edit-form">
            <input type="hidden" id="car-edit-id">
            <div class="edit-form-group">
              <label>Imagen URL</label>
              <div style="display:flex; gap:8px;">
                <input type="text" id="car-edit-image" placeholder="URL o subir imagen">
                <input type="file" id="car-edit-file" accept="image/*" style="display:none;">
                <button id="car-upload-btn" type="button" style="background:#4a6fa5; color:white; border:none; padding:0 12px; border-radius:4px; cursor:pointer;">Subir</button>
              </div>
            </div>
            <div class="edit-form-group">
              <label>Título</label>
              <input type="text" id="car-edit-title" placeholder="Título del slide">
            </div>
            <div class="edit-form-group">
              <label>Texto / Descripción</label>
              <textarea id="car-edit-text" placeholder="Descripción breve"></textarea>
            </div>
            <div class="edit-form-group">
              <label>Color de título</label>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <div style="display:flex; align-items:center; gap:6px;">
                  <input type="color" id="car-edit-title-color-picker" value="#ffffff" style="width:40px; height:28px; padding:0; border:none; background:transparent;">
                  <input type="text" id="car-edit-title-color" placeholder="ej: #FFFFFF o red">
                </div>
              </div>
            </div>
            <div class="edit-form-group">
              <label>Color de texto / descripción</label>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <div style="display:flex; align-items:center; gap:6px;">
                  <input type="color" id="car-edit-text-color-picker" value="#ffffff" style="width:40px; height:28px; padding:0; border:none; background:transparent;">
                  <input type="text" id="car-edit-text-color" placeholder="ej: #DDDDDD o orange">
                </div>
              </div>
            </div>
            <div class="edit-form-group">
              <label>Posición (Orden)</label>
              <input type="number" id="car-edit-position" value="0">
            </div>
        </div>
      </div>
      <div class="modal-footer" style="padding:16px 24px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
        <button class="cancel-btn" style="background:#f5f5f5; color:#333; box-shadow:none; border:1px solid #ddd;">Cancelar</button>
        <button class="save-btn" style="background:#4caf50;">Guardar</button>
      </div>
    </div>
  </div>

  <div id="orders-config-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
      <h3 style="margin-top:0;">Configuración de Pedidos</h3>
      
      <div style="margin-bottom:16px;">
        <div style="font-weight:bold; margin-bottom:8px;">Filtrar pedidos visibles:</div>
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
          <input type="checkbox" class="cfg-filter" value="mesa" checked> Mesa
        </label>
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
          <input type="checkbox" class="cfg-filter" value="espera" checked> Espera
        </label>
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
          <input type="checkbox" class="cfg-filter" value="direccion" checked> Domicilio / Dirección
        </label>
      </div>

      <div style="margin-bottom:16px; border-top:1px solid #eee; padding-top:12px;">
        <div style="font-weight:bold; margin-bottom:8px;">Costo de envío (Domicilio):</div>
        <input type="number" id="cfg-shipping-cost" placeholder="0" min="0" step="100" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
      </div>

      <div style="margin-bottom:16px; border-top:1px solid #eee; padding-top:12px;">
        <div style="font-weight:bold; margin-bottom:8px;">Tiempos estimados (minutos):</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px;">
          <div>
            <label style="font-size:12px; display:block; margin-bottom:2px;">Mesa</label>
            <input type="number" id="cfg-time-mesa" placeholder="0" min="0" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="font-size:12px; display:block; margin-bottom:2px;">Espera</label>
            <input type="number" id="cfg-time-espera" placeholder="0" min="0" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="font-size:12px; display:block; margin-bottom:2px;">Domicilio</label>
            <input type="number" id="cfg-time-delivery" placeholder="0" min="0" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
          </div>
        </div>
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="cfg-time-auto">
          <span style="font-size:14px;">Cálculo automático (basado en historial)</span>
        </label>
      </div>

      <div style="margin-bottom:16px; border-top:1px solid #eee; padding-top:12px;">
        <div style="font-weight:bold; margin-bottom:8px;">Configuración SLA (Alertas):</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label style="font-size:12px; display:block; margin-bottom:2px;">Advertencia (min)</label>
            <input type="number" id="sla-warning" placeholder="15" min="1" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="font-size:12px; display:block; margin-bottom:2px;">Crítico (min)</label>
            <input type="number" id="sla-critical" placeholder="30" min="2" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
          </div>
        </div>
      </div>

      <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" id="cfg-save-btn" style="padding:8px 16px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Guardar</button>
        <button type="button" id="cfg-close-btn" style="padding:8px 16px; background:#9e9e9e; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="whatsapp-config-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2001; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
      <h3 style="margin-top:0;">Configuración de WhatsApp</h3>
      
      <div style="margin-bottom:16px;">
        <div style="font-weight:bold; margin-bottom:8px;">WhatsApp Pedidos:</div>
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <input type="checkbox" id="cfg-whatsapp-enabled-modal" checked>
          <span style="font-size:14px;">Habilitar envío de pedido por WhatsApp</span>
        </label>
        <div style="margin-bottom:12px;">
           <label style="font-size:12px; display:block; margin-bottom:2px;">Número destino pedidos (con código país)</label>
           <input type="text" id="cfg-whatsapp-number-modal" placeholder="+54 9 261 000-0000" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
        </div>
        
        <div style="border-top:1px solid #eee; padding-top:12px;">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
             <label style="font-size:12px; font-weight:bold;">Plantilla de Mensaje</label>
             <button type="button" id="cfg-whatsapp-restore-btn" style="font-size:11px; padding:2px 6px; background:none; border:1px solid #ccc; border-radius:3px; cursor:pointer;">Restaurar ejemplo</button>
           </div>
           <textarea id="cfg-whatsapp-template-modal" rows="8" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; font-family:monospace; resize:vertical;"></textarea>
           <div style="font-size:10px; color:#666; margin-top:4px; line-height:1.4;">
             Variables disponibles:<br>
             <b>{PEDIDO_INFO}</b>: Tipo, mesa, dirección, cliente.<br>
             <b>{ITEMS}</b>: Lista de productos y precios.<br>
             <b>{TOTALES}</b>: Subtotal, envío, total.<br>
             <b>{NOTAS}</b>: Notas generales del pedido.
           </div>
        </div>
      </div>

      <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" id="cfg-whatsapp-save-btn" style="padding:8px 16px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Guardar</button>
        <button type="button" id="cfg-whatsapp-close-btn" style="padding:8px 16px; background:#9e9e9e; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="header-config-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
      <h3 style="margin-top:0;">Cabecera de Carta Online</h3>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; display:block; margin-bottom:4px;">WhatsApp (texto visible)</label>
        <input type="text" id="header-whatsapp" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="+54 9 261 000-0000">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; display:block; margin-bottom:4px;">Instagram</label>
        <input type="text" id="header-instagram" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="@usuario">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; display:block; margin-bottom:4px;">Título de ubicación</label>
        <input type="text" id="header-location-label" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Local 1">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:12px; display:block; margin-bottom:4px;">Enlace de mapa (URL)</label>
        <input type="text" id="header-location-url" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="https://maps.app.goo.gl/...">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:12px; display:block; margin-bottom:4px;">Logo (URL de imagen)</label>
        <input type="text" id="header-logo-url" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="https://...">
        <div style="margin-top:4px;">
            <button type="button" id="header-logo-upload-btn" style="padding:4px 8px; font-size:11px; cursor:pointer;">Subir imagen</button>
            <input type="file" id="header-logo-file" style="display:none;" accept="image/*">
        </div>
      </div>
      <div style="margin-bottom:16px; border-top:1px solid #eee; padding-top:12px;">
        <div id="header-hours-header" style="font-size:12px; font-weight:bold; margin-bottom:4px; cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
          <span>Horarios de apertura</span>
          <span id="header-hours-toggle-label" style="font-size:11px; color:#2196F3;">Mostrar</span>
        </div>
        <div id="header-hours-panel" style="display:none; margin-top:4px;">
          <table id="header-hours-table" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left; padding:4px 4px;">Día</th>
                <th style="text-align:left; padding:4px 4px;">Turno 1</th>
                <th style="text-align:left; padding:4px 4px;">Turno 2</th>
              </tr>
            </thead>
            <tbody>
              <tr data-day="mon">
                <td style="padding:4px 4px;">Lunes</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="tue">
                <td style="padding:4px 4px;">Martes</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="wed">
                <td style="padding:4px 4px;">Miércoles</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="thu">
                <td style="padding:4px 4px;">Jueves</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="fri">
                <td style="padding:4px 4px;">Viernes</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="sat">
                <td style="padding:4px 4px;">Sábado</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
              <tr data-day="sun">
                <td style="padding:4px 4px;">Domingo</td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start1" style="width:45%;"> a
                  <input type="time" class="h-end1" style="width:45%;">
                </td>
                <td style="padding:4px 4px;">
                  <input type="time" class="h-start2" style="width:45%;"> a
                  <input type="time" class="h-end2" style="width:45%;">
                </td>
              </tr>
            </tbody>
          </table>
          <div class="small" style="margin-top:6px; color:#666;">Se usa para mostrar solo “Abierto” o “Cerrado” en la cabecera.</div>
        </div>
      </div>
      <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" id="header-save-btn" style="padding:8px 16px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Guardar</button>
        <button type="button" id="header-close-btn" style="padding:8px 16px; background:#9e9e9e; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // --- Global Config & Helpers ---
    const API_BASE = (function(){
      const origin = window.location.origin || '';
      if (/^file:/i.test(origin)) return 'http://127.0.0.1:8000';
      return origin;
    })();

    const statusClasses = {
      pendiente: 'status-pendiente',
      preparacion: 'status-preparacion',
      listo: 'status-listo',
      en_camino: 'status-en_camino',
      entregado: 'status-entregado',
      cancelado: 'status-cancelado'
    };
    const statusOptions = Object.keys(statusClasses);
    
    // --- Product Edit Modal Logic ---
    const prodEditModal = document.getElementById('product-edit-modal');
    const prodEditId = document.getElementById('edit-prod-id');
    const prodEditName = document.getElementById('edit-prod-name');
    const prodEditDetails = document.getElementById('edit-prod-details');
    const prodEditImage = document.getElementById('edit-prod-image');
    const prodEditPrice = document.getElementById('edit-prod-price');
    const prodEditStock = document.getElementById('edit-prod-stock');
    const prodEditActive = document.getElementById('edit-prod-active');
    const prodEditLastMod = document.getElementById('edit-prod-last-mod');
    const prodEditFoodCats = document.getElementById('edit-prod-food-cats');
    const prodEditTriggerUpload = document.getElementById('edit-prod-trigger-upload');
    const prodEditFile = document.getElementById('edit-prod-file');
    const prodEditDeleteImgBtn = document.getElementById('edit-prod-delete-img-btn');
    
    // Preview Elements
    const prevTitle = document.getElementById('preview-title');
    const prevDesc = document.getElementById('preview-desc');
    const prevPrice = document.getElementById('preview-price');
    const prevImage = document.querySelector('.preview-image-placeholder');

    let currentEditingProduct = null;

    function openProductEditModal(product) {
      if (!prodEditModal) return;
      currentEditingProduct = product;

      // Populate Form
      prodEditId.value = product.id;
      prodEditName.value = product.name;
      prodEditDetails.value = product.details || '';
      prodEditImage.value = product.image_url || '';
      prodEditPrice.value = product.price;
      prodEditStock.value = product.stock;
      prodEditActive.checked = !!product.active;
      prodEditLastMod.textContent = product.last_modified ? 'Última modificación: ' + formatARDate(product.last_modified) : 'Sin modificaciones recientes';

      // Preseleccionar categorías de filtro desde variants_json
      let existingCats = [];
      if (prodEditFoodCats) {
        try {
          let v = {};
          if (product.variants) {
            if (typeof product.variants === 'string') {
              v = JSON.parse(product.variants || '{}') || {};
            } else {
              v = product.variants || {};
            }
          }
          const fc = v.food_categories;
          if (Array.isArray(fc)) {
            existingCats = fc;
          } else if (typeof fc === 'string' && fc.trim()) {
            existingCats = fc.split(',').map(c => c.trim());
          }
        } catch (e) {
          existingCats = [];
        }
        Array.from(prodEditFoodCats.options || []).forEach(opt => {
          opt.selected = existingCats.includes(opt.value);
        });
      }

      // Update Preview
      updatePreview();

      // Show Modal
      prodEditModal.style.display = 'block';
      prodEditModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeProductEditModal() {
      if (!prodEditModal) return;
      prodEditModal.style.display = 'none';
      prodEditModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = 'auto';
      currentEditingProduct = null;
    }

    function updatePreview() {
      if (prevTitle) prevTitle.textContent = prodEditName.value || 'Sin nombre';
      if (prevDesc) prevDesc.textContent = prodEditDetails.value || 'Sin descripción';
      if (prevPrice) prevPrice.textContent = '$' + new Intl.NumberFormat('es-AR').format(parseInt(prodEditPrice.value || '0', 10) || 0) + ' ARS';
      
      if (prevImage) {
          const imgUrl = prodEditImage.value.trim();
          if (imgUrl) {
              prevImage.style.backgroundImage = `url('${imgUrl}')`;
          } else {
              prevImage.style.backgroundImage = "url('https://images.unsplash.com/photo-1513104890138-7c749659a591?auto=format&fit=crop&w=600&q=80')";
          }
      }
    }

    // Live Preview Listeners
    if (prodEditName) prodEditName.addEventListener('input', updatePreview);
    if (prodEditDetails) prodEditDetails.addEventListener('input', updatePreview);
    if (prodEditPrice) prodEditPrice.addEventListener('input', updatePreview);
    if (prodEditImage) prodEditImage.addEventListener('input', updatePreview);

    // Image Upload & Delete Handlers
    if (prodEditTriggerUpload && prodEditFile) {
        prodEditTriggerUpload.addEventListener('click', () => {
            prodEditFile.click();
        });

        prodEditFile.addEventListener('change', async () => {
            if (prodEditFile.files && prodEditFile.files[0]) {
                const file = prodEditFile.files[0];
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const baseSlug = tenantInput.value.trim() || defaultSlug();
                    const slug = (currentTenantSlug && currentTenantSlug.trim()) || baseSlug;
                    // Ensure csrfToken is available
                    if (!csrfToken) await fetchCSRF();

                    const url = new URL('/api/upload', API_BASE);
                    url.searchParams.set('tenant_slug', slug); 

                    const resp = await fetch(url.toString(), {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (resp.ok) {
                        const data = await resp.json();
                        const newPath = data.url; // Relative path returned by backend
                        
                        // Check if we should delete the old image (only if it was a local upload and different)
                        const oldPath = prodEditImage.value.trim();
                        if (oldPath && oldPath !== newPath && oldPath.replace(/\\/g, '/').startsWith('Imagenes/uploads/')) {
                             // Call delete endpoint silently
                             try {
                                 const delUrl = new URL('/api/delete_file', API_BASE);
                                 await fetch(delUrl.toString(), {
                                     method: 'DELETE',
                                     headers: {
                                         'Content-Type': 'application/json',
                                         'X-CSRF-Token': csrfToken
                                     },
                                     body: JSON.stringify({ path: oldPath })
                                 });
                             } catch (e) {
                                 console.warn('Failed to delete old image:', e);
                             }
                        }

                        prodEditImage.value = newPath;
                        updatePreview();
                        
                        // Show delete button for the new image
                        if (prodEditDeleteImgBtn) prodEditDeleteImgBtn.style.display = 'inline-block';
                        
                    } else {
                        alert('Error al subir imagen');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error de conexión al subir imagen');
                }
                
                // Reset file input
                prodEditFile.value = '';
            }
        });
    }

    if (prodEditDeleteImgBtn) {
        prodEditDeleteImgBtn.addEventListener('click', async () => {
            if (!confirm('¿Estás seguro de que deseas eliminar la imagen actual del servidor?')) return;
            
            const path = prodEditImage.value.trim();
            if (!path) return;
            
            try {
                 if (!csrfToken) await fetchCSRF();
                 const delUrl = new URL('/api/delete_file', API_BASE);
                 const resp = await fetch(delUrl.toString(), {
                     method: 'DELETE',
                     headers: {
                         'Content-Type': 'application/json',
                         'X-CSRF-Token': csrfToken
                     },
                     body: JSON.stringify({ path: path })
                 });
                 
                 if (resp.ok) {
                     prodEditImage.value = '';
                     updatePreview();
                     prodEditDeleteImgBtn.style.display = 'none';
                     alert('Imagen eliminada correctamente');
                 } else {
                     const err = await resp.json();
                     alert('Error al eliminar: ' + (err.error || 'Error desconocido'));
                 }
            } catch (e) {
                console.error(e);
                alert('Error de conexión al eliminar imagen');
            }
        });
    }

    // Modal Actions
    if (prodEditModal) {
      const closeBtn = prodEditModal.querySelector('.close-modal');
      const cancelBtn = prodEditModal.querySelector('.cancel-btn');
      const saveBtn = prodEditModal.querySelector('.save-btn');
      const overlay = prodEditModal.querySelector('.kds-modal-overlay');

      const close = () => closeProductEditModal();
      if (closeBtn) closeBtn.addEventListener('click', close);
      if (cancelBtn) cancelBtn.addEventListener('click', close);
      if (overlay) overlay.addEventListener('click', close);

      if (saveBtn) saveBtn.addEventListener('click', async () => {
        if (!currentEditingProduct) return;
        if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
        
        try {
            if (!csrfToken) {
                await fetchCSRF();
            }
            const baseSlug = tenantInput.value.trim() || defaultSlug();
            const slug = (currentTenantSlug && currentTenantSlug.trim()) || baseSlug;
            const url = new URL(`/api/products/${currentEditingProduct.id}`, API_BASE);
            url.searchParams.set('tenant_slug', slug);

            const payload = {
                name: prodEditName.value.trim(),
                details: prodEditDetails.value.trim(),
                image_url: prodEditImage.value.trim(),
                price: parseInt(prodEditPrice.value || '0', 10) || 0,
                stock: parseInt(prodEditStock.value || '0', 10),
                active: prodEditActive.checked
            };

            // Construir objeto variants para guardar sección y categorías
            let variants = {};
            try {
                if (currentEditingProduct.variants) {
                    if (typeof currentEditingProduct.variants === 'string') {
                        variants = JSON.parse(currentEditingProduct.variants || '{}') || {};
                    } else {
                        variants = currentEditingProduct.variants || {};
                    }
                }
            } catch (e) {
                variants = {};
            }

            // Recolectar categorías seleccionadas
            let selectedCats = [];
            if (prodEditFoodCats) {
                const opts = prodEditFoodCats.options || [];
                for (let i = 0; i < opts.length; i++) {
                    if (opts[i].selected) {
                        selectedCats.push(opts[i].value);
                    }
                }
            }

            if (selectedCats.length > 0) {
                variants.food_categories = selectedCats;
            } else {
                // Si el usuario desmarca todo, quitamos el campo para no forzar filtros
                if (variants && typeof variants === 'object' && 'food_categories' in variants) {
                    delete variants.food_categories;
                }
            }

            if (Object.keys(variants).length > 0) {
                payload.variants = variants;
            }

            const resp = await wFetch(url.toString(), {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert('Producto actualizado exitosamente');
                closeProductEditModal();
                await renderInventory();
            } else {
                const err = await resp.json();
                alert('Error al actualizar: ' + (err.error || 'Error desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexión al actualizar producto');
        }
      });
    }

    // Firma de la última renderización para evitar parpadeos por re-render innecesario
    let lastOrdersSignature = '';
    let lastActiveIds = new Set();
    let firstOrderLoad = true;
    let audioCtx;
    const SOUND_PREF_KEY = 'sound_enabled';
    let soundEnabled = true;
    try { const sraw = localStorage.getItem(SOUND_PREF_KEY); if (sraw === '0') soundEnabled = false; } catch (_) {}
    
    // Unlock AudioContext on first interaction
    document.addEventListener('click', async () => {
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        } catch (_) {}
    }, { once: true });

    const slaStateMap = new Map();
    async function playNewOrderSound() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        const g = audioCtx.createGain();
        const t0 = audioCtx.currentTime;
        const o1 = audioCtx.createOscillator();
        const o2 = audioCtx.createOscillator();
        o1.type = 'square';
        o2.type = 'square';
        o1.frequency.setValueAtTime(880, t0);
        o1.frequency.setValueAtTime(660, t0 + 0.7);
        o2.frequency.setValueAtTime(1320, t0);
        o2.frequency.setValueAtTime(990, t0 + 0.7);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.28, t0 + 0.05);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.5);
        o1.connect(g);
        o2.connect(g);
        g.connect(audioCtx.destination);
        o1.start(t0);
        o2.start(t0);
        o1.stop(t0 + 1.5);
        o2.stop(t0 + 1.5);
      } catch (_) {}
    }
    async function playSlaWarningSound() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        const g = audioCtx.createGain();
        const t0 = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(740, t0);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.04);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.9);
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start(t0);
        o.stop(t0 + 0.9);
      } catch (_) {}
    }
    async function playSlaCriticalSound() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        const g = audioCtx.createGain();
        const t0 = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        o.type = 'square';
        o.frequency.setValueAtTime(520, t0);
        o.frequency.setValueAtTime(440, t0 + 0.5);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.3, t0 + 0.05);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.4);
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start(t0);
        o.stop(t0 + 1.4);
      } catch (_) {}
    }

    const tenantInput = document.getElementById('tenant-input');
    // const filterSelect = document.getElementById('status-filter');

    const soundToggle = document.getElementById('sound-toggle');
    const dailyEyeBtn = document.getElementById('daily-eye');
    const cashEyeTop = document.getElementById('cash-eye-top');
    const historyEyeTop = document.getElementById('history-eye-top');
    const cashStatusLabel = document.getElementById('cash-status-label');
    const metricsBoxEl = document.getElementById('metrics');
    const cashBoxEl = document.getElementById('cash-box');
    const cashHistoryEl = document.getElementById('cash-history');
    const DAILY_VISIBLE_KEY = 'daily_visible';
    let dailyVisible = true;
    try { const v = localStorage.getItem(DAILY_VISIBLE_KEY); if (v === '0') dailyVisible = false; } catch (_) {}
    function setDailyVisible(v){
      dailyVisible = !!v;
      if (metricsBoxEl) metricsBoxEl.style.display = dailyVisible ? '' : 'none';
      if (cashBoxEl) cashBoxEl.style.display = dailyVisible ? '' : 'none';
      if (cashHistoryEl) cashHistoryEl.style.display = dailyVisible ? '' : 'none';
      try { localStorage.setItem(DAILY_VISIBLE_KEY, dailyVisible ? '1' : '0'); } catch (_) {}
      updateEyeIcon();
    }
    function eyeSvg(show){
      return show
        ? '<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>'
        : '<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2.1 3.51 1 4.6l4.11 4.11C3.33 9.87 1.86 11.74 1 12c1.73 4.39 6 7.5 11 7.5 2.11 0 4.08-.51 5.82-1.41l3.58 3.58 1.11-1.09L2.1 3.51zM12 6.5c1.41 0 2.67.58 3.57 1.5l-1.06 1.06a3 3 0 0 0-4.1 4.1L9.35 14.2A5 5 0 0 1 12 6.5zm0 10.5a9.31 9.31 0 0 1-6.63-2.72c-.54-.54-.99-1.1-1.37-1.66l3.17-3.17 1.55 1.55a5 5 0 0 0 6.08 6.08l1.55 1.55A10.97 10.97 0 0 1 12 17z"/></svg>';
    }
    function updateEyeIcon(){
      if (dailyEyeBtn) {
        dailyEyeBtn.setAttribute('aria-label', dailyVisible ? 'Ocultar movimientos' : 'Mostrar movimientos');
        dailyEyeBtn.innerHTML = eyeSvg(dailyVisible);
      }
      if (cashEyeTop && (typeof cashCollapsed !== 'undefined')) {
        cashEyeTop.setAttribute('aria-label', cashCollapsed ? 'Mostrar caja' : 'Ocultar caja');
        cashEyeTop.innerHTML = eyeSvg(!cashCollapsed);
      }
      if (historyEyeTop && (typeof cashHistoryCollapsed !== 'undefined')) {
        historyEyeTop.setAttribute('aria-label', cashHistoryCollapsed ? 'Mostrar historial' : 'Ocultar historial');
        historyEyeTop.innerHTML = eyeSvg(!cashHistoryCollapsed);
      }
    }
    if (dailyEyeBtn) { dailyEyeBtn.addEventListener('click', () => setDailyVisible(!dailyVisible)); }
    if (cashEyeTop) cashEyeTop.addEventListener('click', async () => {
      cashCollapsed = !cashCollapsed;
      const btn = document.getElementById('toggle-cash');
      const box = document.getElementById('cash-box');
      if (btn) btn.textContent = cashCollapsed ? 'Mostrar Caja' : 'Ocultar Caja';
      if (box) box.style.display = cashCollapsed ? 'none' : 'grid';
      if (!cashCollapsed) await renderCashBox();
      updateEyeIcon();
    });
    if (historyEyeTop) historyEyeTop.addEventListener('click', async () => {
      cashHistoryCollapsed = !cashHistoryCollapsed;
      const btn = document.getElementById('toggle-cash-history');
      const box = document.getElementById('cash-history');
      if (btn) btn.textContent = cashHistoryCollapsed ? 'Mostrar Historial' : 'Ocultar Historial';
      if (box) box.style.display = cashHistoryCollapsed ? 'none' : 'block';
      if (!cashHistoryCollapsed) await renderCashHistory();
      updateEyeIcon();
    });
    const tbody = document.getElementById('orders-tbody');
    const countEl = document.getElementById('orders-count');
    const detailEl = document.getElementById('order-detail');
    if (soundToggle) {
      try { soundToggle.checked = !!soundEnabled; } catch (_) {}
      soundToggle.addEventListener('change', () => {
        soundEnabled = !!soundToggle.checked;
        try { localStorage.setItem(SOUND_PREF_KEY, soundEnabled ? '1' : '0'); } catch (_) {}
      });
    }

    const archSearchInput = document.getElementById('arch-search');
    const archFromInput = document.getElementById('arch-from');
    const archToInput = document.getElementById('arch-to');
    const archOrderTypeSelect = document.getElementById('arch-order-type');
    const archFilterBtn = document.getElementById('arch-filter-btn');
    const archExportBtn = document.getElementById('arch-export-btn');
    const archDateModeSelect = document.getElementById('arch-date-mode');
    const archivedMetricsEl = document.getElementById('archived-metrics');
    const archPageSizeSelect = document.getElementById('arch-page-size');
    const slaWarnInput = document.getElementById('sla-warning');
    const slaCritInput = document.getElementById('sla-critical');
    const slaSaveBtn = document.getElementById('sla-save');
    const controlsEl = document.querySelector('.controls');
    const detailsEls = Array.from(document.querySelectorAll('.controls details.mobile-filters'));
    function updateControlsWrap(){
      try {
        const anyOpen = detailsEls.some(d => d && d.open);
        if (anyOpen) controlsEl.classList.add('two-lines'); else controlsEl.classList.remove('two-lines');
      } catch (_) {}
    }
    detailsEls.forEach(d => { try { d.addEventListener('toggle', updateControlsWrap); } catch (_) {} });
    updateControlsWrap();
    const archPrevBtn = document.getElementById('arch-prev');
    const archNextBtn = document.getElementById('arch-next');
    const archReloadBtn = document.getElementById('arch-reload');
    const archPageInfoEl = document.getElementById('arch-page-info');
    const delPageSizeSelect = document.getElementById('del-page-size');
    const delPrevBtn = document.getElementById('del-prev');
    const delNextBtn = document.getElementById('del-next');
    const delPageInfoEl = document.getElementById('del-page-info');
    const canPageSizeSelect = document.getElementById('can-page-size');
    const canPrevBtn = document.getElementById('can-prev');
    const canNextBtn = document.getElementById('can-next');
    const canPageInfoEl = document.getElementById('can-page-info');
    const invReloadBtn = document.getElementById('inv-reload');
    const invTbody = document.getElementById('inventory-tbody');
    const closeDeliveredBtn = document.getElementById('close-delivered-box');
    const closeCanceledBtn = document.getElementById('close-canceled-box');
    const closeInventoryBtn = document.getElementById('close-inventory-box');
    const closeArchivedBtn = document.getElementById('close-archived-box');
    if (closeDeliveredBtn) {
      closeDeliveredBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const box = document.getElementById('delivered-box');
        if (box) box.open = false;
      });
    }
    if (closeCanceledBtn) {
      closeCanceledBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const box = document.getElementById('canceled-box');
        if (box) box.open = false;
      });
    }
    if (closeInventoryBtn) {
      closeInventoryBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const box = document.getElementById('inventory-box');
        if (box) box.open = false;
      });
    }
    if (closeArchivedBtn) {
      closeArchivedBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const box = document.getElementById('archived-box');
        if (box) box.open = false;
      });
    }
    let archLimit = 50;
    let archOffset = 0;
    let deliveredLimit = 50;
    let deliveredOffset = 0;
    let canceledLimit = 50;
    let canceledOffset = 0;
    (function(){
      const today = (new Date()).toISOString().slice(0,10);
      const y = new Date(); y.setDate(y.getDate()-1);
      const yesterday = y.toISOString().slice(0,10);
      if (archFromInput && !archFromInput.value) archFromInput.value = yesterday;
      if (archToInput && !archToInput.value) archToInput.value = today;
      window.archivedFrom = archFromInput ? archFromInput.value : '';
      window.archivedTo = archToInput ? archToInput.value : '';
      window.archivedSearch = '';
    })();
    [archSearchInput, archFromInput, archToInput].forEach(el => {
      if (el) el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && archFilterBtn) archFilterBtn.click();
      });
    });
    
    function wFetch(url, opts){ const o = opts || {}; o.credentials = 'include'; return fetch(url, o); }
    let csrfToken = '';
    let isAuthed = false;
    let currentTenantSlug = '';
    let currentUserName = '';
    const LOGIN_KEY_USER = 'kds_login_user';
    const LOGIN_KEY_PASS = 'kds_login_pass';
    const LOGIN_KEY_REM = 'kds_login_rem';
    let currentSlaThresholds = { warning: 15, critical: 30 };
    let currentTipPercent = 10;
    let currentTipDefaultEnabled = true;
    let currentTicketFormat = 'full';
    let currentOffset = 0;
    let currentLimit = 50;
    let currentSearch = '';
    let currentFrom = '';
    let currentTo = '';
    let metricsFrom = '';
    let metricsTo = '';
    let slaTimer = null;
    let isLoading = false;
    let cashCollapsed = true;
    let cashOpenDraft = { amount: 0, notes: '' };
    let cashCloseDraft = { amount: undefined, notes: '' };
    let isCashEditing = false;
    let cashKeepModalOpen = false;
    const DAILY_RESET_HOUR = 5;
    let dailyResetFrom = '';
    let dailyResetOverride = false;
    let cashHistoryCollapsed = true;
    try { setDailyVisible(dailyVisible); } catch (_) {}
    const logoutBtn = document.getElementById('logout-btn');
    const loginOpenBtn = document.getElementById('login-open-btn');
    const authBadge = document.getElementById('auth-status-badge');
    const loginBox = document.getElementById('login-box');
    const loginUserEl = document.getElementById('login-user');
    const loginPassEl = document.getElementById('login-pass');
    const loginRemEl = document.getElementById('login-remember');
    const loginShowEl = document.getElementById('login-show');
    const _rem = (localStorage.getItem(LOGIN_KEY_REM) === '1');
    if (loginRemEl) loginRemEl.checked = _rem;
    const _lu = localStorage.getItem(LOGIN_KEY_USER) || '';
    const _lp = _rem ? (localStorage.getItem(LOGIN_KEY_PASS) || '') : '';
    if (loginUserEl) loginUserEl.value = _lu;
    if (loginPassEl) loginPassEl.value = _lp;
    if (loginShowEl && loginPassEl) loginShowEl.onchange = function(){ loginPassEl.type = loginShowEl.checked ? 'text' : 'password'; };
    function setAuthUI(){
      if (authBadge) {
        authBadge.classList.remove('on','off');
        authBadge.classList.add(isAuthed ? 'on' : 'off');
        authBadge.textContent = isAuthed ? (`${currentUserName || 'Usuario'} activo`) : 'Sin sesión';
      }
      if (logoutBtn) logoutBtn.disabled = !isAuthed;
      if (loginOpenBtn) loginOpenBtn.style.display = isAuthed ? 'none' : '';
      if (loginBox) loginBox.style.display = isAuthed ? 'none' : 'block';
      document.body.classList.toggle('no-auth', !isAuthed);
      if (tenantInput) {
        tenantInput.disabled = !!isAuthed;
      }
    }

    setAuthUI();

    function computeDailyResetUTC() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = now.getDate();
      const h = now.getHours();
      let baseLocal = new Date(y, m, d, DAILY_RESET_HOUR, 0, 0);
      if (h < DAILY_RESET_HOUR) baseLocal = new Date(y, m, d - 1, DAILY_RESET_HOUR, 0, 0);
      const yyyy = baseLocal.getUTCFullYear();
      const mm = String(baseLocal.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(baseLocal.getUTCDate()).padStart(2, '0');
      const HH = String(baseLocal.getUTCHours()).padStart(2, '0');
      const MM = String(baseLocal.getUTCMinutes()).padStart(2, '0');
      const SS = String(baseLocal.getUTCSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}`;
    }
    function applyDailyReset(fromIso) {
      dailyResetFrom = fromIso;
      currentFrom = fromIso;
      currentTo = '';
    }
    async function fetchArchived(type) {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/archive', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      url.searchParams.set('type', type);
      if (window.archivedSearch) url.searchParams.set('q', window.archivedSearch);
      if (window.archivedFrom) url.searchParams.set('from', window.archivedFrom);
      if (window.archivedTo) url.searchParams.set('to', window.archivedTo);
      if (window.archOrderType) url.searchParams.set('order_type', window.archOrderType);
      if (window.archDateMode) url.searchParams.set('date_field', window.archDateMode);
      url.searchParams.set('limit', String(archLimit));
      url.searchParams.set('offset', String(archOffset));
      const resp = await wFetch(url.toString());
      if (!resp.ok) throw new Error('Error al obtener archivados');
      const data = await resp.json();
      return Array.isArray(data.archives) ? data.archives : [];
    }
    async function archiveSnapshot(order, type) {
      const resp = await fetch(new URL('/api/archive', API_BASE).toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ order_id: order.id, type })
      });
      if (!resp.ok) throw new Error('Error al archivar');
      return resp.json();
    }

    function defaultSlug() {
      const dataSlug = (document.body && document.body.dataset && document.body.dataset.tenant) ? document.body.dataset.tenant.trim() : '';
      if (dataSlug) return dataSlug;
      try {
        const name = (window.location.pathname.split('/').pop() || '').replace(/\.html$/,'');
        if (name && name !== 'admin') return name;
      } catch (_) {}
      try {
        const last = localStorage.getItem('tenant_last_selected') || '';
        if (last) return last;
      } catch (_) {}
      return 'gastronomia-local1';
    }
    // Preferencia de propina (10%) por tenant
    function tipKey(name) {
      const slug = tenantInput.value.trim() || defaultSlug();
      return `tip_${name}:${slug}`;
    }
    function getTipPrefMap() {
      try { return JSON.parse(localStorage.getItem(tipKey('pref')) || '{}'); } catch (_) { return {}; }
    }
    function setTipPrefMap(map) {
      try { localStorage.setItem(tipKey('pref'), JSON.stringify(map)); } catch (_) {}
    }
    function getTipPref(orderId) {
      const map = getTipPrefMap();
      return Boolean(map[String(orderId)]);
    }
    function hasTipPref(orderId) {
      const map = getTipPrefMap();
      return Object.prototype.hasOwnProperty.call(map, String(orderId));
    }
    function setTipPref(orderId, enabled) {
      const map = getTipPrefMap();
      map[String(orderId)] = !!enabled;
      setTipPrefMap(map);
    }
    function computeTipAmount(total) {
      const t = Number(total || 0);
      return Math.max(0, Math.round(t * (currentTipPercent/100)));
    }
    function formatMoney(n) {
      const v = Number(n || 0);
      try {
        return `$${v.toLocaleString('es-AR')}`;
      } catch (_) {
        return `$${v}`;
      }
    }
    // Functions getAddressText, destinoLabelFor, getWaLink moved to js/admin-wa-helper.js

    function numberToWordsEs(n) {
      n = Math.floor(Math.abs(Number(n || 0)));
      if (n === 0) return 'cero';
      function u(n){ return ['','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'][n]; }
      function t(n){
        if (n < 10) return u(n);
        if (n < 16) return ['diez','once','doce','trece','catorce','quince'][n-10];
        if (n < 20) return 'dieci' + u(n-10);
        if (n === 20) return 'veinte';
        if (n < 30) return 'veinti' + u(n-20);
        const tens = ['','','veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
        const d = Math.floor(n/10), r = n%10;
        return tens[d] + (r ? ' y ' + u(r) : '');
      }
      function h(n){
        if (n === 100) return 'cien';
        const hundreds = ['','','doscientos','trescientos','cuatrocientos','quinientos','seiscientos','setecientos','ochocientos','novecientos'];
        const d = Math.floor(n/100), r = n%100;
        if (d === 0) return t(r);
        if (d === 1) return 'ciento' + (r ? ' ' + t(r) : '');
        return hundreds[d] + (r ? ' ' + t(r) : '');
      }
      function chunk(n){
        if (n < 100) return t(n);
        return h(n);
      }
      let out = '';
      const millones = Math.floor(n / 1000000);
      const miles = Math.floor((n % 1000000) / 1000);
      const resto = n % 1000;
      if (millones) out += (millones === 1 ? 'un millón' : chunk(millones) + ' millones');
      if (miles) out += (out ? ' ' : '') + (miles === 1 ? 'mil' : chunk(miles) + ' mil');
      if (resto) out += (out ? ' ' : '') + chunk(resto);
      return out;
    }
    // Prefill del establecimiento si no hay valor
    if (!document.getElementById('tenant-input').value) {
      document.getElementById('tenant-input').value = defaultSlug();
    }

    async function fetchOrders() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const status = ''; // filterSelect.value.trim();
      const url = new URL('/api/orders', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      // Handle numeric ID search
      let searchTerm = currentSearch;
      const isIdSearch = searchTerm && /^\d+$/.test(searchTerm.trim());

      // Excluir archivados para que la lista principal muestre solo pedidos actuales (salvo búsqueda por ID)
      if (!isIdSearch) {
        url.searchParams.set('exclude_archived', 'true');
      }
      
      if (isIdSearch) {
         url.searchParams.set('id', searchTerm.trim());
         // Also clear 'q' to avoid conflict if API prioritizes ID
         // But keeping 'q' is fine if backend handles precedence.
         // Let's rely on 'q' if backend supports ID search via 'q' OR explicit 'id' param.
         // If backend only supports 'q' for text, we might need to adjust backend or here.
         // Assuming backend 'q' searches multiple fields including ID.
      }
      
      if (status) url.searchParams.set('status', status);
      url.searchParams.set('limit', currentLimit);
      url.searchParams.set('offset', currentOffset);
      if (currentSearch) url.searchParams.set('q', currentSearch);
      if (currentFrom) url.searchParams.set('from', currentFrom);
      if (currentTo) url.searchParams.set('to', currentTo);
      const resp = await wFetch(url.toString());
      if (!resp.ok) throw new Error('Error al obtener pedidos');
      return resp.json();
    }

    async function updateStatus(orderId, status, reason) {
      if (!CSRF_TOKEN || CSRF_TOKEN === '') {
          try { await fetchCsrfToken(); } catch(e) { console.error(e); }
      }
      const headers = { 'Content-Type': 'application/json' };
      if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

      const url = new URL(`/api/orders/${orderId}/status`, API_BASE).toString();
      let resp = await fetch(url, {
        method: 'PATCH',
        headers: headers,
        body: JSON.stringify({ status, reason }),
        credentials: 'include'
      });

      if (resp.status === 403) {
          await fetchCsrfToken();
          if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
          resp = await fetch(url, {
            method: 'PATCH',
            headers: headers,
            body: JSON.stringify({ status, reason }),
            credentials: 'include'
          });
      }

      if (!resp.ok) throw new Error('Error al actualizar estado');

      // Sync with Table Management
      if (status === 'preparacion') {
          try {
             // Refresh currentOrders from API if needed or rely on window.currentOrders
             // Best effort: look in currentOrders
             let orders = window.currentOrders || [];
             let order = orders.find(o => o.id == orderId);
             
             // If not found (maybe paginated?), try to use what we have or fetch?
             // Fetching single order to be sure
             if (!order) {
                 try {
                    const r = await fetch(new URL(`/api/orders?id=${orderId}`, API_BASE).toString());
                    if (r.ok) {
                        const detail = await r.json();
                        if (detail && detail.orders && detail.orders.length > 0) order = detail.orders[0];
                    }
                 } catch(_) {}
             }

             if (order && (String(order.order_type||'').toLowerCase() === 'mesa') && order.table_number) {
                 const slug = order.tenant_slug || (document.getElementById('tenant-input')?.value || 'gastronomia-local1');
                 let stored = localStorage.getItem('kds_tables_' + slug);
                 if (!stored) stored = localStorage.getItem('kds_tables');

                 if (stored) {
                     const data = JSON.parse(stored);
                     let found = false;
                     if (data.zones) {
                         const targetNum = String(order.table_number).trim().toLowerCase();
                         data.zones.forEach(z => {
                             // Try flexible matching
                             const t = z.tables.find(tbl => {
                                 const lbl = String(tbl.label || '').trim().toLowerCase();
                                 // Exact match
                                 if (lbl === targetNum) return true;
                                 // "Mesa 2" vs "2"
                                 if (lbl === `mesa ${targetNum}` || lbl === `mesa ${targetNum}`) return true;
                                 if (targetNum === `mesa ${lbl}`) return true;
                                 // "02" vs "2"
                                 if (parseInt(lbl) === parseInt(targetNum)) return true;
                                 return false;
                             });
                             
                             if (t) {
                                 t.status = 'occupied';
                                 found = true;
                             }
                         });
                     }
                     if (found) {
                         localStorage.setItem('kds_tables_' + slug, JSON.stringify(data));
                         window.dispatchEvent(new Event('kds-tables-changed'));
                         try { if (typeof renderTables === 'function') renderTables(); } catch (_) {}
                     }
                 }
             }
          } catch(e) { console.error('Error auto-updating table status', e); }
      }

      return resp.json();
    }

    async function payOrder(orderId, paymentData) {
      const payload = {
          payment_method: paymentData.method,
          tip_amount: paymentData.tip_amount || 0,
          final_total: paymentData.final_total,
          details: paymentData.details
      };
      
      if (!CSRF_TOKEN || CSRF_TOKEN === '') {
          try { await fetchCsrfToken(); } catch(e) { console.error(e); }
      }
      const headers = { 'Content-Type': 'application/json' };
      if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

      const url = new URL(`/api/orders/${orderId}/pay`, API_BASE).toString();
      let resp = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload),
        credentials: 'include'
      });

      if (resp.status === 403) {
          await fetchCsrfToken();
          if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
          resp = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'
          });
      }

      if (!resp.ok) {
        const err = await resp.json().catch(()=>({}));
        throw new Error(err.error || 'Error al registrar pago');
      }
      return resp.json();
    }

    async function fetchTenants() {
      const url = new URL('/api/tenants', API_BASE);
      const resp = await wFetch(url.toString());
      if (!resp.ok) return [];
      const data = await resp.json();
      return Array.isArray(data.tenants) ? data.tenants : [];
    }
    async function populateTenantsList() {
      try {
        const list = await fetchTenants();
        const dl = document.getElementById('tenants-list');
        dl.innerHTML = '';
        for (const t of list) {
          const opt = document.createElement('option');
          opt.value = t.slug;
          dl.appendChild(opt);
        }
      } catch (_) {}
    }

    async function loadTenantPrefs() {
      try {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/tenant_prefs', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        const resp = await fetch(url.toString());
        if (!resp.ok) return;
        const p = await resp.json();
        currentTipPercent = Math.max(0, Math.min(100, Number(p.tip_percent || 10)));
        currentTipDefaultEnabled = !!p.tip_default_enabled;
        currentTicketFormat = (p.ticket_format === 'compact') ? 'compact' : 'full';
      } catch (_) {}
    }

    async function fetchOrderDetail(orderId) {
      const url = new URL(`/api/orders/${orderId}`, API_BASE);
      url.searchParams.append('_', Date.now()); // Cache busting
      const resp = await wFetch(url.toString());
      if (!resp.ok) throw new Error('Error al obtener detalle');
      return resp.json();
    }

    // --- REFACTORED: renderOrderDetailContent (Separated Logic) ---
    function renderOrderDetailContent(detail) {
        const order = detail.order;
        const items = detail.items || [];
        const history = detail.history || [];
        const events = detail.events || [];
        
        const combinedHistory = [];
        history.forEach(h => {
            combinedHistory.push({
                label: h.status,
                date: h.changed_at,
                actor: h.changed_by,
                type: 'status'
            });
        });
        events.forEach(e => {
            let label = e.event_type;
            if (e.event_type === 'payment') {
                try {
                    const payload = JSON.parse(e.payload_json);
                    const methodMap = { 'contado': 'Efectivo', 'pos': 'POS/QR', 'transferencia': 'Transferencia' };
                    let method = methodMap[payload.method] || payload.method;
                    const totalAmt = payload.amount || 0;
                    const tipAmt = payload.tip || 0;
                    const finalTotal = totalAmt + tipAmt;
                    
                    if (payload.method === 'mixed' && Array.isArray(payload.details)) {
                        const dets = payload.details.map(d => `${methodMap[d.method]||d.method}: ${formatMoney(d.amount)}`).join(', ');
                        label = `Pago Mixto (${dets}) - Total: ${formatMoney(finalTotal)}`;
                    } else {
                        label = `Pago registrado (${method}) - Total: ${formatMoney(finalTotal)}`;
                    }
                } catch (_) {
                    label = 'Pago registrado';
                }
                combinedHistory.push({
                    label: label,
                    date: e.created_at,
                    actor: e.actor,
                    type: 'event'
                });
            }
        });
        combinedHistory.sort((a, b) => new Date(a.date) - new Date(b.date));

        const destino = destinoLabelFor(order);
        const telefono = ((order.order_type === 'direccion' || order.order_type === 'espera') && order.customer_phone) ? String(order.customer_phone) : '';
        const box = document.createElement('div');
        const itemsRows = items.map(it => {
          const qty = Number(it.qty || 0);
          const unit = Number(it.unit_price || 0);
          const subtotal = qty * unit;
          const notes = (it.notes && it.notes !== 'null' && it.notes !== 'undefined') ? String(it.notes) : '';
          
          // Logic to detect new items
          const isNew = it.created_at && order.created_at && (new Date(it.created_at).getTime() > new Date(order.created_at).getTime() + 60000);
          const newBadge = isNew ? '<span style="background:#4caf50; color:white; padding:2px 6px; border-radius:4px; font-size:0.75em; margin-left:5px;">NUEVO</span>' : '';
          const rowStyle = isNew ? 'style="background-color: #f0fdf4;"' : '';

          return `<tr ${rowStyle}><td>${qty}</td><td>${it.name}${newBadge}</td><td>$${unit}</td><td>$${subtotal}</td></tr>${notes ? `<tr><td colspan=4 class="small" style="color:#e65100; font-style:italic;">Nota: ${notes}</td></tr>` : ''}`;
        }).join('');
        const itemsHtml = items.length ? `
          <h3>Ítems</h3>
          <table class="detail-items-table">
            <thead><tr><th>Cant.</th><th>Producto</th><th>Unitario</th><th>Subtotal</th></tr></thead>
            <tbody>${itemsRows}</tbody>
          </table>
          <div class="detail-summary" style="text-align:right; margin-top:10px;">
             ${(order.shipping_cost && order.shipping_cost > 0) ? `<div class="small">Subtotal: $${order.total - order.shipping_cost}</div><div class="small">Envío: $${order.shipping_cost}</div>` : ''}
             <div style="font-weight:bold; font-size:1.1em;">Total: $${order.total}</div>
          </div>
        ` : '<p class="small">Sin ítems registrados.</p>';
        
        // Propina
        const tipAmt = Number(order.tip_amount || 0);
        const totalWithTip = Number(order.total || 0) + tipAmt;
        const tipBlock = (tipAmt > 0) ? `
          <div class="tip-section" style="margin-top:8px;">
            <div class="small" style="margin-top:4px;">
              Propina: <span class="tip-amount">${formatMoney(tipAmt)}</span>
            </div>
            <p class="detail-summary">Total con propina: <span class="tip-total">${formatMoney(totalWithTip)}</span></p>
          </div>
        ` : '';

        const timeline = combinedHistory.length ? `
          <h3>Historial</h3>
          <div>
            ${combinedHistory.map(h => `<div class="small"><strong>${h.label}</strong> — ${formatARDate(h.date)}${h.actor ? ' (' + h.actor + ')' : ''}</div>`).join('')}
          </div>
        ` : '';

        // SLA Time
        let totalTimeHtml = '';
        if (order.status === 'entregado') {
          let totalSec = getSlaFinal(order.id);
          if (!totalSec || totalSec <= 0) {
            const endHist = history.filter(h => h.status === 'entregado').slice(-1)[0];
            const endTs = endHist ? parseDateSafe(endHist.changed_at) : Date.now();
            const overrideStart = getSlaOverride(order.id);
            const createdTs = parseDateSafe(order.created_at);
            const baseStart = (!Number.isNaN(overrideStart)) ? overrideStart : createdTs;
            const prevSec = getSlaAccumulated(order.id);
            if (!Number.isNaN(baseStart)) {
              const segmentSec = Math.max(0, Math.floor((endTs - baseStart) / 1000));
              totalSec = prevSec + segmentSec;
            }
          }
          if (totalSec && totalSec > 0) {
            const th = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const tm = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            const ts = String(totalSec % 60).padStart(2, '0');
            totalTimeHtml = `<p class="small">Tiempo total: ${th}:${tm}:${ts}</p>`;
          }
        }
        
        const statusLabelText = (order.order_type === 'mesa' && order.status === 'en_camino') ? 'mesa' : order.status;

        box.innerHTML = `
          <p class="d-id"><strong>Pedido #${order.id}</strong></p>
          <span id="detail-order-id" style="display:none;">${order.id}</span>
          <p class="d-tenant">Establecimiento: ${order.tenant_slug}</p>
          <p class="d-date">Fecha: ${formatARDate(order.created_at)}</p>
          <p class="d-type">Tipo: ${order.order_type}</p>
          <p class="d-dest">Destino: ${(order.order_type === 'mesa' || order.order_type === 'espera') ? `<span class="pill pill-mesa">${destino}</span>` : destino}</p>
          ${telefono ? `<p class="d-phone">Teléfono de contacto: ${telefono}</p>` : ''}
          <p class="d-status">Estado: ${statusLabelText}</p>
          ${order.order_notes ? `<p class="d-notes">Detalle adicional: ${order.order_notes}</p>` : ''}
          ${itemsHtml}
          ${tipBlock}
          ${timeline}
          ${totalTimeHtml}
        `;
        return box;
    }

    async function openOrderDetailModal(orderId) {
      try {
        const detail = await fetchOrderDetail(orderId);
        const box = renderOrderDetailContent(detail);
        
        const modalBody = document.getElementById('detail-modal-body');
        const modal = document.getElementById('order-detail-modal');
        const closeBtn = document.getElementById('detail-modal-close');
        modalBody.innerHTML = '';
        modalBody.appendChild(box);
        
        const order = detail.order; // Access order for event listeners
        
        const prevFocus = document.activeElement;
        modal.classList.add('active');
        modal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        
        let focusables = Array.from(modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(x => !x.hasAttribute('disabled'));
        let first = focusables[0];
        let last = focusables[focusables.length - 1];
        const onKeyTrap = (e) => {
          if (e.key === 'Tab') {
            if (!focusables.length) return;
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        };
        document.addEventListener('keydown', onKeyTrap);
        if (closeBtn) { try { closeBtn.focus(); } catch(_) {} }
        
        const printBtn = document.getElementById('detail-modal-print');
        if (printBtn) printBtn.onclick = function(){
            window.showPrintOptions(order.id);
        };

        const cleanup = () => {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden','true');
            modalBody.innerHTML = '';
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', onKeyTrap);
            try { if (prevFocus && typeof prevFocus.focus === 'function') prevFocus.focus(); } catch(_) {}
        };
        if (closeBtn) closeBtn.onclick = cleanup;
        const overlay = modal.querySelector('.kds-modal-overlay');
        if (overlay) overlay.onclick = cleanup;
      } catch(e) { console.error(e); alert('No se pudo cargar el detalle.'); }
    }

    // Auto-refresh cada 10 segundos
    async function loadOrdersSafe() {
      if (isLoading) return;
      isLoading = true;
      try {
        if (!dailyResetOverride) {
          const newBound = computeDailyResetUTC();
          if (newBound !== dailyResetFrom) applyDailyReset(newBound);
        }
        const data = await fetchOrders();
        await renderOrders(data);
        await renderMetricsBox();
        if (!cashCollapsed && !isCashEditing) await renderCashBox();
        if (!cashHistoryCollapsed) await renderCashHistory();

        // --- NEW: Auto-refresh open detail modal ---
        const detailModal = document.getElementById('order-detail-modal');
        if (detailModal && detailModal.classList.contains('active')) {
            const idSpan = document.getElementById('detail-order-id');
            const oid = idSpan ? idSpan.textContent : null;
            if (oid) {
                try {
                    const detail = await fetchOrderDetail(oid);
                    const box = renderOrderDetailContent(detail);
                    const modalBody = document.getElementById('detail-modal-body');
                    // Only replace if content changed (simple check) or just replace always
                    modalBody.innerHTML = '';
                    modalBody.appendChild(box);
                } catch(err) {
                    console.warn('Error refreshing detail modal:', err);
                }
            }
        }
        // -------------------------------------------

      } catch (e) {
        console.warn('Fallo al refrescar pedidos', e);
      } finally {
        isLoading = false;
      }
    }
    let refreshTimer = null;
    const POLL_MS = 5000;

    // filterSelect.addEventListener('change', () => { if (refreshTimer) loadOrdersSafe(); });
    tenantInput.addEventListener('change', async () => { 
        try { localStorage.setItem('tenant_last_selected', tenantInput.value.trim()); } catch (_) {}
        await loadSlaThresholds(); 
        await loadTenantPrefs(); 
        if (refreshTimer) loadOrdersSafe(); 
        try { await renderInventory(); } catch (_) {}
        try { await renderArchived(); } catch (_) {}
        window.dispatchEvent(new CustomEvent('kds-tables-changed'));
    });
    if (slaWarnInput && slaCritInput) {
      const clampInputs = () => {
        let w = parseInt(slaWarnInput.value || '15', 10);
        let c = parseInt(slaCritInput.value || '30', 10);
        w = Math.max(1, w);
        c = Math.max(w + 1, c);
        slaWarnInput.value = String(w);
        slaCritInput.value = String(c);
      };
      slaWarnInput.addEventListener('change', clampInputs);
      slaCritInput.addEventListener('change', clampInputs);
    }
    if (slaSaveBtn) {
      slaSaveBtn.addEventListener('click', async () => {
        try {
          if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
          if (!csrfToken) { await fetchCSRF(); }
          const slug = tenantInput.value.trim() || defaultSlug();
          let w = parseInt(slaWarnInput.value || '15', 10);
          let c = parseInt(slaCritInput.value || '30', 10);
          w = Math.max(1, w);
          c = Math.max(w + 1, c);
          const url = new URL('/api/tenant_sla', API_BASE);
          url.searchParams.set('tenant_slug', slug);
          const resp = await fetch(url.toString(), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ warning_minutes: w, critical_minutes: c })
          });
          if (!resp.ok) {
            let msg = 'No se pudo guardar SLA';
            try { const j = await resp.json(); if (j && j.error) msg = j.error; } catch (_) {}
            alert(msg);
            return;
          }
          const data = await resp.json();
          currentSlaThresholds = { warning: Math.max(1, Number(data.warning_minutes || w)), critical: Math.max(Number(data.warning_minutes || w) + 1, Number(data.critical_minutes || c)) };
          initSLAClock();
          alert('SLA actualizado');
        } catch (e) {
          alert('Error al guardar SLA');
        }
      });
    }
    // Configuración de pedidos
    let ordersConfig = { filters: { mesa: true, espera: true, direccion: true } };
    try {
      const s = localStorage.getItem('ordersConfig');
      if (s) ordersConfig = { ...ordersConfig, ...JSON.parse(s) };
    } catch(_) {}

    async function renderOrders(data) {
        const orders = data.orders || [];
        window.currentOrders = orders; // Expose for Table Management
        // Filtro para mostrar activos: NO entregados/cancelados, O entregados pero MESA NO pagada
        // Y respetar filtros de configuración
        const active = orders.filter(o => {
            if (o.status === 'cancelado') return false;
            if (o.status === 'entregado') {
                const pStatus = String(o.payment_status || '').trim().toLowerCase();
                if (pStatus !== 'paid') return true;
                return false;
            }
            // Config filters
            const type = (o.order_type || '').toLowerCase();
            const typeKey = type === 'mesa' ? 'mesa' : (type === 'espera' ? 'espera' : 'direccion');
            if (ordersConfig.filters[typeKey] === false) return false;

            return true;
        });

        const total = Number(data.total || orders.length || 0);
        const page = Math.floor(currentOffset / currentLimit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / currentLimit));
        // Construir una firma ligera del estado actual (id, status, total, payment_status) para detectar cambios reales
        const newSignature = JSON.stringify(orders.map(o => ({id:o.id, s:o.status, t:o.total, p:o.payment_status})));
        // Si la firma no cambió y ya hay filas, evitar reconstrucción para prevenir parpadeo
        if (newSignature === lastOrdersSignature && tbody.children.length > 0) {
          countEl.textContent = `Mostrando ${active.length} pedido(s) activos`;
          const pageInfo = document.getElementById('page-info');
          pageInfo.textContent = `Página ${page} de ${totalPages}`;
          return;
        }
        
        const activeIds = new Set(active.map(o => o.id));
        let hasNew = false;
        if (!firstOrderLoad) {
          for (const id of activeIds) { if (!lastActiveIds.has(id)) { hasNew = true; break; } }
        }
        firstOrderLoad = false;
        window.activeCurrent = active;
        if (hasNew) {
          const newList = active.filter(o => !(lastActiveIds && lastActiveIds.has(o.id)));
          let targetId = 0;
          if (newList.length) {
            const sortedNew = newList.slice().sort((a,b) => parseDateSafe(b.created_at) - parseDateSafe(a.created_at));
            targetId = sortedNew[0].id;
          }
          window.lastNewOrderId = targetId;
          try { await renderMetricsBox(); } catch(_) {}
          try { startActiveCardFlash(); } catch(_) {}
          try { if (document.hidden) startTabNotify(); } catch(_) {}
        }
        if (hasNew && soundEnabled) { try { await playNewOrderSound(); } catch (_) {} }
        // Construir nuevo contenido sin vaciar inmediatamente para evitar parpadeo
      // Auto-archivar pedidos entregados/cancelados con más de 24 horas desde el cambio de estado
      async function getStatusChangeTs(orderId, status) {
        try {
          const detail = await fetchOrderDetail(orderId);
          const history = detail.history || [];
          const target = history.filter(h => h.status === status).slice(-1)[0];
          if (!target || !target.changed_at) return NaN;
          return parseDateSafe(target.changed_at);
        } catch (_) { return NaN; }
      }
      async function autoArchiveByStatus(list, status, type) {
        let didArchive = false;
        const now = Date.now();
        const DAY_MS = 24 * 60 * 60 * 1000;
        for (const o of list) {
          const ts = await getStatusChangeTs(o.id, status);
          if (!Number.isNaN(ts) && (now - ts) >= DAY_MS) {
            try { await archiveSnapshot(o, type); } catch (_) {}
            didArchive = true;
          }
        }
        return didArchive;
      }
      // Archivado automático movido a backend o manejado bajo demanda
      countEl.textContent = `Mostrando ${active.length} pedido(s) activos`;
      const pageInfo = document.getElementById('page-info');
      pageInfo.textContent = `Página ${page} de ${totalPages}`;
      const frag = document.createDocumentFragment();
      const fragCards = document.createDocumentFragment();
      const omobilePtr = document.getElementById('orders-mobile');
      try {
        if (window.itemsPreviewTimers) {
          const vals = Object.values(window.itemsPreviewTimers);
          for (const t of vals) { try { clearInterval(t); } catch(_) {} }
          window.itemsPreviewTimers = {};
        }
      } catch(_) {}
      for (const o of active) {
        const tr = document.createElement('tr');
        const destLabel = destinoLabelFor(o);
        const typeRaw = String(o.order_type || '').trim().toLowerCase();
        const isMesa = (typeRaw === 'mesa');
        const isEspera = (typeRaw === 'espera');
        const isDireccion = (typeRaw === 'direccion');
        const isPaid = (o.payment_status === 'paid');

        const phoneRaw = ((isDireccion || isEspera) && o.customer_phone) ? String(o.customer_phone) : '';
        const phoneDigits = phoneRaw.replace(/\D/g, '');
        const waUrl = getWaLink(o, phoneDigits);

        const statusClass = statusClasses[o.status] || 'status-pendiente';
        const statusLabelText = (isMesa && o.status === 'en_camino') ? 'mesa' : o.status;
        
        let pDisabled = '';
        let lDisabled = '';
        let eDisabled = '';
        let cDisabled = '';
        
        if (isMesa || isEspera) {
             const s = o.status;
             // Sequence: pendiente -> preparacion -> listo -> entregado
             const isPrepOrLater = ['preparacion', 'listo', 'en_camino', 'entregado'].includes(s);
             const isListoOrLater = ['listo', 'en_camino', 'entregado'].includes(s);
             
             if (!isPrepOrLater) lDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isListoOrLater) eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             
             // Política para Espera: Debe estar pagado para entregar
             if (isEspera && !isPaid) {
                eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;" title="Debe cobrar antes de entregar"';
             }
        } else {
             const s = o.status;
             // Sequence: pendiente -> preparacion -> listo -> en_camino -> entregado
             const isPrepOrLater = ['preparacion', 'listo', 'en_camino', 'entregado'].includes(s);
             const isListoOrLater = ['listo', 'en_camino', 'entregado'].includes(s);
             const isEnCaminoOrLater = ['en_camino', 'entregado'].includes(s);
             
             if (!isPrepOrLater) lDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isListoOrLater) cDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isEnCaminoOrLater) eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
        }

        let enCaminoBtn = '';
        const payBtn = isPaid 
             ? `<button class="status-action mesa paid" disabled style="opacity:0.3;cursor:default;" aria-label="Pagado" data-tip="Pagado">$</button>`
             : `<button class="status-action mesa" data-action="pay" aria-label="Cobrar" data-tip="Cobrar">$</button>`;

        if (isMesa || isEspera) {
             enCaminoBtn = payBtn;
        } else {
             enCaminoBtn = `<button class="status-action en_camino" data-status="en_camino" aria-label="En camino" data-tip="En camino" ${cDisabled}>C</button>${payBtn}`;
        }

        const entregadoBtn = `<button class="status-action entregado" data-status="entregado" aria-label="Entregado" data-tip="Entregado" ${eDisabled}>E</button>`;
        const prepBtn = `<button class="status-action preparacion" data-status="preparacion" aria-label="Preparación" data-tip="Preparación" ${pDisabled}>P</button>`;
        const listoBtn = `<button class="status-action listo" data-status="listo" aria-label="Listo" data-tip="Listo" ${lDisabled}>L</button>`;

        const baseTotal = Number(o.total || 0);

        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class="small">${formatARDate(o.created_at || '')}</span></td>
          <td><span class="pill">${o.order_type}</span></td>
          <td>${(isMesa || isEspera) ? `<span class="pill pill-mesa">${destLabel}</span>` : destLabel}</td>
          <td>
            <div class="phone-row">
              ${phoneRaw ? `<span class="small">${phoneRaw}</span>` : '<span class="small">-</span>'}
              ${phoneDigits ? `<button class="copy-phone phone-action" data-phone="${phoneRaw}" aria-label="Copiar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm4 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h12v14z"/></svg></button>` : ''}
              ${waUrl ? `<a class="phone-action" href="${waUrl}" target="_blank" rel="noopener" aria-label="WhatsApp"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6.6 10.8c1.5 3 3.9 5.4 6.9 6.9l2.3-2.3c.3-.3.8-.4 1.2-.2 1 .4 2 .6 3.1.6.7 0 1.3.6 1.3 1.3v3.6c0 .7-.6 1.3-1.3 1.3C9.7 22 2 14.3 2 4.3 2 3.6 2.6 3 3.3 3h3.6c.7 0 1.3.6 1.3 1.3 0 1.1.2 2.1.6 3.1.1.4 0 .9-.3 1.2l-2.9 2.2z"/></svg></a>` : ''}
            </div>
          </td>
          <td>
            <div style="display:flex; flex-direction:column;">
                <span class="order-total" data-orderid="${o.id}" data-total="${o.total}">$${o.total}</span>
                ${(isDireccion && o.shipping_cost) ? `<span class="small" style="color:#666; font-size:0.85em;">Envío: ${formatMoney(o.shipping_cost)}</span>` : ''}
            </div>
          </td>
          <td class="items-preview"><span class="small"></span></td>
          <td class="status-cell"><span class="status-badge ${statusClass}">${statusLabelText}</span>${renderSLA(o)}</td>
          <td class="actions">
            <div class="status-quick">
              ${prepBtn}
              ${listoBtn}
              ${enCaminoBtn}
              ${entregadoBtn}
              <button class="status-action" onclick="window.showPrintOptions(${o.id})" style="width:auto; padding:0 8px; margin-right:4px; background:#607d8b; color:white;" title="Imprimir" aria-label="Imprimir">
                <svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
              </button>
              <button class="status-action" onclick="EditOrder.openWithFetch(${o.id}, '${o.table_number||''}')" style="background:#f3f4f6; color:#374151; width:auto; padding:0 8px; margin-right:4px;" title="Editar Items" aria-label="Editar">
                <svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              </button>
              <button class="status-action cancelado" data-status="cancelado" aria-label="Cancelado" data-tip="Cancelado">X</button>
            </div>
            <button class="ver-detalle">Ver</button>
          </td>
        `;
        tr.classList.add(`card-${o.status}`);
        frag.appendChild(tr);
        try { if (!window.itemsPreviewTimers) window.itemsPreviewTimers = {}; } catch(_) {}
        const itemsPreviewEl = tr.querySelector('.items-preview .small');
        if (itemsPreviewEl) {
          try {
            const detailPrev = await fetchOrderDetail(o.id);
            const itemsPrev = Array.isArray(detailPrev.items) ? detailPrev.items : [];
            if (itemsPrev.length) {
              let idxPrev = 0;
              const updatePrev = () => {
                const it = itemsPrev[idxPrev % itemsPrev.length] || {};
                const qty = Number(it.qty || 0);
                const name = String(it.name || '').trim();
                const note = (it.notes && it.notes !== 'null' && it.notes !== 'undefined') ? String(it.notes) : '';
                itemsPreviewEl.textContent = `${qty} × ${name}${note ? ` (${note})` : ''}`;
              };
              updatePrev();
              if (itemsPrev.length > 1) {
                if (window.itemsPreviewTimers[o.id]) { try { clearInterval(window.itemsPreviewTimers[o.id]); } catch(_) {} }
                window.itemsPreviewTimers[o.id] = setInterval(() => { idxPrev = (idxPrev + 1) % itemsPrev.length; updatePrev(); }, 3000);
              }
            }
          } catch(_) {}
        }
        if (omobilePtr) {
          const card = document.createElement('div');
          const addrObj2 = (o && typeof o.address_json === 'object' && o.address_json) ? o.address_json : null;
          const addrText2 = addrObj2 ? String(addrObj2.address || addrObj2.street || addrObj2.line1 || '').trim() : String(o.address_json || '');
          const destLabel = destinoLabelFor(o);
          const phoneRaw2 = ((isDireccion || isEspera) && o.customer_phone) ? String(o.customer_phone) : '';
          const phoneDigits2 = phoneRaw2.replace(/\D/g, '');
          const waUrl2 = getWaLink(o, phoneDigits2);
          const baseTotal2 = Number(o.total || 0);
          card.className = 'card';
          card.innerHTML = `
              <div class="card-content">
              <div class="title">Pedido #${o.id} · Destino: ${(isMesa || isEspera)?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
              <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
              <div class="meta">${phoneRaw2 ? `Tel: ${phoneRaw2}` : ''} ${waUrl2 ? `<a href='${waUrl2}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
              <div class="grid">
                <div>Total: $${baseTotal2}</div>
                ${(isDireccion && o.shipping_cost) ? `<div class="total-tip" style="color:#666;">Envío: ${formatMoney(o.shipping_cost)}</div>` : ''}
              </div>
              <div class="items-preview"><span class="small"></span></div>
            </div>
            <div class="state-line"><span class="status-badge ${statusClass}">${statusLabelText}</span>${renderSLA(o)}</div>
            <div class="actions">
              <div class="status-quick">
                ${prepBtn}
              ${listoBtn}
                ${enCaminoBtn}
                ${entregadoBtn}
                <button class="status-action" onclick="window.showPrintOptions(${o.id})" style="width:auto; padding:0 8px; margin-right:4px; background:#607d8b; color:white;" title="Imprimir" aria-label="Imprimir">
                  <svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
                </button>
                <button class="status-action" onclick="EditOrder.openWithFetch(${o.id}, '${o.table_number||''}')" style="background:#f3f4f6; color:#374151; width:auto; padding:0 10px;" title="Editar Items"><svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                <button class="status-action cancelado" data-status="cancelado" aria-label="Cancelado" data-tip="Cancelado">X</button>
              </div>
              <button class="ver-detalle" data-id="${o.id}">Ver</button>
            </div>
          `;
          fragCards.appendChild(card);
          try { if (!window.itemsPreviewTimers) window.itemsPreviewTimers = {}; } catch(_) {}
          const itemsPreviewEl2 = card.querySelector('.items-preview .small');
          if (itemsPreviewEl2) {
            try {
              const detailPrev2 = await fetchOrderDetail(o.id);
              const itemsPrev2 = Array.isArray(detailPrev2.items) ? detailPrev2.items : [];
              if (itemsPrev2.length) {
                let idxPrev2 = 0;
                const updatePrev2 = () => {
                  const it = itemsPrev2[idxPrev2 % itemsPrev2.length] || {};
                  const qty = Number(it.qty || 0);
                  const name = String(it.name || '').trim();
                  const note = (it.notes && it.notes !== 'null' && it.notes !== 'undefined') ? String(it.notes) : '';
                  itemsPreviewEl2.textContent = `${qty} × ${name}${note ? ` (${note})` : ''}`;
                };
                updatePrev2();
                if (itemsPrev2.length > 1) {
                  if (window.itemsPreviewTimers[o.id]) { try { clearInterval(window.itemsPreviewTimers[o.id]); } catch(_) {} }
                  window.itemsPreviewTimers[o.id] = setInterval(() => { idxPrev2 = (idxPrev2 + 1) % itemsPrev2.length; updatePrev2(); }, 3000);
                }
              }
            } catch(_) {}
          }
          // Tip toggle logic removed

          const quickBtns2 = Array.from(card.querySelectorAll('.status-action'));
          for (const qb of quickBtns2) {
            if (!isAuthed) { qb.disabled = true; }
            qb.addEventListener('mouseenter', () => showStatusTooltipFor(qb));
            qb.addEventListener('mouseleave', hideStatusTooltip);
            qb.addEventListener('focus', () => showStatusTooltipFor(qb));
            qb.addEventListener('blur', hideStatusTooltip);
            qb.addEventListener('click', async () => {
              const action = qb.getAttribute('data-action');
              if (action === 'pay') {
                  if (qb.classList.contains('paid')) return;
                  const methodData = await askPaymentMethod(o.total, (o.order_type || '').toLowerCase() === 'mesa');
                  if (!methodData) return;
                  try {
                      await payOrder(o.id, methodData);
                      o.payment_status = 'paid';
                      if (o.status === 'entregado') {
                          card.remove();
                          tr.remove();
                          try {
                             const countEl = document.getElementById('orders-count');
                             const currentCount = parseInt(countEl.textContent.replace(/\D/g, '') || '0', 10);
                             if (currentCount > 0) countEl.textContent = `Mostrando ${currentCount - 1} pedido(s) activos`;
                          } catch(_) {}
                      } else {
                          qb.classList.add('paid');
                          qb.disabled = true;
                          qb.style.opacity = '0.3';
                          qb.style.cursor = 'default';
                          qb.setAttribute('data-tip', 'Pagado');
                          hideStatusTooltip();
                          const parent = qb.closest('.status-quick');
                          if (parent) {
                              const entBtn = parent.querySelector('.entregado');
                              if (entBtn) {
                                  entBtn.disabled = false;
                                  entBtn.style.opacity = '';
                                  entBtn.style.cursor = '';
                                  entBtn.removeAttribute('title');
                              }
                          }
                      }
                  } catch(e) { alert(e.message); }
                  return;
              }
              const newStatus = qb.getAttribute('data-status') || '';
              if (!newStatus) return;
              if (newStatus === 'entregado') {
                try {
                  const cs = await fetchCashSession();
                  if (!cs || !cs.active) {
                    const openReq = await askConfirm('No hay caja abierta. ¿Abrir ahora?');
                    if (!openReq) return;
                    let amtRaw = null;
                    let amt = 0;
                    let notes = '';
                    try { amtRaw = prompt('Monto inicial en $:', ''); } catch(_) { amtRaw = null; }
                    if (amtRaw === null) return;
                    amt = parseInt(String(amtRaw).trim(), 10);
                    if (Number.isNaN(amt) || amt < 0) { alert('Ingresa un monto válido'); return; }
                    try { notes = String(prompt('Notas de apertura (opcional):') || '').trim(); } catch(_) {}
                    const opened = await openCash({ opening_amount: amt, notes });
                    if (!opened) return;
                  }
                } catch(_) {}
                const ok = await askConfirm('¿Confirma entrega?');
                if (!ok) return;
              }
              let reason = '';
              if (newStatus === 'cancelado') {
                try { reason = String(prompt('Motivo de cancelación:') || '').trim(); } catch(_) { reason = ''; }
              }
              try {
                if (newStatus !== 'entregado') {
                    const ok = await askConfirm('¿Confirmar cambio de estado?');
                    if (!ok) return;
                }
                const success = await updateStatus(o.id, newStatus, reason);
                if (success) {
                  if (newStatus === 'entregado' || newStatus === 'cancelado') {
                  const isUnpaidEntregado = (String(o.payment_status || '').toLowerCase() !== 'paid' && newStatus === 'entregado');
                  
                  if (isUnpaidEntregado) {
                      o.status = newStatus;
                      tr.className = tr.className.replace(/card-\w+/, '') + ` card-${newStatus}`;
                      const badge = tr.querySelector('.status-badge');
                      if (badge) {
                        badge.className = `status-badge ${statusClasses[newStatus]}`;
                        badge.textContent = newStatus;
                      }
                      try {
                        const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                        if (mobileCardBtn) {
                          const mCard = mobileCardBtn.closest('.card');
                          if (mCard) {
                            const mBadge = mCard.querySelector('.status-badge');
                            if (mBadge) {
                               mBadge.className = `status-badge ${statusClasses[newStatus]}`;
                               mBadge.textContent = newStatus;
                            }
                          }
                        }
                      } catch(_) {}
                  } else {
                    tr.remove();
                    try {
                      const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                      if (mobileCardBtn) {
                        const mCard = mobileCardBtn.closest('.card');
                        if (mCard) mCard.remove();
                      }
                    } catch(_) {}
                    try {
                       const countEl = document.getElementById('orders-count');
                       const currentCount = parseInt(countEl.textContent.replace(/\D/g, '') || '0', 10);
                       if (currentCount > 0) countEl.textContent = `Mostrando ${currentCount - 1} pedido(s) activos`;
                    } catch(_) {}
                  }

                } else {
                    tr.className = tr.className.replace(/card-\w+/, '') + ` card-${newStatus}`;
                    const badge = tr.querySelector('.status-badge');
                    if (badge) {
                      badge.className = `status-badge ${statusClasses[newStatus]}`;
                      badge.textContent = newStatus;
                    }
                    qb.disabled = false;
                    try {
                      const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                      if (mobileCardBtn) {
                        const mCard = mobileCardBtn.closest('.card');
                        if (mCard) {
                          const mBadge = mCard.querySelector('.status-badge');
                          if (mBadge) {
                             mBadge.className = `status-badge ${statusClasses[newStatus]}`;
                             mBadge.textContent = newStatus;
                          }
                        }
                      }
                    } catch(_) {}
                  }
                }
              } catch(_) {}
            });
          }
          const viewBtn2 = card.querySelector('.ver-detalle');
          viewBtn2.addEventListener('click', () => openOrderDetailModal(o.id));
        }
        const copyBtn = tr.querySelector('.copy-phone');
        if (copyBtn) {
          copyBtn.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(copyBtn.getAttribute('data-phone') || ''); } catch (_) {}
          });
        }
        
        const viewBtn = tr.querySelector('.ver-detalle');
        // Tip toggle logic removed
        const quickBtns = Array.from(tr.querySelectorAll('.status-action'));
        for (const qb of quickBtns) {
          if (!isAuthed) { qb.disabled = true; }
          qb.addEventListener('mouseenter', () => showStatusTooltipFor(qb));
          qb.addEventListener('mouseleave', hideStatusTooltip);
          qb.addEventListener('focus', () => showStatusTooltipFor(qb));
          qb.addEventListener('blur', hideStatusTooltip);
          qb.addEventListener('click', async () => {
            const action = qb.getAttribute('data-action');
            if (action === 'pay') {
                if (qb.classList.contains('paid')) return;
                const methodData = await askPaymentMethod(o.total, (o.order_type || '').toLowerCase() === 'mesa', o.shipping_cost || 0);
                if (!methodData) return;
                try {
                    await payOrder(o.id, methodData);
                    o.payment_status = 'paid';
                    if (o.status === 'entregado') {
                        tr.remove();
                        try {
                           const countEl = document.getElementById('orders-count');
                           const currentCount = parseInt(countEl.textContent.replace(/\D/g, '') || '0', 10);
                           if (currentCount > 0) countEl.textContent = `Mostrando ${currentCount - 1} pedido(s) activos`;
                        } catch(_) {}
                        try {
                          const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                          if (mobileCardBtn) {
                            const mCard = mobileCardBtn.closest('.card');
                            if (mCard) mCard.remove();
                          }
                        } catch(_) {}
                    } else {
                        qb.classList.add('paid');
                        qb.disabled = true;
                        qb.style.opacity = '0.3';
                        qb.style.cursor = 'default';
                        qb.setAttribute('data-tip', 'Pagado');
                        hideStatusTooltip();
                        const parent = qb.closest('.status-quick');
                        if (parent) {
                            const entBtn = parent.querySelector('.entregado');
                            if (entBtn) {
                                entBtn.disabled = false;
                                entBtn.style.opacity = '';
                                entBtn.style.cursor = '';
                                entBtn.removeAttribute('title');
                            }
                        }
                    }
                } catch(e) { alert(e.message); }
                return;
            }
            const newStatus = qb.getAttribute('data-status') || '';
            if (!newStatus) return;
            if (newStatus === 'entregado') {
              try {
                const cs = await fetchCashSession();
                if (!cs || !cs.active) {
                  const openReq = await askConfirm('No hay caja abierta. ¿Abrir ahora?');
                  if (!openReq) return;
                  let amtRaw = null;
                  let amt = 0;
                  let notes = '';
                  try { amtRaw = prompt('Monto inicial en $:', ''); } catch(_) { amtRaw = null; }
                  if (amtRaw === null) return;
                  amt = parseInt(String(amtRaw).trim(), 10);
                  if (Number.isNaN(amt) || amt < 0) { alert('Ingresa un monto válido'); return; }
                  try { notes = String(prompt('Notas de apertura (opcional):') || '').trim(); } catch(_) {}
                  const opened = await openCash({ opening_amount: amt, notes });
                  if (!opened) return;
                }
              } catch(_) {}
              const ok = await askConfirm('¿Confirma entrega?');
              if (!ok) return;
            }
            let reason = '';
            if (newStatus === 'cancelado') {
              const ok = await askConfirm('¿Confirma cancelación?');
              if (!ok) return;
              try { reason = String(prompt('Motivo de cancelación (opcional):') || '').trim(); } catch(_) {}
            }
            qb.disabled = true;
            try {
              const resp = await updateStatus(o.id, newStatus, reason);
              if (newStatus === 'preparacion') {
                const nowIso = new Date().toISOString();
                const rowSla = tr.querySelector('.sla-container');
                const domCreatedTs = rowSla ? Number(rowSla.getAttribute('data-created-ts') || NaN) : NaN;
                const createdTs = !Number.isNaN(domCreatedTs) ? domCreatedTs : parseDateSafe(o.created_at);
                const prevStartTs = getSlaOverride(o.id);
                const baseStart = (!Number.isNaN(prevStartTs)) ? prevStartTs : createdTs;
                const nowMs = Date.now();
                if (!Number.isNaN(baseStart)) {
                  const prevElapsedSec = Math.max(0, Math.floor((nowMs - baseStart) / 1000));
                  addSlaAccumulated(o.id, prevElapsedSec);
                }
                setSlaOverride(o.id, nowIso);
              } else if (newStatus === 'entregado') {
                const nowMs = Date.now();
                const rowSla = tr.querySelector('.sla-container');
                const domCreatedTs = rowSla ? Number(rowSla.getAttribute('data-created-ts') || NaN) : NaN;
                const createdTs = !Number.isNaN(domCreatedTs) ? domCreatedTs : parseDateSafe(o.created_at);
                const overrideStart = getSlaOverride(o.id);
                const baseStart = (!Number.isNaN(overrideStart)) ? overrideStart : createdTs;
                let segmentSec = 0;
                if (!Number.isNaN(baseStart)) {
                  segmentSec = Math.max(0, Math.floor((nowMs - baseStart) / 1000));
                }
                const totalSec = getSlaAccumulated(o.id) + segmentSec;
                setSlaFinal(o.id, totalSec);
              }
              
              if (newStatus === 'entregado' || newStatus === 'cancelado') {
                  const isUnpaidEntregado = (String(o.payment_status || '').trim().toLowerCase() !== 'paid' && newStatus === 'entregado');

                  if (isUnpaidEntregado) {
                      o.status = newStatus;
                      tr.className = tr.className.replace(/card-\w+/, '') + ` card-${newStatus}`;
                      const badge = tr.querySelector('.status-badge');
                      if (badge) {
                        badge.className = `status-badge ${statusClasses[newStatus]}`;
                        badge.textContent = newStatus;
                      }
                      try {
                        const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                        if (mobileCardBtn) {
                          const mCard = mobileCardBtn.closest('.card');
                          if (mCard) {
                            const mBadge = mCard.querySelector('.status-badge');
                            if (mBadge) {
                               mBadge.className = `status-badge ${statusClasses[newStatus]}`;
                               mBadge.textContent = newStatus;
                            }
                          }
                        }
                      } catch(_) {}
                  } else {
                      tr.remove();
                      try {
                        const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                        if (mobileCardBtn) {
                          const mCard = mobileCardBtn.closest('.card');
                          if (mCard) mCard.remove();
                        }
                      } catch(_) {}
                      try {
                         const countEl = document.getElementById('orders-count');
                         const currentCount = parseInt(countEl.textContent.replace(/\D/g, '') || '0', 10);
                         if (currentCount > 0) countEl.textContent = `Mostrando ${currentCount - 1} pedido(s) activos`;
                      } catch(_) {}
                  }
                  
                  // Update delivered/canceled lists immediately
                  try {
                    o.status = newStatus;
                    if (newStatus === 'entregado') {
                      if (!window.deliveredCurrent) window.deliveredCurrent = [];
                      // Add only if not present (though unlikely in this flow)
                      if (!window.deliveredCurrent.find(x => x.id === o.id)) window.deliveredCurrent.unshift(o);
                      renderDelivered(window.deliveredCurrent).catch(()=>{});
                    } else {
                      if (!window.canceledCurrent) window.canceledCurrent = [];
                      if (!window.canceledCurrent.find(x => x.id === o.id)) window.canceledCurrent.unshift(o);
                      renderCanceled(window.canceledCurrent).catch(()=>{});
                    }
                  } catch(_) {}


              } else {
                  tr.className = tr.className.replace(/card-\w+/, '') + ` card-${newStatus}`;
                  const badge = tr.querySelector('.status-badge');
                  if (badge) {
                    badge.className = `status-badge ${statusClasses[newStatus]}`;
                    badge.textContent = newStatus;
                  }
                  try {
                    const mobileCardBtn = document.querySelector(`#orders-mobile .ver-detalle[data-id="${o.id}"]`);
                    if (mobileCardBtn) {
                      const mCard = mobileCardBtn.closest('.card');
                      if (mCard) {
                        const mBadge = mCard.querySelector('.status-badge');
                        if (mBadge) {
                           mBadge.className = `status-badge ${statusClasses[newStatus]}`;
                           mBadge.textContent = newStatus;
                        }
                      }
                    }
                  } catch(_) {}
              }
            } catch (e) {
              try {
                const url = new URL(`/api/orders/${o.id}/status`, API_BASE);
                const r = await fetch(url.toString(), { method:'PATCH', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': csrfToken }, body: JSON.stringify({ status: newStatus, reason }) });
                const j = await r.json();
                alert(String(j && j.error || 'No se pudo actualizar el estado'));
              } catch(_) {
                alert('No se pudo actualizar el estado');
              }
            } finally {
              qb.disabled = false;
            }
          });
        }
        
        viewBtn.addEventListener('click', () => openOrderDetailModal(o.id));
      }
      tbody.replaceChildren(frag);
      if (omobilePtr) omobilePtr.replaceChildren(fragCards);
      initSLAClock();
      const delivered = orders.filter(o => o.status === 'entregado');
      const canceled = orders.filter(o => o.status === 'cancelado');
      window.deliveredCurrent = delivered;
      window.canceledCurrent = canceled;
      await renderDelivered(delivered);
      await renderCanceled(canceled);
      
      lastOrdersSignature = newSignature;
      lastActiveIds = activeIds;
      
      // Auto-scroll to order if search by ID
      if (currentSearch && /^\d+$/.test(currentSearch.trim())) {
         const searchedId = currentSearch.trim();
         // Check active orders
         let foundEl = document.querySelector(`#orders-tbody tr td:first-child`);
         // We need to iterate rows to match ID text
         const allActiveRows = Array.from(document.querySelectorAll('#orders-tbody tr'));
         for (const r of allActiveRows) {
            const idCell = r.querySelector('td:first-child');
            if (idCell && idCell.textContent.trim() === searchedId) {
                r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                r.style.transition = 'background 0.5s';
                r.style.background = '#fff9c4'; // highlight
                setTimeout(() => { r.style.background = ''; }, 2000);
                return; // Stop if found in active
            }
         }
         
         // Check delivered
         const allDeliveredRows = Array.from(document.querySelectorAll('#delivered-tbody tr'));
         for (const r of allDeliveredRows) {
            const idCell = r.querySelector('td:first-child');
            if (idCell && idCell.textContent.trim() === searchedId) {
                const box = document.getElementById('delivered-box');
                if (box) box.open = true;
                r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                r.style.transition = 'background 0.5s';
                r.style.background = '#fff9c4';
                setTimeout(() => { r.style.background = ''; }, 2000);
                return;
            }
         }

         // Check canceled
         const allCanceledRows = Array.from(document.querySelectorAll('#canceled-tbody tr'));
         for (const r of allCanceledRows) {
            const idCell = r.querySelector('td:first-child');
            if (idCell && idCell.textContent.trim() === searchedId) {
                const box = document.getElementById('canceled-box');
                if (box) box.open = true;
                r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                r.style.transition = 'background 0.5s';
                r.style.background = '#fff9c4';
                setTimeout(() => { r.style.background = ''; }, 2000);
                return;
            }
         }
      }
      window.dispatchEvent(new CustomEvent('kds-orders-updated'));
    }

    async function renderDelivered(list) {
      const dtbody = document.getElementById('delivered-tbody');
      const dmobile = document.getElementById('delivered-mobile');
      let archDelList = [];
      try { archDelList = await fetchArchived('delivered'); } catch (_) { archDelList = []; }
      const archDeliveredIds = new Set(archDelList.map(x => x.id));
      const filtered = list.filter(x => !archDeliveredIds.has(x.id));
      const total = filtered.length;
      const pageList = filtered.slice(deliveredOffset, deliveredOffset + deliveredLimit);
      // Evitar limpiar inmediatamente para no mostrar vacío
      const fragRows = document.createDocumentFragment();
      const fragCards = document.createDocumentFragment();
      if (!pageList.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="9" class="small">Sin resultados</td>`;
        fragRows.appendChild(tr);
      }
      for (const o of pageList) {
        const tr = document.createElement('tr');
        const destLabel = destinoLabelFor(o);
        const phoneRaw = (o.order_type === 'direccion' && o.customer_phone) ? String(o.customer_phone) : '';
        const phoneDigits = phoneRaw.replace(/\D/g, '');
        const waUrl = getWaLink(o, phoneDigits);
        const statusClass = statusClasses[o.status] || 'status-entregado';
        const baseTotal = Number(o.total || 0);
        const totalWithTip = baseTotal + (Number(o.tip_amount) || 0);
        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class="small">${formatARDate(o.created_at || '')}</span></td>
          <td><span class="pill">${o.order_type}</span></td>
          <td>${o.order_type === 'mesa' ? `<span class="pill pill-mesa">${destLabel}</span>` : destLabel}</td>
          <td>
            <div class="phone-row">
              ${phoneRaw ? `<span class="small">${phoneRaw}</span>` : '<span class="small">-</span>'}
              ${phoneDigits ? `<button class="copy-phone phone-action" data-phone="${phoneRaw}" aria-label="Copiar"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm4 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h12v14z"/></svg></button>` : ''}
              ${waUrl ? `<a class="phone-action" href="${waUrl}" target="_blank" rel="noopener" aria-label="WhatsApp"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6.6 10.8c1.5 3 3.9 5.4 6.9 6.9l2.3-2.3c.3-.3.8-.4 1.2-.2 1 .4 2 .6 3.1.6.7 0 1.3.6 1.3 1.3v3.6c0 .7-.6 1.3-1.3 1.3C9.7 22 2 14.3 2 4.3 2 3.6 2.6 3 3.3 3h3.6c.7 0 1.3.6 1.3 1.3 0 1.1.2 2.1.6 3.1.1.4 0 .9-.3 1.2l-2.9 2.2z"/></svg></a>` : ''}
            </div>
          </td>
          <td>${formatMoney(totalWithTip)}</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td class="actions">
            <button class="ver-detalle">Ver</button>
            <button class="archivar">Archivar</button>
          </td>
        `;
        fragRows.appendChild(tr);
        if (dmobile) {
          const card = document.createElement('div');
          const addrObjD = (o && typeof o.address_json === 'object' && o.address_json) ? o.address_json : null;
          let destTextD = '';
          try {
            if (addrObjD) {
              destTextD = String(addrObjD.address || addrObjD.street || addrObjD.line1 || '').trim();
            } else {
              const raw = String(o.address_json || '').trim();
              if (raw.startsWith('{')) {
                const j = JSON.parse(raw);
                destTextD = String(j.address || j.street || j.line1 || '').trim();
              } else {
                destTextD = raw;
              }
            }
          } catch(_) { destTextD = String(o.address_json || '').trim(); }
          const destLabel = o.order_type === 'mesa' ? `Mesa ${o.table_number || ''}` : destTextD.replace(/\n+/g,' ').slice(0,64);
          const phoneRaw = (o.order_type === 'direccion' && o.customer_phone) ? String(o.customer_phone) : '';
          const phoneDigits = phoneRaw.replace(/\D/g, '');
          const waUrl = getWaLink(o, phoneDigits);
          const baseTotal = Number(o.total || 0);
          const totalWithTip = baseTotal + (Number(o.tip_amount) || 0);
          card.className = 'card';
          const statusClass = statusClasses[o.status] || 'status-entregado';
          card.innerHTML = `
            <div class="card-content">
              <div class="title">Pedido #${o.id}</div>
              <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
              <div class="meta">Destino: ${o.order_type==='mesa'?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
              <div class="meta">${phoneRaw ? `Tel: ${phoneRaw}` : ''} ${waUrl ? `<a href='${waUrl}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
              <div class="grid">
                <div>Total: ${formatMoney(totalWithTip)}</div>
              </div>
            </div>
            <div class="state-line"><span class="status-badge ${statusClass}">${o.status}</span></div>
            <div class="actions">
              <button class="ver-detalle" data-id="${o.id}">Ver</button>
              <button class="archivar" data-id="${o.id}">Archivar</button>
            </div>
          `;
          fragCards.appendChild(card);
        }
        const copyBtn = tr.querySelector('.copy-phone');
        if (copyBtn) {
          copyBtn.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(copyBtn.getAttribute('data-phone') || ''); } catch (_) {}
          });
        }
        const viewBtn = tr.querySelector('.ver-detalle');
        const archiveBtn = tr.querySelector('.archivar');
        if (!isAuthed) { archiveBtn.disabled = true; }
        if (!isAuthed) { archiveBtn.disabled = true; }
        viewBtn.addEventListener('click', () => openOrderDetailModal(o.id));
        archiveBtn.addEventListener('click', async () => {
          try {
            await archiveSnapshot(o, 'delivered');
            tr.remove();
            try { await renderArchived(); } catch (_) {}
            try { await renderMetricsBox(); } catch (_) {}
          } catch (_) {
            alert('No se pudo archivar el pedido');
          }
        });
      }
      // Reemplazar contenido al final para minimizar parpadeo
      dtbody.replaceChildren(fragRows);
      if (dmobile) {
        dmobile.replaceChildren(fragCards);
        dmobile.querySelectorAll('.ver-detalle').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id')||'0',10);
            openOrderDetailModal(id);
          });
        });
        dmobile.querySelectorAll('.archivar').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = parseInt(btn.getAttribute('data-id')||'0',10);
            const found = pageList.find(x => x.id === id);
            try {
              await archiveSnapshot(found, 'delivered');
              try { await renderArchived(); } catch (_) {}
              try { await renderMetricsBox(); } catch (_) {}
              await renderDelivered(list);
            } catch (_) { alert('No se pudo archivar el pedido'); }
          });
        });
      }
      const pageNum = Math.floor(deliveredOffset / deliveredLimit) + 1;
      const totalPages = Math.max(1, Math.ceil(total / deliveredLimit));
      if (delPageInfoEl) delPageInfoEl.textContent = `Página ${pageNum} de ${totalPages} · Total: ${total}`;
      if (delPrevBtn) delPrevBtn.disabled = (deliveredOffset === 0);
      const atEndDel = deliveredOffset + deliveredLimit >= total;
      if (delNextBtn) delNextBtn.disabled = atEndDel;
    }

    async function renderCanceled(list) {
      const ctbody = document.getElementById('canceled-tbody');
      const cmobile = document.getElementById('canceled-mobile');
      let archCanList = [];
      try { archCanList = await fetchArchived('canceled'); } catch (_) { archCanList = []; }
      const archCanceledIds = new Set(archCanList.map(x => x.id));
      const filtered = list.filter(x => {
        // Si estamos buscando por ID y coincide, mostrarlo aunque esté archivado
        if (currentSearch && /^\d+$/.test(currentSearch.trim()) && String(x.id) === currentSearch.trim()) {
            return true;
        }
        return !archCanceledIds.has(x.id);
      });
      const total = filtered.length;
      const pageList = filtered.slice(canceledOffset, canceledOffset + canceledLimit);
      // Preparar nuevos nodos sin limpiar de inmediato
      const fragRows = document.createDocumentFragment();
      const fragCards = document.createDocumentFragment();
      if (!pageList.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="small">Sin resultados</td>`;
        fragRows.appendChild(tr);
      }
      for (const o of pageList) {
        const tr = document.createElement('tr');
        const destLabel = destinoLabelFor(o);
        const statusClass = statusClasses[o.status] || 'status-cancelado';
        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class="small">${formatARDate(o.created_at || '')}</span></td>
          <td><span class="pill">${o.order_type}</span></td>
          <td>${o.order_type === 'mesa' ? `<span class="pill pill-mesa">${destLabel}</span>` : destLabel}</td>
          <td>$${o.total}</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td class="actions">
            <button class="ver-detalle">Ver</button>
            <button class="archivar">Archivar</button>
          </td>
        `;
        fragRows.appendChild(tr);
        if (cmobile) {
          const card = document.createElement('div');
          const addrObjC = (o && typeof o.address_json === 'object' && o.address_json) ? o.address_json : null;
          let destTextC = '';
          try {
            if (addrObjC) {
              destTextC = String(addrObjC.address || addrObjC.street || addrObjC.line1 || '').trim();
            } else {
              const raw = String(o.address_json || '').trim();
              if (raw.startsWith('{')) {
                const j = JSON.parse(raw);
                destTextC = String(j.address || j.street || j.line1 || '').trim();
              } else {
                destTextC = raw;
              }
            }
          } catch(_) { destTextC = String(o.address_json || '').trim(); }
          const destLabel = o.order_type === 'mesa' ? `Mesa ${o.table_number || ''}` : destTextC.replace(/\n+/g,' ').slice(0,64);
          card.className = 'card';
          card.innerHTML = `
            <div class="card-content">
              <div class="title">Pedido #${o.id}</div>
              <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
              <div class="meta">Destino: ${o.order_type==='mesa'?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
              <div class="grid">
                <div>Total: $${o.total}</div>
              </div>
            </div>
            <div class="state-line"><span class="status-badge ${statusClass}">${o.status}</span></div>
            <div class="actions">
              <button class="ver-detalle" data-id="${o.id}">Ver</button>
              <button class="archivar" data-id="${o.id}">Archivar</button>
            </div>
          `;
          fragCards.appendChild(card);
        }
      const viewBtn = tr.querySelector('.ver-detalle');
        const archiveBtn = tr.querySelector('.archivar');
        viewBtn.addEventListener('click', () => openOrderDetailModal(o.id));
        archiveBtn.addEventListener('click', async () => {
          try {
            await archiveSnapshot(o, 'canceled');
            tr.remove();
            try { await renderArchived(); } catch (_) {}
            try { await renderMetricsBox(); } catch (_) {}
          } catch (_) {
            alert('No se pudo archivar el pedido');
          }
        });
      }
      if (cmobile) {
        cmobile.querySelectorAll('.ver-detalle').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id')||'0',10);
            openOrderDetailModal(id);
          });
        });
        cmobile.querySelectorAll('.archivar').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = parseInt(btn.getAttribute('data-id')||'0',10);
            const found = pageList.find(x => x.id === id);
            try {
              await archiveSnapshot(found, 'canceled');
              try { await renderArchived(); } catch (_) {}
              try { await renderMetricsBox(); } catch (_) {}
              await renderCanceled(list);
            } catch (_) { alert('No se pudo archivar el pedido'); }
          });
        });
      }
      ctbody.replaceChildren(fragRows);
      if (cmobile) cmobile.replaceChildren(fragCards);
      const pageNum = Math.floor(canceledOffset / canceledLimit) + 1;
      const totalPages = Math.max(1, Math.ceil(total / canceledLimit));
      if (canPageInfoEl) canPageInfoEl.textContent = `Página ${pageNum} de ${totalPages} · Total: ${total}`;
      if (canPrevBtn) canPrevBtn.disabled = (canceledOffset === 0);
      const atEndCan = canceledOffset + canceledLimit >= total;
      if (canNextBtn) canNextBtn.disabled = atEndCan;
    }
    // INITIAL DATA for gastronomia-local1.html, local2, local3, local4, local5
    async function fetchProducts(includeInactive = false) {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/products', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      if (includeInactive) {
        url.searchParams.set('include_inactive', 'true');
      }
      const resp = await wFetch(url.toString());
      if (!resp.ok) return [];
      const data = await resp.json();
      const arr = Array.isArray(data.products) ? data.products : [];
      if (!includeInactive) {
        return arr.filter(p => p.active !== 0 && p.active !== false);
      }
      return arr;
    }
    async function renderInventory() {
      if (!invTbody) return;
      invTbody.innerHTML = '<tr><td colspan="7" class="small">Cargando...</td></tr>';
      const items = await fetchProducts(true);
      invTbody.innerHTML = '';
      const imobile = document.getElementById('inventory-mobile');
      if (imobile) imobile.innerHTML = '';
      if (!items.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" class="small">Sin productos</td>';
        invTbody.appendChild(tr);
        if (imobile) imobile.innerHTML = '<div class="small">Sin productos</div>';
        return;
      }
      for (const p of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td><div class="small" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.details || '-'}</div></td>
          <td>$${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.active ? '<span class="status-badge status-listo">Activo</span>' : '<span class="status-badge status-pendiente">Inactivo</span>'}</td>
          <td>
            <button class="inv-edit" ${isAuthed ? '' : 'disabled'} style="margin-right: 4px;">Editar</button>
            <button class="inv-delete" ${isAuthed ? '' : 'disabled'} style="background:#c62828;">Eliminar</button>
            <div class="inv-modified small" style="font-size:0.7rem; color:#666; margin-top:4px;">${p.last_modified ? 'Mod: ' + formatARDate(p.last_modified) : ''}</div>
          </td>
        `;
        invTbody.appendChild(tr);
        
        if (imobile) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="title">${p.id} · ${p.name}</div>
            <div class="meta">${p.details||'Sin detalles'}</div>
            <div class="grid">
              <div>Price: $${p.price}</div>
              <div>Stock: ${p.stock}</div>
              <div>${p.active ? '<span class="status-badge status-listo">Activo</span>' : '<span class="status-badge status-pendiente">Inactivo</span>'}</div>
            </div>
            <div class="actions">
              <button class="inv-edit" ${isAuthed ? '' : 'disabled'}>Editar</button>
              <button class="inv-delete" ${isAuthed ? '' : 'disabled'} style="background:#c62828;">Eliminar</button>
              <div class="inv-modified small" style="font-size:0.7rem; color:#666; margin-top:4px;">${p.last_modified ? 'Mod: ' + formatARDate(p.last_modified) : ''}</div>
            </div>
          `;
          imobile.appendChild(card);
          
          const editBtn = card.querySelector('.inv-edit');
          if (editBtn) {
            editBtn.addEventListener('click', () => {
              if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
              if (typeof openProductEditModal === 'function') {
                openProductEditModal(p);
              } else {
                alert('Error: Modal no cargado. Recargue la página.');
              }
            });
          }
          const delBtn = card.querySelector('.inv-delete');
          if (delBtn) {
            delBtn.addEventListener('click', async () => {
                if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
                if (!confirm(`¿Estás seguro de eliminar el producto "${p.name}"?`)) return;
                try {
                    const slug = tenantInput.value.trim() || defaultSlug();
                    const resp = await wFetch(`/api/products/${p.id}?tenant_slug=${slug}`, { method: 'DELETE' });
                    if (resp.ok) {
                        await renderInventory();
                    } else {
                        const j = await resp.json();
                        alert('Error al eliminar: ' + (j.error || 'desconocido'));
                    }
                } catch(e) {
                    alert('Error de conexión al eliminar');
                }
            });
          }
        }

        const editBtn = tr.querySelector('.inv-edit');
        if (editBtn) {
          editBtn.addEventListener('click', () => {
            if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
            if (typeof openProductEditModal === 'function') {
              openProductEditModal(p);
            } else {
              alert('Error: Modal no cargado. Recargue la página.');
            }
          });
        }
        const delBtn = tr.querySelector('.inv-delete');
        if (delBtn) {
          delBtn.addEventListener('click', async () => {
            if (!isAuthed) { alert('Requiere sesión de administrador'); return; }
            if (!confirm(`¿Estás seguro de eliminar el producto "${p.name}"?`)) return;
            try {
                const slug = tenantInput.value.trim() || defaultSlug();
                const resp = await wFetch(`/api/products/${p.id}?tenant_slug=${slug}`, { method: 'DELETE' });
                if (resp.ok) {
                    await renderInventory();
                } else {
                    const j = await resp.json();
                    alert('Error al eliminar: ' + (j.error || 'desconocido'));
                }
            } catch(e) {
                alert('Error de conexión al eliminar');
            }
          });
        }
      }
    }


    async function renderArchived() {
      const atDel = document.getElementById('archived-delivered-tbody');
      const atCan = document.getElementById('archived-canceled-tbody');
      const atReset = document.getElementById('archived-reset-tbody');
      const mDel = document.getElementById('archived-mobile-del');
      const mCan = document.getElementById('archived-mobile-can');
      const mReset = document.getElementById('archived-mobile-reset');
      const delCountEl = document.getElementById('arch-del-count');
      const canCountEl = document.getElementById('arch-can-count');
      const resetCountEl = document.getElementById('arch-reset-count');
      const fetchPage = async (type) => {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/archive', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        url.searchParams.set('type', type);
        if (window.archivedSearch) url.searchParams.set('q', window.archivedSearch);
        if (window.archivedFrom) url.searchParams.set('from', window.archivedFrom);
        if (window.archivedTo) url.searchParams.set('to', window.archivedTo);
        if (window.archOrderType) url.searchParams.set('order_type', window.archOrderType);
        if (window.archDateMode) url.searchParams.set('date_field', window.archDateMode);
        url.searchParams.set('limit', String(archLimit + 1));
        url.searchParams.set('offset', String(archOffset));
        const resp = await wFetch(url.toString());
        if (!resp.ok) throw new Error('Error al obtener archivados');
        const data = await resp.json();
        const arr = Array.isArray(data.archives) ? data.archives : [];
        const hasMore = arr.length > archLimit;
        const total = Number(data.total_count || 0);
        return { list: arr.slice(0, archLimit), hasMore, total };
      };
      const delData = await fetchPage('delivered');
      const canData = await fetchPage('canceled');
      const resetData = await fetchPage('reset');
      const archDel = delData.list;
      const archCan = canData.list;
      const archReset = resetData.list;

      if(atDel) atDel.innerHTML = '';
      if(atCan) atCan.innerHTML = '';
      if(atReset) atReset.innerHTML = '';
      if(mDel) mDel.innerHTML = '';
      if(mCan) mCan.innerHTML = '';
      if(mReset) mReset.innerHTML = '';

      if (delCountEl) delCountEl.textContent = `(${archDel.length})`;
      if (canCountEl) canCountEl.textContent = `(${archCan.length})`;
      if (resetCountEl) resetCountEl.textContent = `(${archReset.length})`;

      if (!archDel.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="small">Sin resultados</td>`;
        if(atDel) atDel.appendChild(tr);
        if (mDel) mDel.innerHTML = '<div class="small">Sin resultados</div>';
      }
      for (const o of archDel) {
        let dest = '';
        if (o.order_type === 'mesa') {
          dest = `Mesa ${o.table_number || ''}`;
        } else {
          const a = o.address_json;
          try {
            if (a && typeof a === 'object') {
              dest = String(a.address || a.street || a.line1 || '').trim();
            } else {
              const raw = String(a || '').trim();
              if (raw.startsWith('{')) {
                const j = JSON.parse(raw);
                dest = String(j.address || j.street || j.line1 || '').trim();
              } else dest = raw;
            }
          } catch(_) { dest = String(a || '').trim(); }
          dest = dest.replace(/\n+/g,' ').slice(0,64);
        }
        const phoneRaw = String(o.customer_phone || '').trim();
        const phoneDigits = phoneRaw.replace(/\D+/g, '');
        const waUrl = getWaLink(o, phoneDigits);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class=\"small\">${formatARDate(o.created_at || '')}</span></td>
          <td><span class=\"pill\">${o.order_type}</span></td>
          <td>${dest}</td>
          <td>
            ${phoneRaw ? `<span class=\"small\">${phoneRaw}</span>` : '<span class=\"small\">-</span>'}
            ${phoneDigits ? `<button class=\"copy-phone small\" data-phone=\"${phoneRaw}\" style=\"margin-left:6px;\">Copiar</button>` : ''}
            ${waUrl ? `<a class=\"small\" href=\"${waUrl}\" target=\"_blank\" rel=\"noopener\" style=\"margin-left:6px;\">WhatsApp</a>` : ''}
          </td>
          <td>$${o.total}</td>
          <td>
            <span class=\"status-badge ${statusClasses['entregado']}\">entregado</span>
            <span class=\"small\" style=\"margin-left:6px;color:#666;\">último: ${(o.last_status||'').trim()||'-'} ${o.last_change? '('+formatARDate(o.last_change)+')':''}</span>
            <button class=\"view-detail small\" style=\"margin-left:8px;\">Ver</button>
          </td>
        `;
        if(atDel) atDel.appendChild(tr);
        if (mDel) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-content">
              <div class="title">Pedido #${o.id}</div>
              <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
              <div class="meta">Destino: ${o.order_type==='mesa'?`<span class='pill pill-mesa'>Mesa ${o.table_number||''}</span>`:dest}</div>
              <div class="meta">${phoneRaw ? `Tel: ${phoneRaw}` : ''} ${waUrl ? `<a href='${waUrl}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
              <div class="grid"><div>Total: $${o.total}</div></div>
            </div>
            <div class="state-line"><span class="status-badge ${statusClasses['entregado']}">entregado</span></div>
            <div class="actions"><button class="view-detail" data-id="${o.id}">Ver</button></div>
          `;
          mDel.appendChild(card);
          const viewBtnCard = card.querySelector('.view-detail');
          if (viewBtnCard) {
            viewBtnCard.addEventListener('click', () => openOrderDetailModal(o.id));
          }
        }
        const copyBtn = tr.querySelector('.copy-phone');
        if (copyBtn) {
          copyBtn.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(copyBtn.getAttribute('data-phone') || ''); } catch (_) {}
          });
        }
        const viewBtn = tr.querySelector('.view-detail');
        if (viewBtn) {
          viewBtn.addEventListener('click', () => openOrderDetailModal(o.id));
        }
      }
      if (!archCan.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="small">Sin resultados</td>`;
        if(atCan) atCan.appendChild(tr);
        if (mCan) mCan.innerHTML = '<div class="small">Sin resultados</div>';
      }
      for (const o of archCan) {
        const destLabel = destinoLabelFor(o);
        const phoneRaw = String(o.customer_phone || '').trim();
        const phoneDigits = phoneRaw.replace(/\D+/g, '');
        const waUrl = getWaLink(o, phoneDigits);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class=\"small\">${formatARDate(o.created_at || '')}</span></td>
          <td><span class=\"pill\">${o.order_type}</span></td>
          <td>${destLabel}</td>
          <td>
            ${phoneRaw ? `<span class=\"small\">${phoneRaw}</span>` : '<span class=\"small\">-</span>'}
            ${phoneDigits ? `<button class=\"copy-phone small\" data-phone=\"${phoneRaw}\" style=\"margin-left:6px;\">Copiar</button>` : ''}
            ${waUrl ? `<a class=\"small\" href=\"${waUrl}\" target=\"_blank\" rel=\"noopener\" style=\"margin-left:6px;\">WhatsApp</a>` : ''}
          </td>
          <td>$${o.total}</td>
          <td>
            <span class=\"status-badge ${statusClasses['cancelado']}\">cancelado</span>
            <span class=\"small\" style=\"margin-left:6px;color:#666;\">último: ${(o.last_status||'').trim()||'-'} ${o.last_change? '('+formatARDate(o.last_change)+')':''}</span>
            <button class=\"view-detail small\" style=\"margin-left:8px;\">Ver</button>
          </td>
        `;
        if(atCan) atCan.appendChild(tr);
        if (mCan) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="title">Pedido #${o.id}</div>
            <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
            <div class="meta">Destino: ${o.order_type==='mesa'?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
            <div class="meta">${phoneRaw ? `Tel: ${phoneRaw}` : ''} ${waUrl ? `<a href='${waUrl}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
            <div class="grid"><div>Total: $${o.total}</div><div>Estado: cancelado</div></div>
            <div class="actions"><button class="view-detail" data-id="${o.id}">Ver</button></div>
          `;
          mCan.appendChild(card);
          const viewBtnCard2 = card.querySelector('.view-detail');
          if (viewBtnCard2) viewBtnCard2.addEventListener('click', () => openOrderDetailModal(o.id));
        }
        const copyBtn = tr.querySelector('.copy-phone');
        if (copyBtn) copyBtn.addEventListener('click', async () => { try { await navigator.clipboard.writeText(copyBtn.getAttribute('data-phone') || ''); } catch (_) {} });
        const viewBtn2 = tr.querySelector('.view-detail');
        if (viewBtn2) viewBtn2.addEventListener('click', () => openOrderDetailModal(o.id));
      }

      // Render Reset/Limpiados
      if (!archReset.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="small">Sin resultados</td>`;
        if(atReset) atReset.appendChild(tr);
        if (mReset) mReset.innerHTML = '<div class="small">Sin resultados</div>';
      }
      for (const o of archReset) {
        const destLabel = destinoLabelFor(o);
        const phoneRaw = String(o.customer_phone || '').trim();
        const phoneDigits = phoneRaw.replace(/\D+/g, '');
        const waUrl = getWaLink(o, phoneDigits);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td><span class=\"small\">${formatARDate(o.created_at || '')}</span></td>
          <td><span class=\"pill\">${o.order_type}</span></td>
          <td>${destLabel}</td>
          <td>
            ${phoneRaw ? `<span class=\"small\">${phoneRaw}</span>` : '<span class=\"small\">-</span>'}
            ${phoneDigits ? `<button class=\"copy-phone small\" data-phone=\"${phoneRaw}\" style=\"margin-left:6px;\">Copiar</button>` : ''}
            ${waUrl ? `<a class=\"small\" href=\"${waUrl}\" target=\"_blank\" rel=\"noopener\" style=\"margin-left:6px;\">WhatsApp</a>` : ''}
          </td>
          <td>$${o.total}</td>
          <td>
            <span class=\"status-badge\" style=\"background:#607d8b;color:#fff;\">limpiado</span>
            <span class=\"small\" style=\"margin-left:6px;color:#666;\">último: ${(o.last_status||'').trim()||'-'} ${o.last_change? '('+formatARDate(o.last_change)+')':''}</span>
            <button class=\"view-detail small\" style=\"margin-left:8px;\">Ver</button>
          </td>
        `;
        if(atReset) atReset.appendChild(tr);
        if (mReset) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="title">Pedido #${o.id}</div>
            <div class="meta">${formatARDate(o.created_at||'')} · ${o.order_type}</div>
            <div class="meta">Destino: ${o.order_type==='mesa'?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
            <div class="meta">${phoneRaw ? `Tel: ${phoneRaw}` : ''} ${waUrl ? `<a href='${waUrl}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
            <div class="grid"><div>Total: $${o.total}</div><div>Estado: limpiado</div></div>
            <div class="actions"><button class="view-detail" data-id="${o.id}">Ver</button></div>
          `;
          mReset.appendChild(card);
          const viewBtnCard3 = card.querySelector('.view-detail');
          if (viewBtnCard3) viewBtnCard3.addEventListener('click', () => openOrderDetailModal(o.id));
        }
        const copyBtn = tr.querySelector('.copy-phone');
        if (copyBtn) copyBtn.addEventListener('click', async () => { try { await navigator.clipboard.writeText(copyBtn.getAttribute('data-phone') || ''); } catch (_) {} });
        const viewBtn3 = tr.querySelector('.view-detail');
        if (viewBtn3) viewBtn3.addEventListener('click', () => openOrderDetailModal(o.id));
      }

      // Reemplazar contenido al final para reducir parpadeo (removed since we are appending directly above)
      // ctbody.replaceChildren(fragRows); // This was in original code but variable name seemed undefined in context or I missed it.
      // Wait, original code used ctbody? No, original used atDel, atCan. Ah, I see "ctbody.replaceChildren(fragRows)" in the `Read` output at line 4011.
      // But `ctbody` is NOT defined in the snippet I read! It must be a mistake in my reading or it's a variable I missed.
      // Looking at line 3848-3853 of `Read` output: `const atDel = ...`.
      // Looking at line 4011: `ctbody.replaceChildren(fragRows);`
      // Where is `ctbody` defined? It's NOT in the function scope I read.
      // Ah, I see `const ctbody = document.getElementById('orders-tbody');` somewhere else? No, this is `renderArchived`.
      // Let me re-read the *entire* function `renderArchived` from the file to be sure.
      // The snippet I read started at 3832.
      // Lines 3847 starts `async function renderArchived() {`.
      // I see `atDel`, `atCan`.
      // I DO NOT see `ctbody` defined inside `renderArchived`.
      // Maybe it's a global variable? Or maybe I missed a line.
      // Wait, if I replace the whole function, I must be careful about `ctbody`.
      // If `ctbody` is used at the end (line 4011), it might be a copy-paste error in the original code or it refers to something I can't see.
      // However, `atDel` and `atCan` are used throughout the loop.
      // Let's look at the `Read` output again carefully.
      // Lines 3863-3864: `atDel.innerHTML = ''; atCan.innerHTML = '';`
      // Lines 3915: `atDel.appendChild(tr);`
      // Lines 3976: `atCan.appendChild(tr);`
      // Line 4011: `ctbody.replaceChildren(fragRows);` -> This looks suspicious. `fragRows` is not defined in the snippet either!
      // `fragRows` usually implies a DocumentFragment.
      // BUT in the loop (e.g., line 3915), it does `atDel.appendChild(tr)`.
      // So `atDel` is being modified directly.
      // Then why `ctbody.replaceChildren` at the end?
      // AND `cmobile` at line 4012.
      // This suggests the original code I read might have had some fragments logic that was either removed or I'm misinterpreting.
      // actually, looking at the `Read` output again:
      // I DO NOT see `const fragRows = ...` anywhere.
      // I DO see `atDel.appendChild(tr)` inside the loop.
      // So if `atDel` is modified in place, `ctbody.replaceChildren` at the end would overwrite something else?
      // `ctbody` usually stands for "Current Table Body" or similar.
      // IF `ctbody` is undefined, this code would throw an error.
      // Maybe `ctbody` is global?
      // User said "Perfecto! ahora funciona correctamente", so the code is working.
      // This implies `ctbody` IS defined or I missed it.
      // BUT, `renderArchived` seems to operate on `archived-delivered-tbody` (`atDel`) and `archived-canceled-tbody` (`atCan`).
      // `ctbody` is usually for the *main* orders table (`orders-tbody`).
      // Is it possible `renderArchived` was copy-pasted from `renderOrders` and `ctbody` line was left over but is dead code or buggy but ignored?
      // OR, maybe `ctbody` is `atDel`?
      // Let's assume `ctbody` lines are trash/legacy and should be removed or replaced with correct logic.
      // My proposed replacement code uses `atDel`, `atCan`, `atReset` explicitly and clears them at the start.
      // I will remove the `ctbody.replaceChildren` lines as they seem incorrect for this specific function which updates multiple tbodies.
      // I will also remove `cmobile`.
      
      const totalAll = Number(delData.total || 0) + Number(canData.total || 0) + Number(resetData.total || 0);
      const atEnd = (archOffset + archLimit) >= totalAll;
      if (archNextBtn) archNextBtn.disabled = atEnd;
      if (archPrevBtn) archPrevBtn.disabled = (archOffset === 0);
      const pageNum = Math.floor(archOffset / archLimit) + 1;
      const totalPages = Math.max(1, Math.ceil((totalAll || 1) / archLimit));
      if (archPageInfoEl) archPageInfoEl.textContent = `Página ${pageNum} de ${totalPages} · Total: ${totalAll}`;
    }
    async function fetchArchivedMetrics() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/archive/metrics', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      if (window.archivedFrom) url.searchParams.set('from', window.archivedFrom);
      if (window.archivedTo) url.searchParams.set('to', window.archivedTo);
      if (window.archOrderType) url.searchParams.set('order_type', window.archOrderType);
      if (archDateModeSelect && archDateModeSelect.value) url.searchParams.set('date_field', archDateModeSelect.value);
      const resp = await wFetch(url.toString());
      if (!resp.ok) return null;
      return resp.json();
    }
    async function renderArchivedMetrics() {
      try {
        const m = await fetchArchivedMetrics();
        if (!m || !archivedMetricsEl) return;
        archivedMetricsEl.textContent = `Entregados: ${m.delivered_count} · Total entregados: $${m.delivered_total} · Propina(10%): $${m.delivered_tip_10} · Total c/propina: $${m.delivered_total_with_tip} · Cancelados: ${m.canceled_count} · Total cancelados: $${m.canceled_total}`;
      } catch (_) {}
    }

    function renderSLA(o) {
      if (o.status === 'entregado' || o.status === 'cancelado') return '';
      const created = o.created_at || '';
      const createdTs = (function(c){
        const t = parseDateSafe(c);
        return Number.isNaN(t) ? Date.now() : t;
      })(created);
      return `<span class="sla-container" data-orderid="${o.id}" data-created="${created}" data-created-ts="${createdTs}" data-status="${o.status}"><span class="sla-dot"></span><span class="sla-label">00:00:00</span><span class="sla-prev small" style="margin-left:4px;color:#888;"></span></span>`;
    }

    // Parseo robusto para 'YYYY-MM-DD[ T]HH:MM:SS(.ffffff)?'
    function parseDateSafe(str) {
      try {
        let s = String(str || '').trim();
        if (!s) return NaN;
        s = s.replace(' ', 'T');
        s = s.replace(/(\d{2}:\d{2}:\d{2})\.(\d{3,})/, (m, base, frac) => `${base}.${frac.slice(0,3)}`);
        // Si no hay zona horaria explícita, asumir UTC (backend usa UTC)
        const hasTZ = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(s);
        const sForParse = hasTZ ? s : s + 'Z';
        let t = Date.parse(sForParse);
        if (!Number.isNaN(t)) return t;
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{1,3}))?)?/);
        if (m) {
          const y = Number(m[1]);
          const mo = Number(m[2]) - 1;
          const d = Number(m[3]);
          const h = Number(m[4]);
          const mi = Number(m[5]);
          const se = Number(m[6] || '0');
          const ms = Number(m[7] || '0');
          return Date.UTC(y, mo, d, h, mi, se, ms);
        }
      } catch (_) {}
      return NaN;
    }
    function formatARDate(str) {
      try {
        const ts = parseDateSafe(str);
        if (Number.isNaN(ts)) return String(str || '');
        const d = new Date(ts);
        return new Intl.DateTimeFormat('es-AR', { timeZone: 'America/Argentina/Buenos_Aires', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(d).replace(',', '');
      } catch (_) { return String(str || ''); }
    }

    // Gestión de SLA (override y tiempo previo) almacenado por tenant
    function slaKey(name) {
      const slug = tenantInput.value.trim() || defaultSlug();
      return `sla_${name}:${slug}`;
    }
    function getSlaOverridesMap() {
      try { return JSON.parse(localStorage.getItem(slaKey('override_start')) || '{}'); } catch (_) { return {}; }
    }
    function setSlaOverridesMap(map) {
      try { localStorage.setItem(slaKey('override_start'), JSON.stringify(map)); } catch (_) {}
    }
    function getSlaAccumulatedMap() {
      try { return JSON.parse(localStorage.getItem(slaKey('accumulated_before')) || '{}'); } catch (_) { return {}; }
    }
    function setSlaAccumulatedMap(map) {
      try { localStorage.setItem(slaKey('accumulated_before'), JSON.stringify(map)); } catch (_) {}
    }
    function getSlaOverride(orderId) {
      const map = getSlaOverridesMap();
      const v = map[String(orderId)];
      if (!v) return NaN;
      return parseDateSafe(v);
    }
    function setSlaOverride(orderId, isoString) {
      const map = getSlaOverridesMap();
      map[String(orderId)] = isoString;
      setSlaOverridesMap(map);
    }
    function getSlaAccumulated(orderId) {
      const map = getSlaAccumulatedMap();
      return Number(map[String(orderId)] || 0);
    }
    function addSlaAccumulated(orderId, seconds) {
      const map = getSlaAccumulatedMap();
      const key = String(orderId);
      map[key] = Number(map[key] || 0) + Number(seconds || 0);
      setSlaAccumulatedMap(map);
    }

    // Tiempo final (entregado) almacenado por tenant
    function getSlaFinalMap() {
      try { return JSON.parse(localStorage.getItem(slaKey('final_total')) || '{}'); } catch (_) { return {}; }
    }
    function setSlaFinalMap(map) {
      try { localStorage.setItem(slaKey('final_total'), JSON.stringify(map)); } catch (_) {}
    }
    function getSlaFinal(orderId) {
      const map = getSlaFinalMap();
      return Number(map[String(orderId)] || 0);
    }
    function setSlaFinal(orderId, seconds) {
      const map = getSlaFinalMap();
      map[String(orderId)] = Number(seconds || 0);
      setSlaFinalMap(map);
    }

    function initSLAClock() {
      if (slaTimer) clearInterval(slaTimer);
      const thresholds = currentSlaThresholds;
      const update = async () => {
        const now = Date.now();
        const nodes = Array.from(document.querySelectorAll('.sla-container'));
        for (const n of nodes) {
          const createdStr = n.getAttribute('data-created') || '';
          const createdAttrTs = Number(n.getAttribute('data-created-ts') || NaN);
          const orderId = n.getAttribute('data-orderid') || '';
          const dot = n.querySelector('.sla-dot');
          const label = n.querySelector('.sla-label');
          const prevEl = n.querySelector('.sla-prev');
          if (!dot || !label) continue;
          let created = createdAttrTs;
          if (Number.isNaN(created)) {
            created = parseDateSafe(createdStr);
          }
          if (Number.isNaN(created)) {
            created = Date.now();
          }
          let startTs = created;
          const overrideStart = orderId ? getSlaOverride(orderId) : NaN;
          if (!Number.isNaN(overrideStart)) startTs = overrideStart;
          const diffMs = now - startTs;
          const currentSec = Math.max(0, Math.floor(diffMs / 1000));
          const hh = String(Math.floor(currentSec / 3600)).padStart(2, '0');
          const mm = String(Math.floor((currentSec % 3600) / 60)).padStart(2, '0');
          const ss = String(currentSec % 60).padStart(2, '0');
          label.textContent = `${hh}:${mm}:${ss}`;
          if (prevEl) {
            const prevSec = orderId ? getSlaAccumulated(orderId) : 0;
            if (prevSec > 0) {
              const phh = String(Math.floor(prevSec / 3600)).padStart(2, '0');
              const pmm = String(Math.floor((prevSec % 3600) / 60)).padStart(2, '0');
              const pss = String(prevSec % 60).padStart(2, '0');
              prevEl.textContent = `(prev: ${phh}:${pmm}:${pss})`;
            } else {
              prevEl.textContent = '';
            }
          }
          const totalElapsedSec = (orderId ? getSlaAccumulated(orderId) : 0) + currentSec;
          const mins = Math.floor(totalElapsedSec / 60);
          dot.classList.remove('sla-warning', 'sla-critical');
          let stateStr = '';
          if (mins >= thresholds.critical) {
            dot.classList.add('sla-critical');
            dot.style.background = '#f44336';
            stateStr = 'critical';
          } else if (mins >= thresholds.warning) {
            dot.classList.add('sla-warning');
            dot.style.background = '#ff9800';
            stateStr = 'warning';
          } else {
            dot.style.background = '#bbb';
          }
      const row = n.closest('tr');
      if (row) {
        if (mins >= thresholds.critical) {
          row.classList.add('card-overdue');
        } else {
          row.classList.remove('card-overdue');
        }
      }
          if (orderId) {
            const prev = slaStateMap.get(orderId) || '';
            if (stateStr !== prev && soundEnabled) {
              if (stateStr === 'warning') { try { await playSlaWarningSound(); } catch (_) {} }
              else if (stateStr === 'critical') { try { await playSlaCriticalSound(); } catch (_) {} }
            }
            slaStateMap.set(orderId, stateStr);
          }
        }
      };
      update();
      slaTimer = setInterval(update, 1000);
    }

    // --- Carousel Logic ---
    const carouselBox = document.getElementById('carousel-box');
    const carouselTbody = document.getElementById('carousel-tbody');
    const carouselMobile = document.getElementById('carousel-mobile');
    const carouselModal = document.getElementById('carousel-modal');
    const carEditId = document.getElementById('car-edit-id');
    const carEditImage = document.getElementById('car-edit-image');
    const carEditTitle = document.getElementById('car-edit-title');
    const carEditText = document.getElementById('car-edit-text');
    const carEditTitleColor = document.getElementById('car-edit-title-color');
    const carEditTextColor = document.getElementById('car-edit-text-color');
    const carEditTitleColorPicker = document.getElementById('car-edit-title-color-picker');
    const carEditTextColorPicker = document.getElementById('car-edit-text-color-picker');
    const carEditPosition = document.getElementById('car-edit-position');
    
    let currentCarouselSlides = [];

    async function fetchCarousel() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/carousel', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      try {
        const resp = await wFetch(url.toString());
        if (!resp.ok) return [];
        const data = await resp.json();
        return Array.isArray(data.slides) ? data.slides : [];
      } catch(e) { console.error(e); return []; }
    }

    async function renderCarousel() {
      if (!carouselTbody) return;
      carouselTbody.innerHTML = '<tr><td colspan="6" class="small">Cargando...</td></tr>';
      currentCarouselSlides = await fetchCarousel();
      carouselTbody.innerHTML = '';
      if (carouselMobile) carouselMobile.innerHTML = '';

      if (currentCarouselSlides.length === 0) {
        carouselTbody.innerHTML = '<tr><td colspan="6" class="small">Sin slides</td></tr>';
        return;
      }

      const fragRows = document.createDocumentFragment();
      const fragCards = document.createDocumentFragment();

      currentCarouselSlides.forEach(slide => {
        // Table Row
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${slide.id}</td>
          <td><img src="${slide.image_url}" style="width:60px; height:40px; object-fit:cover; border-radius:4px;"></td>
          <td>${slide.title || ''}</td>
          <td>${(slide.text || '').slice(0, 50)}...</td>
          <td>${slide.position}</td>
          <td>
            <div class="actions">
              <button class="edit-slide" data-id="${slide.id}" style="background:#2196F3;">Editar</button>
              <button class="delete-slide" data-id="${slide.id}" style="background:#f44336;">Eliminar</button>
            </div>
          </td>
        `;
        fragRows.appendChild(tr);

        // Mobile Card
        if (carouselMobile) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-content">
               <img src="${slide.image_url}" style="width:100%; height:120px; object-fit:cover; border-radius:4px; margin-bottom:8px;">
               <div class="title">${slide.title || '(Sin título)'}</div>
               <div class="meta">Pos: ${slide.position}</div>
               <p class="small">${slide.text || ''}</p>
            </div>
            <div class="actions">
              <button class="edit-slide" data-id="${slide.id}" style="background:#2196F3;">Editar</button>
              <button class="delete-slide" data-id="${slide.id}" style="background:#f44336;">Eliminar</button>
            </div>
          `;
          fragCards.appendChild(card);
        }
      });

      carouselTbody.appendChild(fragRows);
      if (carouselMobile) carouselMobile.appendChild(fragCards);

      // Event Listeners
      const attachListeners = (container) => {
        container.querySelectorAll('.edit-slide').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.dataset.id);
            const slide = currentCarouselSlides.find(s => s.id === id);
            if (slide) openCarouselModal(slide);
          });
        });
        container.querySelectorAll('.delete-slide').forEach(btn => {
          btn.addEventListener('click', async () => {
            if(!confirm('¿Eliminar slide?')) return;
            const id = btn.dataset.id;
            const resp = await wFetch(`/api/carousel/${id}`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': csrfToken }
            });
            if(resp.ok) renderCarousel();
            else alert('Error al eliminar');
          });
        });
      };
      attachListeners(carouselTbody);
      if (carouselMobile) attachListeners(carouselMobile);
    }

    let carouselLastFocus = null;

    function closeCarouselModalSafe() {
      if (!carouselModal) return;
      
      // 1. Move focus away FIRST to avoid aria-hidden error
      try {
        if (carouselLastFocus && typeof carouselLastFocus.focus === 'function' && document.body.contains(carouselLastFocus)) {
           carouselLastFocus.focus();
        } else {
           // Fallback: blur current element to remove focus from modal
           if (document.activeElement && carouselModal.contains(document.activeElement)) {
               document.activeElement.blur();
           }
           document.body.focus(); // Ensure focus is definitely out
        }
      } catch(e) { console.warn('Focus restore failed', e); }

      // 2. Hide modal (display:none removes it from a11y tree, so do this FIRST)
      carouselModal.style.display = 'none';
      
      // 3. Set attributes for state consistency
      carouselModal.setAttribute('aria-hidden', 'true');
      if ('inert' in carouselModal) {
        carouselModal.inert = true;
      }
    }

    function openCarouselModal(slide = null) {
      carouselLastFocus = document.activeElement;
      if(!carouselModal) return;
      carEditId.value = slide ? slide.id : '';
      carEditImage.value = slide ? slide.image_url : '';
      carEditTitle.value = slide ? slide.title : '';
      carEditText.value = slide ? slide.text : '';
      carEditPosition.value = slide ? slide.position : 0;
      if (carEditTitleColor) carEditTitleColor.value = slide && slide.title_color ? slide.title_color : '';
      if (carEditTextColor) carEditTextColor.value = slide && slide.text_color ? slide.text_color : '';
      if (carEditTitleColorPicker) {
        const c = slide && slide.title_color ? slide.title_color : '#ffffff';
        if (c && c[0] === '#' && (c.length === 7 || c.length === 4)) carEditTitleColorPicker.value = c;
        else carEditTitleColorPicker.value = '#ffffff';
      }
      if (carEditTextColorPicker) {
        const c2 = slide && slide.text_color ? slide.text_color : '#ffffff';
        if (c2 && c2[0] === '#' && (c2.length === 7 || c2.length === 4)) carEditTextColorPicker.value = c2;
        else carEditTextColorPicker.value = '#ffffff';
      }
      carouselModal.style.display = 'flex';
      carouselModal.setAttribute('aria-hidden', 'false');
      if ('inert' in carouselModal) {
        carouselModal.inert = false;
      }
    }

    // Carousel Event Bindings
    const btnOpenCarousel = document.getElementById('carousel-open');
    if (btnOpenCarousel && carouselBox) {
      btnOpenCarousel.addEventListener('click', () => {
        carouselBox.open = !carouselBox.open;
        if(carouselBox.open) renderCarousel();
      });
    }
    const btnCarCreate = document.getElementById('car-create-btn');
    if(btnCarCreate) btnCarCreate.addEventListener('click', () => openCarouselModal());
    
    const btnCarReload = document.getElementById('car-reload');
    if(btnCarReload) btnCarReload.addEventListener('click', renderCarousel);

    const headerConfigModal = document.getElementById('header-config-modal');
    const btnHeaderConfigOpen = document.getElementById('header-config-open');
    const headerWhatsappInput = document.getElementById('header-whatsapp');
    const headerInstagramInput = document.getElementById('header-instagram');
    const headerLocationLabelInput = document.getElementById('header-location-label');
    const headerLocationUrlInput = document.getElementById('header-location-url');
    const headerLogoInput = document.getElementById('header-logo-url');
    const headerHoursTable = document.getElementById('header-hours-table');
    const headerHoursHeader = document.getElementById('header-hours-header');
    const headerHoursPanel = document.getElementById('header-hours-panel');
    const headerHoursToggleLabel = document.getElementById('header-hours-toggle-label');
    const headerSaveBtn = document.getElementById('header-save-btn');
    const headerCloseBtn = document.getElementById('header-close-btn');

    function clearHeaderHours() {
      if (!headerHoursTable) return;
      const rows = headerHoursTable.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input[type="time"]');
        inputs.forEach(inp => { inp.value = ''; });
      });
    }

    function setHeaderHoursPanel(open) {
      if (!headerHoursPanel) return;
      headerHoursPanel.style.display = open ? 'block' : 'none';
      if (headerHoursToggleLabel) {
        headerHoursToggleLabel.textContent = open ? 'Ocultar' : 'Mostrar';
      }
    }

    if (headerHoursHeader && headerHoursPanel) {
      headerHoursHeader.addEventListener('click', () => {
        const isOpen = headerHoursPanel.style.display === 'block';
        setHeaderHoursPanel(!isOpen);
      });
    }

    function fillHeaderHours(hours) {
      clearHeaderHours();
      if (!hours || typeof hours !== 'object' || !headerHoursTable) return;
      const days = ['mon','tue','wed','thu','fri','sat','sun'];
      days.forEach(day => {
        const row = headerHoursTable.querySelector('tr[data-day="' + day + '"]');
        if (!row) return;
        const intervals = Array.isArray(hours[day]) ? hours[day] : [];
        const first = Array.isArray(intervals[0]) ? intervals[0] : [];
        const second = Array.isArray(intervals[1]) ? intervals[1] : [];
        const s1 = row.querySelector('.h-start1');
        const e1 = row.querySelector('.h-end1');
        const s2 = row.querySelector('.h-start2');
        const e2 = row.querySelector('.h-end2');
        if (s1) s1.value = first[0] || '';
        if (e1) e1.value = first[1] || '';
        if (s2) s2.value = second[0] || '';
        if (e2) e2.value = second[1] || '';
      });
    }

    function collectHeaderHours() {
      if (!headerHoursTable) return {};
      const days = ['mon','tue','wed','thu','fri','sat','sun'];
      const result = {};
      days.forEach(day => {
        const row = headerHoursTable.querySelector('tr[data-day="' + day + '"]');
        if (!row) return;
        const s1 = row.querySelector('.h-start1');
        const e1 = row.querySelector('.h-end1');
        const s2 = row.querySelector('.h-start2');
        const e2 = row.querySelector('.h-end2');
        const intervals = [];
        const v1s = s1 && s1.value ? s1.value : '';
        const v1e = e1 && e1.value ? e1.value : '';
        const v2s = s2 && s2.value ? s2.value : '';
        const v2e = e2 && e2.value ? e2.value : '';
        if (v1s && v1e) intervals.push([v1s, v1e]);
        if (v2s && v2e) intervals.push([v2s, v2e]);
        if (intervals.length) result[day] = intervals;
      });
      return result;
    }

    async function openHeaderConfigModal() {
      if (!headerConfigModal) return;
      headerConfigModal.style.display = 'flex';
      try {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/tenant_header', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        const resp = await wFetch(url.toString());
        if (!resp.ok) return;
        const data = await resp.json();
        if (headerWhatsappInput) headerWhatsappInput.value = data.whatsapp || '';
        if (headerInstagramInput) headerInstagramInput.value = data.instagram || '';
        if (headerLocationLabelInput) headerLocationLabelInput.value = (data.location_label || data.location || '');
        if (headerLocationUrlInput) headerLocationUrlInput.value = data.location_url || '';
        if (headerLogoInput) headerLogoInput.value = data.logo_url || '';
        if (headerHoursTable) fillHeaderHours(data.opening_hours || {});
        if (headerHoursPanel) {
          const oh = data.opening_hours || {};
          const hasHours = oh && typeof oh === 'object' && Object.keys(oh).length > 0;
          setHeaderHoursPanel(hasHours);
        }
      } catch (_) {}
    }

    if (btnHeaderConfigOpen && headerConfigModal) {
      btnHeaderConfigOpen.addEventListener('click', openHeaderConfigModal);
    }

    if (headerCloseBtn && headerConfigModal) {
      headerCloseBtn.addEventListener('click', () => {
        headerConfigModal.style.display = 'none';
      });
    }

    if (headerSaveBtn && headerConfigModal) {
      headerSaveBtn.addEventListener('click', async () => {
        try {
          if (!isAuthed) {
            alert('Requiere sesión de administrador');
            return;
          }
          if (!csrfToken) {
            await fetchCSRF();
          }
          const slug = tenantInput.value.trim() || defaultSlug();
          const url = new URL('/api/tenant_header', API_BASE);
          url.searchParams.set('tenant_slug', slug);
          const openingHours = collectHeaderHours();
          const payload = {
            whatsapp: headerWhatsappInput ? headerWhatsappInput.value.trim() : '',
            instagram: headerInstagramInput ? headerInstagramInput.value.trim() : '',
            location_label: headerLocationLabelInput ? headerLocationLabelInput.value.trim() : '',
            location_url: headerLocationUrlInput ? headerLocationUrlInput.value.trim() : '',
            opening_hours: openingHours,
            logo_url: headerLogoInput ? headerLogoInput.value.trim() : ''
          };
          const resp = await wFetch(url.toString(), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            let msg = 'No se pudo guardar cabecera';
            try {
              const j = await resp.json();
              if (j && j.error) msg = j.error;
            } catch (_) {}
            alert(msg);
            return;
          }
          headerConfigModal.style.display = 'none';
          alert('Cabecera actualizada');
        } catch (e) {
          alert('Error al guardar cabecera');
        }
      });
    }

    // Logo Upload Logic
    const headerLogoUploadBtn = document.getElementById('header-logo-upload-btn');
    const headerLogoFile = document.getElementById('header-logo-file');
    if (headerLogoUploadBtn && headerLogoFile && headerLogoInput) {
      headerLogoUploadBtn.addEventListener('click', () => headerLogoFile.click());
      headerLogoFile.addEventListener('change', async () => {
        if (headerLogoFile.files.length === 0) return;
        const file = headerLogoFile.files[0];
        const formData = new FormData();
        formData.append('file', file);

        headerLogoUploadBtn.textContent = 'Subiendo...';
        headerLogoUploadBtn.disabled = true;
        try {
          const slug = tenantInput.value.trim() || defaultSlug();
          const url = new URL('/api/upload', API_BASE);
          url.searchParams.set('tenant_slug', slug);

          const resp = await wFetch(url.toString(), {
            method: 'POST',
            body: formData
          });
          if (resp.ok) {
            const data = await resp.json();
            headerLogoInput.value = data.url;
          } else {
            alert('Error al subir imagen');
          }
        } catch(e) { console.error(e); alert('Error de red'); }
        headerLogoUploadBtn.textContent = 'Subir imagen';
        headerLogoUploadBtn.disabled = false;
        headerLogoFile.value = '';
      });
    }

    const btnCloseCarouselBox = document.getElementById('close-carousel-box');
    if(btnCloseCarouselBox && carouselBox) {
        btnCloseCarouselBox.addEventListener('click', () => {
            carouselBox.open = false;
        });
    }

    // Modal Actions
    if (carouselModal) {
      const closeBtns = carouselModal.querySelectorAll('.close-modal, .cancel-btn');
      closeBtns.forEach(b => b.addEventListener('click', closeCarouselModalSafe));

      const saveBtn = carouselModal.querySelector('.save-btn');
      saveBtn.addEventListener('click', async () => {
        const id = carEditId.value;
        const payload = {
          image_url: carEditImage.value.trim(),
          title: carEditTitle.value.trim(),
          text: carEditText.value.trim(),
          title_color: carEditTitleColor ? carEditTitleColor.value.trim() : '',
          text_color: carEditTextColor ? carEditTextColor.value.trim() : '',
          position: parseInt(carEditPosition.value) || 0
        };
        
        if (!payload.image_url) { alert('URL de imagen requerida'); return; }

        const url = id ? `/api/carousel/${id}` : '/api/carousel';
        const method = id ? 'PATCH' : 'POST';
        const slug = tenantInput.value.trim() || defaultSlug();
        const finalUrl = new URL(url, API_BASE);
        if (!id) finalUrl.searchParams.set('tenant_slug', slug);
        else finalUrl.searchParams.set('tenant_slug', slug); 

        const resp = await wFetch(finalUrl.toString(), {
          method: method,
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
          body: JSON.stringify(payload)
        });

        if (resp.ok) {
          closeCarouselModalSafe();
          renderCarousel();
        } else {
          alert('Error al guardar');
        }
      });

      if (carEditTitleColorPicker && carEditTitleColor) {
        carEditTitleColorPicker.addEventListener('input', () => {
          carEditTitleColor.value = carEditTitleColorPicker.value;
        });
      }
      if (carEditTextColorPicker && carEditTextColor) {
        carEditTextColorPicker.addEventListener('input', () => {
          carEditTextColor.value = carEditTextColorPicker.value;
        });
      }
      
      // Upload
      const upBtn = document.getElementById('car-upload-btn');
      const fileInput = document.getElementById('car-edit-file');
      if(upBtn && fileInput) {
        upBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', async () => {
           if (fileInput.files.length === 0) return;
           const file = fileInput.files[0];
           const formData = new FormData();
           formData.append('file', file);
           
           upBtn.textContent = 'Subiendo...';
           upBtn.disabled = true;
           try {
             const slug = tenantInput.value.trim() || defaultSlug();
             const url = new URL('/api/upload', API_BASE);
             url.searchParams.set('tenant_slug', slug);

             const resp = await wFetch(url.toString(), {
               method: 'POST',
               body: formData
             });
             if (resp.ok) {
               const data = await resp.json();
               carEditImage.value = data.url;
             } else {
               alert('Error al subir imagen');
             }
           } catch(e) { console.error(e); alert('Error de red'); }
           upBtn.textContent = 'Subir';
           upBtn.disabled = false;
           fileInput.value = '';
        });
      }
    }

    async function load() {
      if (isLoading) return;
      isLoading = true;
      try {
        if (!dailyResetOverride) {
          const newBound = computeDailyResetUTC();
          if (newBound !== dailyResetFrom) applyDailyReset(newBound);
        }
        const data = await fetchOrders();
        await renderOrders(data);
        await renderMetricsBox();
        if (!cashCollapsed && !isCashEditing) await renderCashBox();
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7">Error al cargar pedidos</td></tr>';
      } finally {
        isLoading = false;
      }
    }


    // // filterSelect.addEventListener('change', () => { currentOffset = 0; load(); });
    document.getElementById('search-btn').addEventListener('click', () => {
      currentSearch = document.getElementById('search-input').value.trim();
      const fd = document.getElementById('from-date').value;
      const td = document.getElementById('to-date').value;
      if (fd) { currentFrom = fd; }
      if (td) { currentTo = td; }
      currentLimit = parseInt(document.getElementById('page-size').value, 10) || 50;
      currentOffset = 0;
      load();
      renderMetricsBox();
      if (!cashCollapsed) renderCashBox();
    });
    const toggleBtn = document.getElementById('toggle-cash');
    if (toggleBtn) toggleBtn.onclick = async () => {
      cashCollapsed = !cashCollapsed;
      const btn = document.getElementById('toggle-cash');
      const box = document.getElementById('cash-box');
      if (btn && box) {
        btn.textContent = cashCollapsed ? 'Mostrar Caja' : 'Ocultar Caja';
        box.style.display = cashCollapsed ? 'none' : 'grid';
      }
      if (!cashCollapsed) await renderCashBox();
    };
    const historyBox = document.getElementById('cash-history');
    if (historyBox) historyBox.style.display = cashHistoryCollapsed ? 'none' : 'block';
    const toggleHist = document.getElementById('toggle-cash-history');
    if (toggleHist) toggleHist.onclick = async () => {
      cashHistoryCollapsed = !cashHistoryCollapsed;
      const btn = document.getElementById('toggle-cash-history');
      const box = document.getElementById('cash-history');
      if (btn && box) {
        btn.textContent = cashHistoryCollapsed ? 'Mostrar Historial' : 'Ocultar Historial';
        box.style.display = cashHistoryCollapsed ? 'none' : 'block';
      }
      if (!cashHistoryCollapsed) await renderCashHistory();
    };
    const inventoryBox = document.getElementById('inventory-box');
    if (inventoryBox) inventoryBox.addEventListener('toggle', async () => {
      if (inventoryBox.open) { try { await renderInventory(); } catch (_) {} }
    });
    document.getElementById('search-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('search-btn').click();
      }
    });
    document.getElementById('page-size').addEventListener('change', () => {
      currentLimit = parseInt(document.getElementById('page-size').value, 10) || 50;
      currentOffset = 0;
      load();
    });
    document.getElementById('prev-page').addEventListener('click', () => {
      currentOffset = Math.max(0, currentOffset - currentLimit);
      load();
    });
    document.getElementById('next-page').addEventListener('click', () => {
      currentOffset += currentLimit;
      load();
    });
    ['orders-export-btn','export-btn'].map(id => document.getElementById(id)).filter(Boolean).forEach(btn => {
      btn.addEventListener('click', () => {
        const slug = tenantInput.value.trim() || defaultSlug();
        const status = '';
        const url = new URL('/api/orders/export.csv', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        if (status) url.searchParams.set('status', status);
        if (currentSearch) url.searchParams.set('q', currentSearch);
        if (currentFrom) url.searchParams.set('from', currentFrom);
        if (currentTo) url.searchParams.set('to', currentTo);
        url.searchParams.set('limit', currentLimit);
        url.searchParams.set('offset', currentOffset);
        window.open(url.toString(), '_blank');
      });
    });

    const resetBtn = document.getElementById('orders-reset-btn');
    if (resetBtn) {
      resetBtn.addEventListener('click', async () => {
        if (!isAuthed) { alert('Debes iniciar sesión'); return; }
        const ok = await askConfirm('¿Estás seguro de que deseas limpiar TODOS los pedidos activos? Desaparecerán de la lista principal.');
        if (!ok) return;
        
        try {
          const slug = tenantInput.value.trim() || defaultSlug();
          const resp = await wFetch(new URL('/api/archive/reset', API_BASE).toString(), {
             method: 'POST',
             headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
             body: JSON.stringify({ tenant_slug: slug })
          });
          if (resp.ok) {
            const j = await resp.json();
            alert(`Se limpiaron ${j.count} pedidos activos.`);
            load(); // Reload orders
          } else {
            alert('Error al limpiar pedidos');
          }
        } catch(e) {
          console.error(e);
          alert('Error de red');
        }
      });
    }
    



    async function ensureAuth() {
      try {
        const resp = await wFetch(new URL('/api/auth/me', API_BASE).toString());
        const data = await resp.json();
        if (data && data.authenticated) {
          isAuthed = true;
          currentUserName = String(data.user || '');
          currentTenantSlug = String(data.tenant_slug || '') || currentTenantSlug;
          await fetchCsrfToken(); // Uses the global function defined at the top
          if (typeof csrfToken !== 'undefined') csrfToken = CSRF_TOKEN;
          document.getElementById('login-box').style.display = 'none';
          return true;
        }
      } catch (_) {}
      isAuthed = false;
      currentUserName = '';
      currentTenantSlug = '';
      document.getElementById('login-box').style.display = 'block';
      setAuthUI();
      return false;
    }

    async function init() {
      try {
        const href = String(window.location && window.location.href || '');
        const url = new URL(href);
        const forceLogout = url.searchParams.get('logout') || url.searchParams.get('forceLogin');
        if (forceLogout) {
          try { await wFetch(new URL('/api/auth/logout', API_BASE).toString(), { method: 'POST' }); } catch (_) {}
          isAuthed = false;
          csrfToken = '';
          const box = document.getElementById('login-box');
          if (box) box.style.display = 'block';
        }
      } catch (_) {}
      await populateTenantsList();
      await ensureAuth();
      setAuthUI();
      if (isAuthed) {
        applyDailyReset(computeDailyResetUTC());
      }
      if (!isAuthed) {
        return;
      }
      await populateTenantsList();
      await loadSlaThresholds();
      await loadTenantPrefs();
      await load();
      refreshTimer = setInterval(loadOrdersSafe, POLL_MS);
      
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
           loadOrdersSafe();
           if (refreshTimer) clearInterval(refreshTimer);
           refreshTimer = setInterval(loadOrdersSafe, POLL_MS);
        }
      });
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
      const btn = document.getElementById('login-btn');
      const uEl = document.getElementById('login-user');
      const pEl = document.getElementById('login-pass');
      const errEl = document.getElementById('login-error');
      const u = (uEl && uEl.value || '').trim();
      const p = pEl ? pEl.value : '';
      try {
        if (btn) btn.disabled = true;
        const ltEl = document.getElementById('login-tenant');
        const slug = (ltEl && ltEl.value && ltEl.value.trim()) || (tenantInput && tenantInput.value && tenantInput.value.trim()) || defaultSlug();
        let resp = await wFetch(new URL('/api/auth/login', API_BASE).toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p, tenant_slug: slug })
        });
        if (!resp.ok && u === 'admin' && p === 'admin123') {
          resp = await wFetch(new URL('/api/auth/login_dev', API_BASE).toString(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, tenant_slug: slug })
          });
        }
        if (!resp.ok) { if (errEl) errEl.style.display = 'block'; return; }
        if (errEl) errEl.style.display = 'none';
        await fetchCsrfToken();
        if (typeof csrfToken !== 'undefined') csrfToken = CSRF_TOKEN;
        currentUserName = u;
        const remEl = document.getElementById('login-remember');
        if (remEl && remEl.checked) {
          try {
            localStorage.setItem(LOGIN_KEY_USER, u);
            localStorage.setItem(LOGIN_KEY_PASS, p);
            localStorage.setItem(LOGIN_KEY_REM, '1');
          } catch (_) {}
        } else {
          try {
            localStorage.removeItem(LOGIN_KEY_PASS);
            localStorage.removeItem(LOGIN_KEY_USER);
            localStorage.setItem(LOGIN_KEY_REM, '0');
          } catch (_) {}
        }
        isAuthed = true;
        currentTenantSlug = slug;
        try { localStorage.setItem('tenant_last_selected', slug); } catch (_) {}
        if (tenantInput) tenantInput.value = slug;
        const box = document.getElementById('login-box');
        if (box) box.style.display = 'none';
        document.body.classList.remove('show-login');
        setAuthUI();
        await loadSlaThresholds();
        await load();
        try { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } await audioCtx.resume(); } catch (_) {}
        refreshTimer = setInterval(loadOrdersSafe, POLL_MS);
      } catch (_) {
        if (errEl) errEl.style.display = 'block';
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try { await wFetch(new URL('/api/auth/logout', API_BASE).toString(), { method: 'POST' }); } catch (_) {}
        isAuthed = false;
        csrfToken = '';
        if (refreshTimer) { try { clearInterval(refreshTimer); } catch (_) {} refreshTimer = null; }
        document.getElementById('login-box').style.display = 'block';
        document.body.classList.add('show-login');
        setAuthUI();
      });
    }

    if (loginOpenBtn) {
      loginOpenBtn.addEventListener('click', () => {
        const box = document.getElementById('login-box');
        if (box) {
          box.style.display = 'block';
          document.body.classList.add('show-login');
          try { box.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) {}
          const u = document.getElementById('login-user');
          try { u && u.focus(); } catch (_) {}
        }
      });
    }

    const tryLogin = async () => {
      const evt = new Event('click');
      document.getElementById('login-btn')?.dispatchEvent(evt);
    };
    document.getElementById('login-user')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryLogin(); });
    document.getElementById('login-pass')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryLogin(); });
    document.addEventListener('click', async (e) => {
      const t = e.target;
      if (t && (t.id === 'login-btn' || (t.closest && t.closest('#login-btn')))) {
        // handled by primary listener above
      }
    });

    document.addEventListener('DOMContentLoaded', init);
    window.addEventListener('afterprint', () => {
      document.body.classList.remove('print-modal');
      document.body.classList.remove('print-ticket');
      try { const sty = document.getElementById('print-ticket-page-style'); if (sty && sty.parentNode) sty.parentNode.removeChild(sty); } catch (_) {}
      const modal = document.getElementById('order-detail-modal');
      if (modal && modal.classList.contains('active')) {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden','true');
        const modalBody = document.getElementById('detail-modal-body');
        if (modalBody) modalBody.innerHTML = '';
        document.body.style.overflow = 'auto';
      }
      try {
        const idEl = document.getElementById('detail-order-id');
        const oid = idEl ? Number(idEl.textContent || 0) : NaN;
        if (!Number.isNaN(oid) && oid > 0) { logOrderEvent(oid, 'printed', { via: 'afterprint' }); }
      } catch (_) {}
    });

    function showStatusTooltipFor(el) {
      const text = el.getAttribute('data-tip') || el.getAttribute('aria-label') || '';
      if (!text) return;
      const tip = document.getElementById('status-tooltip');
      if (!tip) return;
      tip.textContent = text;
      tip.classList.add('active');
      const rect = el.getBoundingClientRect();
      const tx = Math.round(window.scrollX + rect.left + (rect.width/2));
      const ty = Math.round(window.scrollY + rect.top);
      tip.style.left = (tx - (tip.offsetWidth/2)) + 'px';
      tip.style.top = (ty - tip.offsetHeight - 10) + 'px';
    }
    function hideStatusTooltip() {
      const tip = document.getElementById('status-tooltip');
      if (!tip) return;
      tip.classList.remove('active');
    }
    async function askConfirm(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const overlay = modal.querySelector('.kds-modal-overlay');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        const msgEl = document.getElementById('confirm-message');
        msgEl.textContent = message;
        modal.classList.add('active');
        modal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        const prevFocus = document.activeElement;
        let focusables = Array.from(modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(x => !x.hasAttribute('disabled'));
        let first = focusables[0];
        let last = focusables[focusables.length - 1];
        const onTrap = (e) => {
          if (e.key === 'Tab') {
            if (!focusables.length) return;
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        };
        document.addEventListener('keydown', onTrap);
        try { yesBtn.focus(); } catch(_) {}
        const cleanup = () => {
          modal.classList.remove('active');
          modal.setAttribute('aria-hidden','true');
          document.body.style.overflow = 'auto';
          document.removeEventListener('keydown', onTrap);
          try { if (prevFocus && typeof prevFocus.focus === 'function') prevFocus.focus(); } catch(_) {}
          overlay.removeEventListener('click', onNo);
          document.removeEventListener('keydown', onKey);
          yesBtn.onclick = null;
          noBtn.onclick = null;
        };
        const onYes = () => { cleanup(); resolve(true); };
        const onNo = () => { cleanup(); resolve(false); };
        const onKey = (e) => { if (e.key === 'Escape') onNo(); };
        overlay.addEventListener('click', onNo);
        document.addEventListener('keydown', onKey);
        yesBtn.onclick = onYes;
        noBtn.onclick = onNo;
      });
    }

    async function askPaymentMethod(orderTotal = 0, isTable = false, shippingCost = 0) {
      return new Promise((resolve) => {
        const modal = document.getElementById('payment-modal');
        const overlay = modal.querySelector('.kds-modal-overlay');
        const cancelBtn = document.getElementById('payment-cancel');
        const optionBtns = modal.querySelectorAll('.pay-option-btn');
        
        // Mixed Payment Elements
        const mixedBox = document.getElementById('mixed-payment-box');
        const mixedInputs = modal.querySelectorAll('.mixed-input');
        const mixedTotalEntered = document.getElementById('mixed-total-entered');
        const mixedRemaining = document.getElementById('mixed-remaining');
        const confirmMixedBtn = document.getElementById('confirm-mixed-pay');

        // Reset mixed UI
        if(mixedBox) mixedBox.style.display = 'none';
        if(mixedInputs) mixedInputs.forEach(i => i.value = '');

        // Elements for details
        const detailsBox = document.getElementById('payment-details-box');
        const orderTotalEl = document.getElementById('pm-order-total');
        const tipToggle = document.getElementById('pm-tip-toggle');
        const tipAmtEl = document.getElementById('pm-tip-amt');
        const finalTotalEl = document.getElementById('pm-final-total');
        
        // New elements for breakdown
        const subtotalRow = document.getElementById('pm-subtotal-row');
        const subtotalEl = document.getElementById('pm-subtotal');
        const shippingRow = document.getElementById('pm-shipping-row');
        const shippingEl = document.getElementById('pm-shipping');
        const totalRow = document.getElementById('pm-order-total-row');
        const tipRow = document.getElementById('pm-tip-row');

        let currentTotal = Number(orderTotal) || 0;
        let sCost = Number(shippingCost) || 0;
        let tipAmount = 0;
        let finalAmount = currentTotal;

        // Setup UI
        const showBox = true; // Always show details box to display total
        if (showBox) {
            detailsBox.style.display = 'block';
            
            if (sCost > 0) {
                // Show breakdown
                if (subtotalRow) subtotalRow.style.display = 'flex';
                if (shippingRow) shippingRow.style.display = 'flex';
                if (totalRow) totalRow.style.display = 'none';
                
                if (subtotalEl) subtotalEl.textContent = formatMoney(currentTotal - sCost);
                if (shippingEl) shippingEl.textContent = formatMoney(sCost);
            } else {
                // Show standard total line
                if (subtotalRow) subtotalRow.style.display = 'none';
                if (shippingRow) shippingRow.style.display = 'none';
                if (totalRow) totalRow.style.display = 'flex';
                if (orderTotalEl) orderTotalEl.textContent = formatMoney(currentTotal);
            }

            // Tip logic (available for all)
            // if (isTable) {
            if (tipRow) tipRow.style.display = 'flex';
            if (tipToggle) tipToggle.checked = false; // Default off
            // } else {
            //    if (tipRow) tipRow.style.display = 'none';
            //    if (tipToggle) tipToggle.checked = false;
            // }

            updateCalcs();
        } else {
            detailsBox.style.display = 'none';
        }

        function updateCalcs() {
            if (!showBox) return;
            const isTip = tipToggle && tipToggle.checked;
            // 10% tip (base on total? or subtotal? usually total)
            tipAmount = isTip ? Math.round(currentTotal * 0.10) : 0;
            finalAmount = currentTotal + tipAmount;
            
            if (tipAmtEl) tipAmtEl.textContent = '+' + formatMoney(tipAmount);
            if (finalTotalEl) finalTotalEl.textContent = formatMoney(finalAmount);
            
            updateMixedCalcs();
        }

        function updateMixedCalcs() {
           if (!mixedBox || mixedBox.style.display === 'none') return;
           let sum = 0;
           if(mixedInputs) mixedInputs.forEach(i => sum += (Number(i.value) || 0));
           const rem = finalAmount - sum;
           if(mixedTotalEntered) mixedTotalEntered.textContent = formatMoney(sum);
           if(mixedRemaining) {
              mixedRemaining.textContent = formatMoney(rem);
              mixedRemaining.style.color = rem === 0 ? 'green' : '#d9534f';
           }
           if(confirmMixedBtn) {
             const isValid = Math.abs(rem) <= 1; // Tolerance
             confirmMixedBtn.disabled = !isValid;
             confirmMixedBtn.style.opacity = isValid ? '1' : '0.5';
           }
        }
        
        if(mixedInputs) mixedInputs.forEach(i => i.oninput = updateMixedCalcs);

        if (showBox && tipToggle) {
            tipToggle.onchange = updateCalcs;
        }

        modal.classList.add('active');
        modal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        
        const cleanup = () => {
          modal.classList.remove('active');
          modal.setAttribute('aria-hidden','true');
          document.body.style.overflow = 'auto';
          overlay.removeEventListener('click', onCancel);
          cancelBtn.onclick = null;
          optionBtns.forEach(b => b.onclick = null);
          if (tipToggle) tipToggle.onchange = null;
        };
        
        const onCancel = () => { cleanup(); resolve(null); };
        const onSelect = (method) => { 
            if (method === 'mixed') {
               if(mixedBox) {
                  mixedBox.style.display = 'block';
                  updateMixedCalcs();
               }
               return; 
            }
            cleanup(); 
            resolve({
                method: method,
                tip_amount: showBox ? tipAmount : 0,
                final_total: showBox ? finalAmount : currentTotal
            }); 
        };

        if(confirmMixedBtn) confirmMixedBtn.onclick = () => {
             const details = [];
             mixedInputs.forEach(i => {
                const val = Number(i.value)||0;
                if(val > 0) details.push({ method: i.dataset.key, amount: val });
             });
             cleanup();
             resolve({
                method: 'mixed',
                details: details,
                tip_amount: showBox ? tipAmount : 0,
                final_total: showBox ? finalAmount : currentTotal
             });
        };
        
        overlay.addEventListener('click', onCancel);
        cancelBtn.onclick = onCancel;
        
        optionBtns.forEach(btn => {
          btn.onclick = () => onSelect(btn.getAttribute('data-method'));
        });
      });
    }

    // Cargar archivados bajo demanda al abrir el panel correspondiente
    const archivedBox = document.getElementById('archived-box');
    if (archivedBox) {
      archivedBox.addEventListener('toggle', async () => {
        if (archivedBox.open) {
          try { await renderArchived(); } catch (_) {}
          try { await renderArchivedMetrics(); } catch (_) {}
        }
      });
    }
    if (archFilterBtn) {
      archFilterBtn.addEventListener('click', async () => {
        window.archivedSearch = archSearchInput.value.trim();
        window.archivedFrom = archFromInput.value;
        window.archivedTo = archToInput.value;
        window.archOrderType = archOrderTypeSelect ? archOrderTypeSelect.value : '';
        window.archDateMode = archDateModeSelect ? archDateModeSelect.value : 'archived';
        archOffset = 0;
        try { localStorage.setItem('arch_filters', JSON.stringify({ q: window.archivedSearch, from: window.archivedFrom, to: window.archivedTo, order_type: window.archOrderType, mode: window.archDateMode })); } catch (_) {}
        try { await renderArchived(); } catch (_) {}
        try { await renderArchivedMetrics(); } catch (_) {}
      });
    }
    if (archPageSizeSelect) {
      archPageSizeSelect.addEventListener('change', async () => {
        archLimit = parseInt(archPageSizeSelect.value, 10) || 50;
        archOffset = 0;
        try { await renderArchived(); } catch (_) {}
        try { await renderArchivedMetrics(); } catch (_) {}
      });
    }
    if (archPrevBtn) {
      archPrevBtn.addEventListener('click', async () => {
        archOffset = Math.max(0, archOffset - archLimit);
        try { await renderArchived(); } catch (_) {}
        try { await renderArchivedMetrics(); } catch (_) {}
      });
    }
    if (archNextBtn) {
      archNextBtn.addEventListener('click', async () => {
        archOffset += archLimit;
        try { await renderArchived(); } catch (_) {}
        try { await renderArchivedMetrics(); } catch (_) {}
      });
    }
    
    try {
      const raw = localStorage.getItem('arch_filters');
      if (raw) {
        const obj = JSON.parse(raw);
        if (archSearchInput) archSearchInput.value = String(obj.q||'');
        if (archFromInput) archFromInput.value = String(obj.from||archFromInput.value||'');
        if (archToInput) archToInput.value = String(obj.to||archToInput.value||'');
        if (archOrderTypeSelect) archOrderTypeSelect.value = String(obj.order_type||'');
        if (archDateModeSelect) archDateModeSelect.value = String(obj.mode||'archived');
        window.archivedSearch = archSearchInput ? archSearchInput.value.trim() : '';
        window.archivedFrom = archFromInput ? archFromInput.value : '';
        window.archivedTo = archToInput ? archToInput.value : '';
        window.archOrderType = archOrderTypeSelect ? archOrderTypeSelect.value : '';
        window.archDateMode = archDateModeSelect ? archDateModeSelect.value : 'archived';
      }
    } catch (_) {}
    if (archExportBtn) {
      archExportBtn.addEventListener('click', () => {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/archive/export', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        if (window.archivedSearch) url.searchParams.set('q', window.archivedSearch);
        if (window.archivedFrom) url.searchParams.set('from', window.archivedFrom);
        if (window.archivedTo) url.searchParams.set('to', window.archivedTo);
        if (window.archOrderType) url.searchParams.set('order_type', window.archOrderType);
        if (archDateModeSelect && archDateModeSelect.value) url.searchParams.set('date_field', archDateModeSelect.value);
        window.open(url.toString(), '_blank');
      });
    }
    if (invReloadBtn) {
      invReloadBtn.addEventListener('click', async () => {
        try { await renderInventory(); } catch (_) { alert('No se pudo cargar inventario'); }
      });
    }
    if (delPageSizeSelect) {
      delPageSizeSelect.addEventListener('change', async () => {
        deliveredLimit = parseInt(delPageSizeSelect.value, 10) || 50;
        deliveredOffset = 0;
        try { await renderDelivered(window.deliveredCurrent || []); } catch (_) {}
      });
    }
    if (delPrevBtn) {
      delPrevBtn.addEventListener('click', async () => {
        deliveredOffset = Math.max(0, deliveredOffset - deliveredLimit);
        try { await renderDelivered(window.deliveredCurrent || []); } catch (_) {}
      });
    }
    if (delNextBtn) {
      delNextBtn.addEventListener('click', async () => {
        deliveredOffset += deliveredLimit;
        try { await renderDelivered(window.deliveredCurrent || []); } catch (_) {}
      });
    }
    if (canPageSizeSelect) {
      canPageSizeSelect.addEventListener('change', async () => {
        canceledLimit = parseInt(canPageSizeSelect.value, 10) || 50;
        canceledOffset = 0;
        try { await renderCanceled(window.canceledCurrent || []); } catch (_) {}
      });
    }
    if (canPrevBtn) {
      canPrevBtn.addEventListener('click', async () => {
        canceledOffset = Math.max(0, canceledOffset - canceledLimit);
        try { await renderCanceled(window.canceledCurrent || []); } catch (_) {}
      });
    }
    if (canNextBtn) {
      canNextBtn.addEventListener('click', async () => {
        canceledOffset += canceledLimit;
        try { await renderCanceled(window.canceledCurrent || []); } catch (_) {}
      });
    }
    async function fetchMetrics() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/metrics', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      if (currentFrom) url.searchParams.set('from', currentFrom);
      if (currentTo) url.searchParams.set('to', currentTo);
      const resp = await fetch(url.toString());
      if (!resp.ok) return null;
      return resp.json();
    }
    let originalTitle = document.title;
    function startActiveCardFlash() {
      if (window.activeCardFlashTimer) return;
      window.activeCardFlashTimer = setInterval(() => {
        const el = document.getElementById('metric-active');
        if (!el) return;
        const on = el.getAttribute('data-flash') === '1';
        if (on) {
          el.style.boxShadow = '';
          el.style.backgroundColor = '';
          el.setAttribute('data-flash','0');
        } else {
          el.style.boxShadow = '0 0 0 3px #ff9800 inset';
          el.style.backgroundColor = '#fff3e0';
          el.setAttribute('data-flash','1');
        }
      }, 700);
    }
    function stopActiveCardFlash() {
      if (window.activeCardFlashTimer) { clearInterval(window.activeCardFlashTimer); window.activeCardFlashTimer = null; }
      const el = document.getElementById('metric-active');
      if (el) { el.style.boxShadow = ''; el.style.backgroundColor = ''; el.removeAttribute('data-flash'); }
    }
    function startTabNotify() {
      if (window.tabNotifyTimer) return;
      let alertOn = false;
      window.tabNotifyTimer = setInterval(() => {
        document.title = alertOn ? originalTitle : '¡Nuevo pedido activo!';
        alertOn = !alertOn;
      }, 1200);
    }
    function stopTabNotify() {
      if (window.tabNotifyTimer) { clearInterval(window.tabNotifyTimer); window.tabNotifyTimer = null; }
      document.title = originalTitle;
      window.lastNewOrderId = 0;
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        stopTabNotify();
      } else {
        if (window.lastNewOrderId && window.lastNewOrderId > 0) startTabNotify();
      }
    });
    function startActiveCardFlash() {
      if (window.activeCardFlashTimer) return;
      window.activeCardFlashTimer = setInterval(() => {
        const el = document.getElementById('metric-active');
        if (!el) return;
        const on = el.getAttribute('data-flash') === '1';
        if (on) {
          el.style.boxShadow = '';
          el.style.backgroundColor = '';
          el.setAttribute('data-flash','0');
        } else {
          el.style.boxShadow = '0 0 0 3px #ff9800 inset';
          el.style.backgroundColor = '#fff3e0';
          el.setAttribute('data-flash','1');
        }
      }, 700);
    }
    function stopActiveCardFlash() {
      if (window.activeCardFlashTimer) { clearInterval(window.activeCardFlashTimer); window.activeCardFlashTimer = null; }
      const el = document.getElementById('metric-active');
      if (el) { el.style.boxShadow = ''; el.style.backgroundColor = ''; el.removeAttribute('data-flash'); }
    }
    async function renderMetricsBox() {
      try {
        const m = await fetchMetrics();
        const el = document.getElementById('metrics');
        if (!m) { if (el) el.innerHTML = '<div class="small" style="color:#c62828;">No se pudieron cargar las métricas en el rango actual</div>'; return; }
        const rangeFrom = currentFrom ? formatARDate(currentFrom) : '';
        const rangeTo = currentTo ? formatARDate(currentTo) : '';
        const rangeLine = (rangeFrom || rangeTo) ? `<div class="small" style="margin-bottom:6px; color:#555;">Rango: ${rangeFrom || '-'} → ${rangeTo || 'ahora'}</div>` : '';
        el.innerHTML = `
          ${rangeLine}
          <div id="metric-active" class="metric-card">
            <div class="metric-label">Activos</div>
            <div class="metric-value">${m.active_count}</div>
            <div class="metric-sub">Pedidos en curso</div>
          </div>
          <div id="metric-delivered" class="metric-card delivered" style="cursor:pointer;" title="Ver entregados">
            <div class="metric-label">Entregados</div>
            <div class="metric-value">${m.delivered_count}</div>
            <div class="metric-sub">Hoy en el rango seleccionado</div>
          </div>
          <div id="metric-canceled" class="metric-card canceled" style="cursor:pointer;" title="Ver cancelados">
            <div class="metric-label">Cancelados</div>
            <div class="metric-value">${m.canceled_count}</div>
            <div class="metric-sub">Pedidos cancelados</div>
          </div>
          <div class="metric-card money">
            <div class="metric-label">Total entregados</div>
            <div class="metric-value">$${m.delivered_total}</div>
            <div class="metric-sub">Propina(10%): $${m.delivered_tip_10} · Total c/propina: $${m.delivered_total_with_tip}</div>
          </div>
        `;
        const activeCard = el.querySelector('#metric-active');
        if (activeCard) {
          activeCard.style.cursor = 'pointer';
          activeCard.title = 'Ir al último pedido activo';
          activeCard.onclick = () => {
            const list = Array.isArray(window.activeCurrent) ? window.activeCurrent : [];
            let targetId = 0;
            if (window.lastNewOrderId && typeof window.lastNewOrderId === 'number' && window.lastNewOrderId > 0) {
              targetId = window.lastNewOrderId;
            }
            if (!targetId && list.length) {
              const sorted = list.slice().sort((a,b) => parseDateSafe(b.created_at) - parseDateSafe(a.created_at));
              targetId = sorted[0].id;
            }
            if (targetId > 0) {
              const totalEl = document.querySelector(`.order-total[data-orderid="${targetId}"]`);
              const row = totalEl ? totalEl.closest('tr') : null;
              if (row) {
                const card = document.getElementById('metric-active');
                const rowTop = row.getBoundingClientRect().top + window.scrollY;
                const cardBottom = card ? (card.getBoundingClientRect().bottom + window.scrollY) : window.scrollY;
                const targetTop = Math.max(0, rowTop - (cardBottom - window.scrollY) - 12);
                window.scrollTo({ top: targetTop, behavior: 'smooth' });
                row.style.boxShadow = '0 0 0 3px #2196f3 inset';
                row.style.backgroundColor = '#e3f2fd';
                setTimeout(() => { row.style.boxShadow=''; row.style.backgroundColor=''; }, 2000);
              }
            }
            stopActiveCardFlash();
            stopTabNotify();
          };
        }
        const deliveredCard = el.querySelector('#metric-delivered');
        if (deliveredCard) {
          deliveredCard.onclick = () => {
            const box = document.getElementById('delivered-box');
            if (box) {
              box.open = true;
              box.scrollIntoView({ behavior: 'smooth' });
            }
          };
        }
        const canceledCard = el.querySelector('#metric-canceled');
        if (canceledCard) {
          canceledCard.onclick = () => {
            const box = document.getElementById('canceled-box');
            if (box) {
              box.open = true;
              box.scrollIntoView({ behavior: 'smooth' });
            }
          };
        }
        
        const btn = document.getElementById('toggle-cash');
        const box = document.getElementById('cash-box');
        if (btn && box) {
          btn.textContent = cashCollapsed ? 'Mostrar Caja' : 'Ocultar Caja';
          box.style.display = cashCollapsed ? 'none' : 'grid';
        }
      } catch (_) {}
    }

    async function fetchCashSession() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/cash/session', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      const resp = await wFetch(url.toString());
      if (!resp.ok) return { active: false };
      return resp.json();
    }
    async function openCash(opts) {
      const slug = tenantInput.value.trim() || defaultSlug();
      const amtEl = document.getElementById('cash-open-amount');
      const noteEl = document.getElementById('cash-open-notes');
      let opening_amount = 0;
      let notes = '';
      if (opts && typeof opts === 'object') {
        opening_amount = parseInt(String(opts.opening_amount ?? '0'), 10) || 0;
        notes = String(opts.notes || '').trim();
      } else {
        opening_amount = parseInt(amtEl && amtEl.value || '0', 10) || 0;
        notes = noteEl ? String(noteEl.value || '').trim() : '';
      }
      try { await ensureAuth(); } catch(_) {}
      if (!isAuthed || !csrfToken) {
        alert('Debes iniciar sesión para abrir caja.');
        const box = document.getElementById('login-box'); if (box) box.style.display = 'block';
        return false;
      }
      const resp = await fetch(new URL('/api/cash/open', API_BASE).toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ tenant_slug: slug, opening_amount, notes })
      });
      if (!resp.ok) {
        try {
          const err = await resp.json();
          alert(String(err.error || 'No se pudo abrir la caja'));
        } catch(_) { alert('No se pudo abrir la caja'); }
        return false;
      }
      await renderCashBox();
      return true;
    }
    async function closeCash() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const amtEl = document.getElementById('cash-close-amount');
      const noteEl = document.getElementById('cash-close-notes');
      const closing_amount = parseInt(amtEl && amtEl.value || '0', 10) || 0;
      const notes = noteEl ? String(noteEl.value || '').trim() : '';
      
      const efInput = document.getElementById('arqueo-efectivo');
      const posInput = document.getElementById('arqueo-pos');
      const transInput = document.getElementById('arqueo-trans');
      const otrosInput = document.getElementById('arqueo-otros');
      const breakdown = {
          efectivo: parseInt(efInput && efInput.value || '0', 10) || 0,
          pos: parseInt(posInput && posInput.value || '0', 10) || 0,
          transferencia: parseInt(transInput && transInput.value || '0', 10) || 0,
          otros: parseInt(otrosInput && otrosInput.value || '0', 10) || 0
      };

      try { await ensureAuth(); } catch(_) {}
      if (!isAuthed || !csrfToken) {
        alert('Debes iniciar sesión para cerrar caja.');
        const box = document.getElementById('login-box'); if (box) box.style.display = 'block';
        return false;
      }
      const resp = await fetch(new URL('/api/cash/close', API_BASE).toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ tenant_slug: slug, closing_amount, notes, breakdown })
      });
      if (!resp.ok) {
        try {
          const err = await resp.json();
          alert(String(err.error || 'No se pudo cerrar la caja'));
        } catch(_) { alert('No se pudo cerrar la caja'); }
        return false;
      }
      const data = await resp.json();
      cashCloseDraft = { amount: undefined, notes: '' };
      if (!cashKeepModalOpen) { await renderCashBox(); }
      return data;
    }
    async function renderCashBox() {
      try {
        if (cashCollapsed) return;
        const box = document.getElementById('cash-box');
        if (!box) return;
        const data = await fetchCashSession();
        if (cashStatusLabel) {
          if (data && data.active) {
            cashStatusLabel.textContent = 'Caja abierta';
            cashStatusLabel.style.background = '#2e7d32';
          } else {
            cashStatusLabel.textContent = 'Caja cerrada';
            cashStatusLabel.style.background = '#b0bec5';
          }
        }
        if (!data || !data.active) {
          box.innerHTML = `
            <div class="cash-card">
              <div class="cash-title">Apertura de caja</div>
              <div class="cash-row">
                <label>Monto inicial en $ <input id="cash-open-amount" type="number" min="0" step="1" value="${cashOpenDraft.amount || 0}" /> <span id="cash-open-words" class="small"></span></label>
              </div>
              <div class="cash-row">
                <textarea id="cash-open-notes" placeholder="Notas">${cashOpenDraft.notes || ''}</textarea>
              </div>
              <div class="cash-row">
                <button id="cash-open-btn">Abrir caja</button>
              </div>
            </div>
          `;
          const btn = document.getElementById('cash-open-btn');
          if (btn) btn.onclick = async () => { btn.disabled = true; try { await openCash(); } finally { btn.disabled = false; } };
          const amt = document.getElementById('cash-open-amount');
          const note = document.getElementById('cash-open-notes');
          const wordsEl = document.getElementById('cash-open-words');
          const updateWords = () => {
            const v = parseInt(amt.value||'0',10)||0;
            cashOpenDraft.amount = v;
            if (wordsEl) wordsEl.textContent = `(${numberToWordsEs(v)} ${v===1?'peso':'pesos'})`;
          };
          if (amt) {
            amt.addEventListener('input', updateWords);
            amt.addEventListener('focus', () => { isCashEditing = true; });
            amt.addEventListener('blur', () => { setTimeout(() => { const ae = document.activeElement; isCashEditing = ['cash-open-amount','cash-open-notes','cash-close-amount','cash-close-notes'].includes(ae && ae.id); }, 10); });
            updateWords();
          }
          if (note) {
            note.addEventListener('input', () => { cashOpenDraft.notes = String(note.value||''); });
            note.addEventListener('focus', () => { isCashEditing = true; });
            note.addEventListener('blur', () => { setTimeout(() => { const ae = document.activeElement; isCashEditing = ['cash-open-amount','cash-open-notes','cash-close-amount','cash-close-notes'].includes(ae && ae.id); }, 10); });
          }
          const salesEl = document.getElementById('cash-session-sales');
          const inoutEl = document.getElementById('cash-session-inout');
          const sysEl = document.getElementById('cash-session-system');
          const countedEl = document.getElementById('cash-session-counted');
          const diffEl = document.getElementById('cash-session-diff');
          const efInput = document.getElementById('arqueo-efectivo');
          const posInput = document.getElementById('arqueo-pos');
          const transInput = document.getElementById('arqueo-trans');
          const otrosInput = document.getElementById('arqueo-otros');
          const useToggle = document.getElementById('arqueo-use-toggle');
          const closeAmtInput = document.getElementById('cash-close-amount');
          const updateArqueoTotal = () => {
            const ef = parseInt(efInput && efInput.value || '0', 10) || 0;
            const pos = parseInt(posInput && posInput.value || '0', 10) || 0;
            const trn = parseInt(transInput && transInput.value || '0', 10) || 0;
            const otr = parseInt(otrosInput && otrosInput.value || '0', 10) || 0;
            const total = ef + pos + trn + otr;
            const el = document.getElementById('arqueo-total');
            if (el) el.textContent = `Total contado: $${total}`;

            // Actualizar diferencias de arqueo
            const breakdown = sum.theoretical_breakdown || { efectivo: 0, pos: 0, transferencia: 0, otros: 0 };
            const tEf = breakdown.efectivo || 0;
            const tPos = breakdown.pos || 0;
            const tTrn = breakdown.transferencia || 0;
            const tOtr = breakdown.otros || 0;

            if (document.getElementById('theo-efectivo')) document.getElementById('theo-efectivo').textContent = formatMoney(tEf);
            if (document.getElementById('theo-pos')) document.getElementById('theo-pos').textContent = formatMoney(tPos);
            if (document.getElementById('theo-trans')) document.getElementById('theo-trans').textContent = formatMoney(tTrn);
            if (document.getElementById('theo-otros')) document.getElementById('theo-otros').textContent = formatMoney(tOtr);

            const diffEf = ef - tEf;
            const diffPos = pos - tPos;
            const diffTrn = trn - tTrn;
            const diffOtr = otr - tOtr;

            if (document.getElementById('diff-efectivo')) {
                document.getElementById('diff-efectivo').textContent = formatMoney(diffEf);
                document.getElementById('diff-efectivo').style.color = diffEf === 0 ? 'inherit' : (diffEf > 0 ? 'green' : 'red');
            }
            if (document.getElementById('diff-pos')) {
                document.getElementById('diff-pos').textContent = formatMoney(diffPos);
                document.getElementById('diff-pos').style.color = diffPos === 0 ? 'inherit' : (diffPos > 0 ? 'green' : 'red');
            }
            if (document.getElementById('diff-trans')) {
                document.getElementById('diff-trans').textContent = formatMoney(diffTrn);
                document.getElementById('diff-trans').style.color = diffTrn === 0 ? 'inherit' : (diffTrn > 0 ? 'green' : 'red');
            }
            if (document.getElementById('diff-otros')) {
                document.getElementById('diff-otros').textContent = formatMoney(diffOtr);
                document.getElementById('diff-otros').style.color = diffOtr === 0 ? 'inherit' : (diffOtr > 0 ? 'green' : 'red');
            }

            return total;
          };
          const updateSessionTotals = () => {
            const sdel = Number(sum.delivered_total || 0);
            const sin = Number(sum.entradas || 0);
            const sout = Number(sum.salidas || 0);
            const sys = Number((sum.theoretical_cash || 0));
            const counted = (useToggle && useToggle.checked) ? updateArqueoTotal() : (parseInt(closeAmtInput && closeAmtInput.value || '0',10)||0);
            if (salesEl) salesEl.textContent = `Ventas sesión: ${formatMoney(sdel)}`;
            if (inoutEl) inoutEl.textContent = `Ingresos: ${formatMoney(sin)} · Salidas: ${formatMoney(sout)}`;
            if (sysEl) sysEl.textContent = `Sistema: ${formatMoney(sys)}`;
            if (countedEl) countedEl.textContent = `Contado: ${formatMoney(counted)}`;
            if (diffEl) diffEl.textContent = `Diferencia: ${formatMoney(counted - sys)}`;
          };
          updateArqueoTotal();
          updateSessionTotals();
          [efInput, posInput, transInput, otrosInput, useToggle, closeAmtInput].forEach(el => { if (el) el.addEventListener('input', () => { updateArqueoTotal(); updateSessionTotals(); }); });
          return;
        }
        const s = data.session || {};
        const sum = data.summary || {};
        box.innerHTML = `
          <div class="cash-card">
            <div class="cash-title" style="display:flex; align-items:center; justify-content:space-between;">
              <span>Caja abierta</span>
              <button id="cash-eye" class="eye-btn" aria-label="Ocultar caja"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg></button>
            </div>
            <div id="cash-body">
            <div class="small">Abierta: ${formatARDate(s.opened_at || '')} · Por: ${s.opened_by || ''}</div>
            <div class="small">Monto inicial: ${formatMoney(s.opening_amount || 0)}</div>
            <div class="small">Completa los montos reales para cerrar la caja.</div>
            <div class="cash-row" style="display:flex; gap:8px;">
              <button id="cash-movement-btn">Registrar movimiento</button>
            </div>
            <div class="cash-row">
              <div class="small" style="font-weight:700;">Arqueo rápido</div>
            </div>
            <div class="cash-row">
              <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:8px;">
                <thead>
                  <tr style="background:#f5f5f5;">
                    <th style="text-align:left; padding:4px;">Método</th>
                    <th style="text-align:right; padding:4px;">Contado</th>
                    <!-- Blind Close: Hidden theoretical columns -->
                    <!-- <th style="text-align:right; padding:4px;">Teórico</th> -->
                    <!-- <th style="text-align:right; padding:4px;">Dif.</th> -->
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding:4px;">Efectivo</td>
                    <td style="padding:4px; text-align:right;"><input id="arqueo-efectivo" type="number" min="0" step="1" value="${(cashCloseDraft.methods && cashCloseDraft.methods.efectivo) || 0}" style="width:100px; text-align:right;" /></td>
                    <!-- <td style="padding:4px; text-align:right;" id="theo-efectivo">$0</td> -->
                    <!-- <td style="padding:4px; text-align:right; font-weight:bold;" id="diff-efectivo">$0</td> -->
                  </tr>
                  <tr>
                    <td style="padding:4px;">POS/QR</td>
                    <td style="padding:4px; text-align:right;"><input id="arqueo-pos" type="number" min="0" step="1" value="${(cashCloseDraft.methods && cashCloseDraft.methods.pos) || 0}" style="width:100px; text-align:right;" /></td>
                    <!-- <td style="padding:4px; text-align:right;" id="theo-pos">$0</td> -->
                    <!-- <td style="padding:4px; text-align:right; font-weight:bold;" id="diff-pos">$0</td> -->
                  </tr>
                  <tr>
                    <td style="padding:4px;">Transferencias</td>
                    <td style="padding:4px; text-align:right;"><input id="arqueo-trans" type="number" min="0" step="1" value="${(cashCloseDraft.methods && cashCloseDraft.methods.trans) || 0}" style="width:100px; text-align:right;" /></td>
                    <!-- <td style="padding:4px; text-align:right;" id="theo-trans">$0</td> -->
                    <!-- <td style="padding:4px; text-align:right; font-weight:bold;" id="diff-trans">$0</td> -->
                  </tr>
                  <tr>
                    <td style="padding:4px;">Otros</td>
                    <td style="padding:4px; text-align:right;"><input id="arqueo-otros" type="number" min="0" step="1" value="${(cashCloseDraft.methods && cashCloseDraft.methods.otros) || 0}" style="width:100px; text-align:right;" /></td>
                    <!-- <td style="padding:4px; text-align:right;" id="theo-otros">$0</td> -->
                    <!-- <td style="padding:4px; text-align:right; font-weight:bold;" id="diff-otros">$0</td> -->
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="small" id="arqueo-total">Total contado: $0</div>
            <div class="cash-row">
              <div class="small" style="font-weight:700;">Resumen de totales</div>
            </div>
            <div class="small" id="cash-session-sales">Ventas sesión: $0</div>
            <div class="small" id="cash-session-inout">Ingresos: $0 · Salidas: $0</div>
            <div class="small" id="cash-session-system">Sistema: $0</div>
            <div class="small" id="cash-session-counted">Contado: $0</div>
            <div class="small" id="cash-session-diff">Diferencia: $0</div>
            <div class="cash-row">
              <label style="display:flex; align-items:center; gap:8px;">
                <input id="arqueo-use-toggle" type="checkbox" ${(cashCloseDraft.useArqueo ? 'checked' : '')} /> Usar arqueo para monto de cierre
              </label>
            </div>
            <div class="cash-row">
              <label>Monto de cierre <input id="cash-close-amount" type="number" min="0" step="1" value="${(cashCloseDraft.amount !== undefined && cashCloseDraft.amount !== null) ? cashCloseDraft.amount : ''}" /></label>
            </div>
            <div class="cash-row">
              <textarea id="cash-close-notes" placeholder="Notas de cierre">${cashCloseDraft.notes || ''}</textarea>
            </div>
            <div class="cash-row">
              <button id="cash-close-btn">Cerrar caja</button>
            </div>
            <div id="cash-close-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1000;">
              <div id="cash-close-dialog" role="dialog" aria-modal="true" style="background:#fff; margin:10vh auto; max-width:540px; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2);">
              <div class="cash-title">Resumen de cierre</div>
                <div class="small" id="cash-close-review-count">Contado: $0</div>
                <div class="small" id="cash-close-review-sales-no-tip">Total sin propina: $0</div>
                <div class="small" id="cash-close-review-sales-with-tip">Total con propina: $0</div>
                <div class="small" id="cash-close-review-tip">Suma total de propina: $0</div>
                <div class="small" id="cash-close-review-shipping">Costo de envío: $0</div>
                <div class="small" id="cash-close-review-es">Entradas: $0 · Salidas: $0</div>
                <div class="small" id="cash-close-review-theo">Teórico del sistema: $0</div>
                <div class="small" id="cash-close-review-diff" style="font-weight:700;">Diferencia: $0</div>
                
                <div class="small" style="font-weight:700; margin-top:8px;">Desglose Teórico</div>
                <div id="cash-close-review-breakdown" style="display:grid; grid-template-columns: 1fr 1fr; gap:4px; font-size:0.9em; margin-bottom:8px;"></div>

                <div class="cash-row" style="display:flex; gap:8px; justify-content:flex-end;">
                  <button id="confirm-close">Confirmar cierre</button>
                  <button id="dismiss-close-modal" style="display:none;">Cerrar modal</button>
                </div>
                <div class="cash-row">
                  <div class="small" style="font-weight:700; margin-top:8px;">Pedidos entregados en la sesión</div>
                  <div id="close-orders" style="max-height:40vh; overflow:auto; border:1px solid #ddd;">
                    <table style="width:100%; border-collapse:collapse;">
                      <thead>
                        <tr style="background:#f5f5f5;">
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">ID</th>
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Creado</th>
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Método</th>
                          <th style="text-align:right; padding:6px; border-bottom:1px solid #ddd;">Total</th>
                        </tr>
                      </thead>
                      <tbody id="close-orders-body"></tbody>
                    </table>
                  </div>
                  <div class="small" id="close-orders-sum">Total pedidos en sesión: $0</div>
                </div>
                <div class="cash-row">
                  <div class="small" style="font-weight:700;">Ingresos y salidas de dinero</div>
                  <div class="small" id="close-mov-sums">Total ingresos: $0 · Total salidas: $0</div>
                  <div id="close-movements" style="max-height:40vh; overflow:auto; border:1px solid #ddd;">
                    <table style="width:100%; border-collapse:collapse;">
                      <thead>
                        <tr style="background:#f5f5f5;">
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Fecha</th>
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Tipo</th>
                          <th style="text-align:right; padding:6px; border-bottom:1px solid #ddd;">Monto</th>
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Nota</th>
                          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Actor</th>
                        </tr>
                      </thead>
                      <tbody id="close-movements-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div id="cash-movement-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1000;">
              <div role="dialog" aria-modal="true" style="background:#fff; margin:10vh auto; max-width:560px; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2);">
                <div class="cash-title">Nuevo movimiento de caja</div>
                <div class="cash-row" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px;">
                  <label>Tipo
                    <select id="cash-mov-type">
                      <option value="entrada">Entrada</option>
                      <option value="salida">Salida</option>
                    </select>
                  </label>
                  <label>Monto $ <input id="cash-mov-amount" type="number" min="1" step="1" /></label>
                </div>
                <div class="cash-row">
                  <textarea id="cash-mov-motive" placeholder="Motivo"></textarea>
                </div>
                <div class="cash-row">
                  <textarea id="cash-mov-detail" placeholder="Detalles"></textarea>
                </div>
                <div class="cash-row" style="display:flex; gap:8px; justify-content:flex-end;">
                  <button id="cash-mov-cancel">Cancelar</button>
                  <button id="cash-mov-submit">Registrar</button>
                </div>
              </div>
            </div>
            <div id="cash-mov-notify" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1000;">
              <div role="dialog" aria-modal="true" style="background:#fff; margin:20vh auto; max-width:420px; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2); text-align:center;">
                <div id="cash-mov-notify-text" class="small" style="margin-bottom:12px;">Movimiento registrado</div>
                <button id="cash-mov-notify-ok">Aceptar</button>
              </div>
            </div>
            </div>
          </div>
        `;
        const cbtn = document.getElementById('cash-close-btn');
        const reviewModal = document.getElementById('cash-close-modal');
        const cashEyeBtn = document.getElementById('cash-eye');
        const cashBodyEl = document.getElementById('cash-body');
        const CASH_BODY_VISIBLE_KEY = 'cash_body_visible';
        let cashBodyVisible = true;
        try { const v = localStorage.getItem(CASH_BODY_VISIBLE_KEY); if (v === '0') cashBodyVisible = false; } catch (_) {}
        function setCashBodyVisible(v){ cashBodyVisible = !!v; if (cashBodyEl) cashBodyEl.style.display = cashBodyVisible ? '' : 'none'; if (cashEyeBtn) cashEyeBtn.setAttribute('aria-label', cashBodyVisible ? 'Ocultar caja' : 'Mostrar caja'); if (cashEyeBtn) cashEyeBtn.innerHTML = cashBodyVisible ? '<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>' : '<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2.1 3.51 1 4.6l4.11 4.11C3.33 9.87 1.86 11.74 1 12c1.73 4.39 6 7.5 11 7.5 2.11 0 4.08-.51 5.82-1.41l3.58 3.58 1.11-1.09L2.1 3.51zM12 6.5c1.41 0 2.67.58 3.57 1.5l-1.06 1.06a3 3 0 0 0-4.1 4.1L9.35 14.2A5 5 0 0 1 12 6.5zm0 10.5a9.31 9.31 0 0 1-6.63-2.72c-.54-.54-.99-1.1-1.37-1.66l3.17-3.17 1.55 1.55a5 5 0 0 0 6.08 6.08l1.55 1.55A10.97 10.97 0 0 1 12 17z"/></svg>'; try { localStorage.setItem(CASH_BODY_VISIBLE_KEY, cashBodyVisible ? '1' : '0'); } catch (_) {} }
        setCashBodyVisible(cashBodyVisible);
        if (cashEyeBtn) cashEyeBtn.addEventListener('click', () => setCashBodyVisible(!cashBodyVisible));
        const reviewCount = document.getElementById('cash-close-review-count');
        const reviewTheo = document.getElementById('cash-close-review-theo');
        const reviewDiff = document.getElementById('cash-close-review-diff');
        const reviewSalesNoTip = document.getElementById('cash-close-review-sales-no-tip');
        const reviewSalesWithTip = document.getElementById('cash-close-review-sales-with-tip');
        const reviewShipping = document.getElementById('cash-close-review-shipping');
        const reviewEs = document.getElementById('cash-close-review-es');
        const reviewTip = document.getElementById('cash-close-review-tip');
        async function showCloseReview() {
          const v = parseInt(amtInput && amtInput.value || '0', 10) || 0;
          try {
            const latest = await fetchCashSession();
            const sum = latest && latest.summary ? latest.summary : {};
            const theo = Number(sum.theoretical_cash || 0);
            const sdelWithTip = Number(sum.delivered_total || 0);
            const sdelNoTip = Number(sum.base_delivered_total || 0);
            const sin = Number(sum.entradas || 0);
            const sout = Number(sum.salidas || 0);
            const stip = Number(sum.tip_total || 0);
            const sship = Number(sum.shipping_total || 0);
            if (reviewCount) reviewCount.textContent = `Contado: ${formatMoney(v)}`;
            if (reviewTheo) reviewTheo.textContent = `Teórico del sistema: ${formatMoney(theo)}`;
            if (reviewDiff) reviewDiff.textContent = `Diferencia: ${formatMoney(v - theo)}`;
            if (reviewSalesNoTip) reviewSalesNoTip.textContent = `Total sin propina: ${formatMoney(sdelNoTip)}`;
            if (reviewSalesWithTip) reviewSalesWithTip.textContent = `Total con propina: ${formatMoney(sdelWithTip)}`;
            if (reviewShipping) reviewShipping.textContent = `Costo de envío: ${formatMoney(sship)}`;
            if (reviewEs) reviewEs.textContent = `Entradas: ${formatMoney(sin)} · Salidas: ${formatMoney(sout)}`;
            if (reviewTip) reviewTip.textContent = `Suma total de propina: ${formatMoney(stip)}`;
            
            const breakdown = sum.theoretical_breakdown || { efectivo: 0, pos: 0, transferencia: 0, otros: 0 };
            const bdEl = document.getElementById('cash-close-review-breakdown');
            
            // Get user inputs
            const uEf = parseInt(efInput && efInput.value || '0', 10) || 0;
            const uPos = parseInt(posInput && posInput.value || '0', 10) || 0;
            const uTrans = parseInt(transInput && transInput.value || '0', 10) || 0;
            const uOtros = parseInt(otrosInput && otrosInput.value || '0', 10) || 0;

            const dEf = uEf - breakdown.efectivo;
            const dPos = uPos - breakdown.pos;
            const dTrans = uTrans - breakdown.transferencia;
            const dOtros = uOtros - breakdown.otros;

            if (bdEl) {
                bdEl.innerHTML = `
                    <div style="grid-column: 1 / -1; margin-bottom: 8px;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.95em;">
                            <thead>
                                <tr style="border-bottom: 2px solid #eee;">
                                    <th style="text-align:left; padding:4px;">Método</th>
                                    <th style="text-align:right; padding:4px;">Teórico</th>
                                    <th style="text-align:right; padding:4px;">Declarado</th>
                                    <th style="text-align:right; padding:4px;">Diferencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding:4px;">Efectivo</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(breakdown.efectivo)}</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(uEf)}</td>
                                    <td style="text-align:right; padding:4px; font-weight:bold; color:${dEf === 0 ? 'inherit' : (dEf > 0 ? 'green' : 'red')}">${formatMoney(dEf)}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">POS/QR</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(breakdown.pos)}</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(uPos)}</td>
                                    <td style="text-align:right; padding:4px; font-weight:bold; color:${dPos === 0 ? 'inherit' : (dPos > 0 ? 'green' : 'red')}">${formatMoney(dPos)}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">Transferencia</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(breakdown.transferencia)}</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(uTrans)}</td>
                                    <td style="text-align:right; padding:4px; font-weight:bold; color:${dTrans === 0 ? 'inherit' : (dTrans > 0 ? 'green' : 'red')}">${formatMoney(dTrans)}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">Otros</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(breakdown.otros)}</td>
                                    <td style="text-align:right; padding:4px;">${formatMoney(uOtros)}</td>
                                    <td style="text-align:right; padding:4px; font-weight:bold; color:${dOtros === 0 ? 'inherit' : (dOtros > 0 ? 'green' : 'red')}">${formatMoney(dOtros)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            cashKeepModalOpen = true;
            isCashEditing = true;
            try {
              const slug = tenantInput.value.trim() || defaultSlug();
              const sessId = latest && latest.session && latest.session.id;
              const nowIso = new Date().toISOString();
              const url = new URL('/api/cash/session/orders', API_BASE);
              url.searchParams.set('tenant_slug', slug);
              if (sessId) url.searchParams.set('session_id', String(sessId));
              url.searchParams.set('to', nowIso);
              const resp = await wFetch(url.toString());
              if (resp && resp.ok) {
                const payload = await resp.json();
                const rows = Array.isArray(payload.orders) ? payload.orders : [];
                const body = document.getElementById('close-orders-body');
                const sumEl = document.getElementById('close-orders-sum');
                if (body) {
                  body.innerHTML = rows.map(r => `
                    <tr>
                      <td style="padding:6px; border-bottom:1px solid #eee;">${r.id}</td>
                      <td style="padding:6px; border-bottom:1px solid #eee;">${formatARDate(r.created_at || '')}</td>
                      <td style="padding:6px; border-bottom:1px solid #eee;">${r.payment_method || '-'}</td>
                      <td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">$${r.total || 0}</td>
                    </tr>
                  `).join('');
                }
                try { if (sumEl) { const total = rows.reduce((a,b)=>a+Number(b.total||0),0); sumEl.textContent = `Total pedidos en sesión: ${formatMoney(total)}`; } } catch(_){ }
              }
            } catch (_) {}
            [efInput, posInput, transInput, otrosInput, useToggle, amtInput, noteClose].forEach(el => { try { if (el) el.disabled = true; } catch(_){} });
            if (reviewModal) reviewModal.style.display = 'block';
          } catch (_) {
            if (reviewCount) reviewCount.textContent = `Contado: $${v}`;
            if (reviewTheo) reviewTheo.textContent = `Teórico del sistema: (no disponible)`;
            if (reviewDiff) reviewDiff.textContent = `Diferencia: (no disponible)`;
            cashKeepModalOpen = true;
            isCashEditing = true;
            if (reviewModal) reviewModal.style.display = 'block';
          }
        }
        if (cbtn) cbtn.onclick = async () => { await showCloseReview(); };
        const confirmBtn = document.getElementById('confirm-close');
        const dismissBtn = document.getElementById('dismiss-close-modal');
        if (confirmBtn) confirmBtn.onclick = async () => {
          confirmBtn.disabled = true;
          try {
            const res = await closeCash();
            if (res && res.summary) {
              const s = res.summary;
              const salesNoTipEl = document.getElementById('cash-close-review-sales-no-tip');
              const salesWithTipEl = document.getElementById('cash-close-review-sales-with-tip');
              const shippingEl = document.getElementById('cash-close-review-shipping');
              const tipEl = document.getElementById('cash-close-review-tip');
              const esEl = document.getElementById('cash-close-review-es');
              const theoEl = document.getElementById('cash-close-review-theo');
              const diffEl = document.getElementById('cash-close-review-diff');
              if (salesNoTipEl) salesNoTipEl.textContent = `Total sin propina: ${formatMoney(Number(s.base_delivered_total||0))}`;
              if (salesWithTipEl) salesWithTipEl.textContent = `Total con propina: ${formatMoney(Number(s.delivered_total||0))}`;
              if (shippingEl) shippingEl.textContent = `Costo de envío: ${formatMoney(Number(s.shipping_total||0))}`;
              if (tipEl) tipEl.textContent = `Suma total de propina: ${formatMoney(Number(s.tip_total||0))}`;
              if (esEl) esEl.textContent = `Entradas: ${formatMoney(Number(s.entradas||0))} · Salidas: ${formatMoney(Number(s.salidas||0))}`;
              if (theoEl) theoEl.textContent = `Teórico del sistema: ${formatMoney(Number(s.theoretical_cash||0))}`;
              const v = parseInt(document.getElementById('cash-close-amount').value||'0',10)||0;
              if (diffEl) diffEl.textContent = `Diferencia: ${formatMoney(Number(s.closing_diff|| (v - Number(s.theoretical_cash||0))))}`;
              try {
                const slug = tenantInput.value.trim() || defaultSlug();
                const urlMov = new URL('/api/cash/movements', API_BASE);
                urlMov.searchParams.set('tenant_slug', slug);
                urlMov.searchParams.set('session_id', String(res.session_id||''));
                const mresp = await wFetch(urlMov.toString());
                if (mresp && mresp.ok) {
                  const mp = await mresp.json();
                  let movs = Array.isArray(mp.movements) ? mp.movements : [];
                  if (!movs || movs.length === 0) {
                    const urlMovRange = new URL('/api/cash/movements', API_BASE);
                    urlMovRange.searchParams.set('tenant_slug', slug);
                    const openedAt = res && res.opened_at || '';
                    if (openedAt) urlMovRange.searchParams.set('from', openedAt);
                    if (res.closed_at) urlMovRange.searchParams.set('to', res.closed_at);
                    const r2 = await wFetch(urlMovRange.toString());
                    if (r2 && r2.ok) {
                      const mp2 = await r2.json();
                      movs = Array.isArray(mp2.movements) ? mp2.movements : [];
                    }
                  }
                  const body = document.getElementById('close-movements-body');
                  const sums = document.getElementById('close-mov-sums');
                  let inSum = 0, outSum = 0;
                  
                  // Filter manual movements
                  const manualMovs = movs.filter(m => !(m.note||'').toLowerCase().includes('cobro pedido'));

                  if (body) {
                    body.innerHTML = manualMovs.map(m => {
                      const isIn = m.type==='entrada';
                      const label = isIn ? 'Ingreso' : 'Salida';
                      const sign = isIn ? '+' : '-';
                      const amt = Number(m.amount||0);
                      if (isIn) inSum += amt; else outSum += amt;
                      return `<tr><td style="padding:6px; border-bottom:1px solid #eee;">${formatARDate(m.created_at||'')}</td><td style="padding:6px; border-bottom:1px solid #eee;">${label}</td><td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">${sign}$${amt}</td><td style="padding:6px; border-bottom:1px solid #eee;">${m.note||''}</td><td style="padding:6px; border-bottom:1px solid #eee;">${m.actor||''}</td></tr>`;
                    }).join('');
                  }
                  if (sums) sums.textContent = `Total ingresos: ${formatMoney(inSum)} · Total salidas: ${formatMoney(outSum)}`;
                }
                // Actualizar listado de pedidos entregados a la sesión cerrada
                try {
                  const ordersUrl = new URL('/api/cash/session/orders', API_BASE);
                  ordersUrl.searchParams.set('tenant_slug', slug);
                  ordersUrl.searchParams.set('session_id', String(res.session_id||''));
                  if (res.closed_at) ordersUrl.searchParams.set('to', res.closed_at);
                  const oresp = await wFetch(ordersUrl.toString());
                  if (oresp && oresp.ok) {
                    const op = await oresp.json();
                    const rows = Array.isArray(op.orders) ? op.orders : [];
                    const body = document.getElementById('close-orders-body');
                    const sumEl = document.getElementById('close-orders-sum');
                    if (body) {
                      body.innerHTML = rows.map(r => `
                        <tr>
                          <td style="padding:6px; border-bottom:1px solid #eee;">${r.id}</td>
                          <td style="padding:6px; border-bottom:1px solid #eee;">${formatARDate(r.created_at || '')}</td>
                          <td style="padding:6px; border-bottom:1px solid #eee;">${r.payment_method || '-'}</td>
                          <td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">$${r.total || 0}</td>
                        </tr>
                      `).join('');
                    }
                    try {
                      const total = rows.reduce((a,b)=>a+Number(b.total||0),0);
                      if (sumEl) sumEl.textContent = `Total pedidos en sesión: ${formatMoney(total)}`;
                      const salesEl = document.getElementById('cash-close-review-sales');
                      if (salesEl) salesEl.textContent = `Total ventas: ${formatMoney(total)}`;
                    } catch(_) {}
                  }
                } catch(_) {}
              } catch(_) {}
              confirmBtn.textContent = 'Caja cerrada';
              confirmBtn.disabled = true;
              if (dismissBtn) dismissBtn.style.display = 'inline-block';
            }
          } finally {}
        };
        if (dismissBtn) dismissBtn.onclick = () => {
          if (reviewModal) reviewModal.style.display = 'none';
          cashKeepModalOpen = false;
          isCashEditing = false;
          renderCashBox();
        };
        const amtInput = document.getElementById('cash-close-amount');
        const noteClose = document.getElementById('cash-close-notes');
        const movBtn = document.getElementById('cash-movement-btn');
        const movModal = document.getElementById('cash-movement-modal');
        const movNotify = document.getElementById('cash-mov-notify');
        const movNotifyText = document.getElementById('cash-mov-notify-text');
        const movNotifyOk = document.getElementById('cash-mov-notify-ok');
        const movType = document.getElementById('cash-mov-type');
        const movAmount = document.getElementById('cash-mov-amount');
        const movMotive = document.getElementById('cash-mov-motive');
        const movDetail = document.getElementById('cash-mov-detail');
        const movCancel = document.getElementById('cash-mov-cancel');
        const movSubmit = document.getElementById('cash-mov-submit');
        function openMovModal() {
          if (movModal) {
            movType.value = 'entrada';
            movAmount.value = '';
            movMotive.value = '';
            movDetail.value = '';
            movModal.style.display = 'block';
            isCashEditing = true;
          }
        }
        async function registerMovement() {
          try { await ensureAuth(); } catch(_) {}
          if (!isAuthed || !csrfToken) { alert('Debes iniciar sesión'); return; }
          const t = (movType && movType.value) || 'entrada';
          const amt = parseInt((movAmount && movAmount.value) || '0', 10) || 0;
          const motive = (movMotive && movMotive.value || '').trim();
          const detail = (movDetail && movDetail.value || '').trim();
          if (amt <= 0) { alert('Monto inválido'); return; }
          const slug = tenantInput.value.trim() || defaultSlug();
          const note = [motive ? `Motivo: ${motive}` : '', detail ? `Detalle: ${detail}` : ''].filter(Boolean).join(' · ');
          const resp = await fetch(new URL('/api/cash/movement', API_BASE).toString(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ tenant_slug: slug, type: t, amount: amt, note })
          });
          if (!resp.ok) { try { const e = await resp.json(); alert(String(e.error||'No se pudo registrar')); } catch(_) { alert('No se pudo registrar'); } return; }
          if (movModal) movModal.style.display = 'none';
          const verb = t === 'entrada' ? 'ingresó' : 'retiró';
          if (movNotifyText) movNotifyText.textContent = `Se ${verb} a tu caja ${formatMoney(amt)}`;
          if (movNotify) movNotify.style.display = 'block';
          const afterOk = async () => {
            if (movNotify) movNotify.style.display = 'none';
            isCashEditing = false;
            await renderCashBox();
            await renderCashHistory();
          };
          if (movNotifyOk) {
            movNotifyOk.onclick = () => { afterOk(); };
          } else {
            await afterOk();
          }
        }
        if (movBtn) movBtn.onclick = openMovModal;
        if (movCancel) movCancel.onclick = () => { if (movModal) movModal.style.display = 'none'; isCashEditing = false; };
        if (movSubmit) movSubmit.onclick = async () => { movSubmit.disabled = true; try { await registerMovement(); } finally { movSubmit.disabled = false; } };
        if (amtInput) {
          const syncAmount = () => {
            const v = parseInt(amtInput.value||'0',10)||0;
            cashCloseDraft.amount = v;
          };
          amtInput.addEventListener('input', syncAmount);
          amtInput.addEventListener('focus', () => { isCashEditing = true; });
          amtInput.addEventListener('blur', () => { setTimeout(() => { const ae = document.activeElement; isCashEditing = ['cash-open-amount','cash-open-notes','cash-close-amount','cash-close-notes'].includes(ae && ae.id); }, 10); });
          syncAmount();
        }
        cashCloseDraft.methods = cashCloseDraft.methods || { efectivo: 0, pos: 0, trans: 0, otros: 0 };
        const efInput = document.getElementById('arqueo-efectivo');
        const posInput = document.getElementById('arqueo-pos');
        const transInput = document.getElementById('arqueo-trans');
        const otrosInput = document.getElementById('arqueo-otros');
        const totalEl = document.getElementById('arqueo-total');
        const useToggle = document.getElementById('arqueo-use-toggle');
        function computeArqueo() {
          const efectivo = parseInt(efInput && efInput.value || '0', 10) || 0;
          const pos = parseInt(posInput && posInput.value || '0', 10) || 0;
          const trans = parseInt(transInput && transInput.value || '0', 10) || 0;
          const otros = parseInt(otrosInput && otrosInput.value || '0', 10) || 0;
          cashCloseDraft.methods.efectivo = efectivo;
          cashCloseDraft.methods.pos = pos;
          cashCloseDraft.methods.trans = trans;
          cashCloseDraft.methods.otros = otros;
          const total = efectivo + pos + trans + otros;
          if (totalEl) totalEl.textContent = `Total contado: ${formatMoney(total)}`;
          const use = !!(useToggle && useToggle.checked);
          cashCloseDraft.useArqueo = use;
          if (use && amtInput) { amtInput.value = String(total); const event = new Event('input'); amtInput.dispatchEvent(event); }
        }
        if (efInput) efInput.addEventListener('input', computeArqueo);
        if (posInput) posInput.addEventListener('input', computeArqueo);
        if (transInput) transInput.addEventListener('input', computeArqueo);
        if (otrosInput) otrosInput.addEventListener('input', computeArqueo);
        if (useToggle) useToggle.addEventListener('change', computeArqueo);
        computeArqueo();
        if (noteClose) {
          noteClose.addEventListener('input', () => { cashCloseDraft.notes = String(noteClose.value||''); });
          noteClose.addEventListener('focus', () => { isCashEditing = true; });
          noteClose.addEventListener('blur', () => { setTimeout(() => { const ae = document.activeElement; isCashEditing = ['cash-open-amount','cash-open-notes','cash-close-amount','cash-close-notes'].includes(ae && ae.id); }, 10); });
        }
      } catch (_) {}
    }

    async function fetchCashSessions() {
      const slug = tenantInput.value.trim() || defaultSlug();
      const url = new URL('/api/cash/sessions', API_BASE);
      url.searchParams.set('tenant_slug', slug);
      url.searchParams.set('limit', '50');
      url.searchParams.set('offset', '0');
      const resp = await wFetch(url.toString());
      if (!resp.ok) return { sessions: [] };
      return resp.json();
    }
    async function renderCashHistory() {
      if (cashHistoryCollapsed) return;
      const box = document.getElementById('cash-history');
      if (!box) return;
      const data = await fetchCashSessions();
      const allRows = Array.isArray(data.sessions) ? data.sessions : [];
      const latestRows = allRows.slice(0, 10);
      const prevRows = allRows.slice(10);
      let html = '<div class="history-card"><div class="history-actions"><div class="cash-title" style="display:flex; align-items:center; justify-content:space-between;"><span>Historial de cierres</span><button id="history-eye" class="eye-btn" aria-label="Ocultar historial"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg></button></div><div style="display:flex; gap:8px; align-items:center;"><button id="cash-history-export">Exportar CSV</button>' + (prevRows.length ? `<button id="cash-history-toggle-prev">Mostrar anteriores (${prevRows.length})</button>` : '') + '</div></div>';
      html += '<div id="cash-history-body"><table class="history-table"><thead><tr><th>Apertura</th><th>Cierre</th><th>Inicial</th><th>Contado</th><th>Ventas</th><th>Entradas</th><th>Salidas</th><th>Teórica</th><th>Diferencia</th><th>Cerró</th><th>Acciones</th></tr></thead><tbody id="history-latest-body">';
      for (const s of latestRows) {
        const sum = s.summary || {};
        html += `<tr>
          <td>${formatARDate(s.opened_at||'')}</td>
          <td>${formatARDate(s.closed_at||'')}</td>
          <td>$${s.opening_amount||0}</td>
          <td>$${s.closing_amount||0}</td>
          <td>$${sum.delivered_total||0}</td>
          <td>$${sum.entradas||0}</td>
          <td>$${sum.salidas||0}</td>
          <td>$${sum.theoretical_cash||0}</td>
          <td>$${sum.closing_diff||0}</td>
          <td>${s.closed_by||''}</td>
          <td>
            <button class="hist-view" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-sales="${sum.delivered_total||0}" data-in="${sum.entradas||0}" data-out="${sum.salidas||0}" data-theo="${sum.theoretical_cash||0}" data-diff="${sum.closing_diff||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">
              Ver
            </button>
            <button class="hist-pdf" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">
              PDF
            </button>
          </td>
        </tr>`;
      }
      html += '</tbody>';
      if (prevRows.length) {
        html += '<tbody id="history-prev-body" style="display:none;">';
        for (const s of prevRows) {
          const sum = s.summary || {};
          html += `<tr>
            <td>${formatARDate(s.opened_at||'')}</td>
            <td>${formatARDate(s.closed_at||'')}</td>
            <td>$${s.opening_amount||0}</td>
            <td>$${s.closing_amount||0}</td>
            <td>$${sum.delivered_total||0}</td>
            <td>$${sum.entradas||0}</td>
            <td>$${sum.salidas||0}</td>
            <td>$${sum.theoretical_cash||0}</td>
            <td>$${sum.closing_diff||0}</td>
            <td>${s.closed_by||''}</td>
            <td>
              <button class="hist-view" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-sales="${sum.delivered_total||0}" data-in="${sum.entradas||0}" data-out="${sum.salidas||0}" data-theo="${sum.theoretical_cash||0}" data-diff="${sum.closing_diff||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">Ver</button>
              <button class="hist-pdf" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">PDF</button>
            </td>
          </tr>`;
        }
        html += '</tbody>';
      }
      html += '</table><div class="history-mobile">';
      for (const s of latestRows) {
        const sum = s.summary || {};
        html += `
          <div class="hm-row">
            <div class="hm-header">${formatARDate(s.opened_at||'')} → ${formatARDate(s.closed_at||'')}</div>
            <div class="hm-meta">Cerró: ${s.closed_by||''}</div>
            <div class="hm-metrics">
              <div class="item">Inicial: $${s.opening_amount||0}</div>
              <div class="item">Contado: $${s.closing_amount||0}</div>
              <div class="item">Ventas: $${sum.delivered_total||0}</div>
              <div class="item">Entradas: $${sum.entradas||0}</div>
              <div class="item">Salidas: $${sum.salidas||0}</div>
              <div class="item">Teórica: $${sum.theoretical_cash||0}</div>
              <div class="item">Dif.: $${sum.closing_diff||0}</div>
            </div>
            <div class="hm-actions">
              <button class="hist-view" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-sales="${sum.delivered_total||0}" data-in="${sum.entradas||0}" data-out="${sum.salidas||0}" data-theo="${sum.theoretical_cash||0}" data-diff="${sum.closing_diff||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">Ver</button>
              <button class="hist-pdf" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">PDF</button>
            </div>
          </div>
        `;
      }
      if (prevRows.length) {
        html += `<div id="history-mobile-prev" style="display:none;">`;
        for (const s of prevRows) {
          const sum = s.summary || {};
          html += `
            <div class="hm-row">
              <div class="hm-header">${formatARDate(s.opened_at||'')} → ${formatARDate(s.closed_at||'')}</div>
              <div class="hm-meta">Cerró: ${s.closed_by||''}</div>
              <div class="hm-metrics">
                <div class="item">Inicial: $${s.opening_amount||0}</div>
                <div class="item">Contado: $${s.closing_amount||0}</div>
                <div class="item">Ventas: $${sum.delivered_total||0}</div>
                <div class="item">Entradas: $${sum.entradas||0}</div>
                <div class="item">Salidas: $${sum.salidas||0}</div>
                <div class="item">Teórica: $${sum.theoretical_cash||0}</div>
                <div class="item">Dif.: $${sum.closing_diff||0}</div>
              </div>
              <div class="hm-actions">
                <button class="hist-view" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-sales="${sum.delivered_total||0}" data-in="${sum.entradas||0}" data-out="${sum.salidas||0}" data-theo="${sum.theoretical_cash||0}" data-diff="${sum.closing_diff||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">Ver</button>
                <button class="hist-pdf" data-sid="${s.id}" data-opened="${s.opened_at||''}" data-closed="${s.closed_at||''}" data-note-open="${(s.notes_open||'').replace(/"/g,'&quot;')}" data-note-close="${(s.notes_close||'').replace(/"/g,'&quot;')}" data-open-amt="${s.opening_amount||0}" data-close-amt="${s.closing_amount||0}" data-tip="${sum.tip_total||0}" data-base="${sum.base_delivered_total||0}" data-ship="${sum.shipping_total||0}" data-metadata="${(s.closing_metadata||'').replace(/"/g,'&quot;')}">PDF</button>
              </div>
            </div>
          `;
        }
        html += `</div>`;
      }
      html += '</div></div></div>';
      box.innerHTML = html;
      const exp = document.getElementById('cash-history-export');
      if (exp) exp.onclick = () => {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/cash/sessions/export.csv', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        // Export completo por defecto; puedes ajustar filtros propios aquí si se desea
        window.open(url.toString(), '_blank');
      };
      const togglePrev = document.getElementById('cash-history-toggle-prev');
      if (togglePrev) {
        togglePrev.onclick = () => {
          const tbPrev = document.getElementById('history-prev-body');
          const mobPrev = document.getElementById('history-mobile-prev');
          const isHidden = tbPrev && tbPrev.style.display === 'none';
          if (tbPrev) tbPrev.style.display = isHidden ? '' : 'none';
          if (mobPrev) mobPrev.style.display = isHidden ? '' : 'none';
          togglePrev.textContent = isHidden ? 'Ocultar anteriores' : `Mostrar anteriores (${prevRows.length})`;
        };
      }
      const attach = async (sid, opened, closed, mode, noteOpen, noteClose, openAmtStr, closeAmtStr, tipTotalStr, baseSalesStr, shippingTotalStr, metadataStr) => {
        try {
          const slug = tenantInput.value.trim() || defaultSlug();
          const metadata = (() => { try { return JSON.parse(metadataStr||'{}'); } catch(e){ return {}; } })();
          const declared = metadata.declared_breakdown || {};

          const urlOrd = new URL('/api/cash/session/orders', API_BASE);
          urlOrd.searchParams.set('tenant_slug', slug);
          urlOrd.searchParams.set('session_id', String(sid||''));
          if (closed) urlOrd.searchParams.set('to', closed);
          const urlMov = new URL('/api/cash/movements', API_BASE);
          urlMov.searchParams.set('tenant_slug', slug);
          urlMov.searchParams.set('session_id', String(sid));
          const [ordResp, movResp] = await Promise.all([wFetch(urlOrd.toString()), wFetch(urlMov.toString())]);
          const ordersPayload = ordResp && ordResp.ok ? await ordResp.json() : { orders: [] };
          let movPayload = movResp && movResp.ok ? await movResp.json() : { movements: [] };
          if (!movPayload.movements || movPayload.movements.length === 0) {
            const urlMovRange = new URL('/api/cash/movements', API_BASE);
            urlMovRange.searchParams.set('tenant_slug', slug);
            if (opened) urlMovRange.searchParams.set('from', opened);
            if (closed) urlMovRange.searchParams.set('to', closed);
            const movRangeResp = await wFetch(urlMovRange.toString());
            if (movRangeResp && movRangeResp.ok) movPayload = await movRangeResp.json();
          }
          const orders = Array.isArray(ordersPayload.orders) ? ordersPayload.orders : [];
          const movements = Array.isArray(movPayload.movements) ? movPayload.movements : [];

          const sumEntradas = movements.reduce((a,m)=>a + (m.type==='entrada' || m.type==='ingreso' ? Number(m.amount||0) : 0), 0);
          const sumSalidas = movements.reduce((a,m)=>a + (m.type==='salida' ? Number(m.amount||0) : 0), 0);
          const sumOrders = orders.reduce((a,r)=>a + Number(r.total||0), 0);
          const openAmt = parseInt(openAmtStr||'0',10)||0;
          const declaredTotal = (Number(declared.efectivo)||0) + (Number(declared.pos)||0) + (Number(declared.transferencia)||0) + (Number(declared.otros)||0);
          const rawCloseAmt = parseInt(closeAmtStr||'0',10)||0;
          const closeAmt = (rawCloseAmt === 0 && declaredTotal !== 0) ? declaredTotal : rawCloseAmt;
          const tipTotal = parseInt(tipTotalStr||'0',10)||0;
          const shippingTotal = parseInt(shippingTotalStr||'0',10)||0;
          const baseSales = parseInt(baseSalesStr||'0',10)||0;
          const systemTotal = openAmt + sumEntradas - sumSalidas;
          const diffTotal = closeAmt - systemTotal;
          
          const breakdown = { efectivo: openAmt, pos: 0, transferencia: 0, otros: 0 };
          movements.forEach(m => {
              const mt = (m.type||'').toLowerCase();
              const note = (m.note||'').toLowerCase();
              const pm = (m.payment_method||'').toLowerCase();
              const amt = Number(m.amount||0);
              let method = 'efectivo';
              if (pm) {
                   if (pm.includes('pos') || pm.includes('qr') || pm.includes('tarjeta')) method = 'pos';
                   else if (pm.includes('transferencia')) method = 'transferencia';
                   else if (pm.includes('otros')) method = 'otros';
              } else {
                   if (note.includes('pos') || note.includes('qr')) method = 'pos';
                   else if (note.includes('transferencia')) method = 'transferencia';
              }
              if (mt === 'entrada' || mt === 'ingreso') {
                  if (method === 'pos') breakdown.pos += amt;
                  else if (method === 'transferencia') breakdown.transferencia += amt;
                  else if (method === 'otros') breakdown.otros += amt;
                  else breakdown.efectivo += amt;
              } else if (mt === 'salida') {
                  if (method === 'pos') breakdown.pos -= amt;
                  else if (method === 'transferencia') breakdown.transferencia -= amt;
                  else if (method === 'otros') breakdown.otros -= amt;
                  else breakdown.efectivo -= amt;
              }
          });
          const manualMovs = movements.filter(m => !(m.note||'').toLowerCase().includes('cobro pedido'));
          const sumManualIn = manualMovs.reduce((a,m)=>a + ((m.type==='entrada' || m.type==='ingreso') ? Number(m.amount||0) : 0), 0);
          const sumManualOut = manualMovs.reduce((a,m)=>a + (m.type==='salida' ? Number(m.amount||0) : 0), 0);

          if (mode === 'view') {
            const modal = document.createElement('div');
            modal.id = 'history-detail-modal';
            modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1000; display:flex; align-items:center; justify-content:center;';
            const dialog = document.createElement('div');
            dialog.role = 'dialog';
            dialog.setAttribute('aria-modal','true');
            dialog.style.cssText = 'background:#fff; width:90%; max-width:720px; max-height:90vh; overflow-y:auto; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2); position:relative;';

            dialog.innerHTML = `
              <div class="cash-title">Detalle de cierre</div>
              <div class="small">Apertura: ${formatARDate(opened||'')} · Cierre: ${formatARDate(closed||'')}</div>
              <div class="small">Notas (apertura): ${noteOpen||''}</div>
              <div class="small">Notas (cierre): ${noteClose||''}</div>
              <div class="small">Resumen</div>
              <div class="small">Apertura: ${formatMoney(openAmt)}</div>
              <div class="small">Ventas sesión: ${formatMoney(sumOrders)}</div>
              <div class="small" style="color:#666;">(Sin propina: ${formatMoney(baseSales)} · Propinas: ${formatMoney(tipTotal)} · Envíos: ${formatMoney(shippingTotal)})</div>
              <div class="small">Ingresos: ${formatMoney(sumEntradas)} · Salidas: ${formatMoney(sumSalidas)}</div>
              <div class="small">Sistema: ${formatMoney(systemTotal)}</div>
              <div class="small">Contado: ${formatMoney(closeAmt)}</div>
              <div class="small">Diferencia: ${formatMoney(diffTotal)}</div>
              
              <div class="small" style="font-weight:700; margin-top:8px;">Desglose y Diferencias</div>
              <div style="margin-bottom:8px; border:1px solid #ddd; border-radius:4px; overflow:hidden;">
                <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                  <thead style="background:#f5f5f5;">
                    <tr>
                      <th style="text-align:left; padding:6px;">Método</th>
                      <th style="text-align:right; padding:6px;">Teórico</th>
                      <th style="text-align:right; padding:6px;">Contado</th>
                      <th style="text-align:right; padding:6px;">Diferencia</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${['efectivo','pos','transferencia','otros'].map(k => {
                       const theo = breakdown[k] || 0;
                       const decl = declared[k] || 0;
                       const diff = decl - theo;
                       const color = diff === 0 ? 'green' : (diff > 0 ? 'green' : 'red');
                       const label = k.charAt(0).toUpperCase() + k.slice(1);
                       const displayLabel = k==='pos' ? 'POS/QR' : (k==='transferencia' ? 'Transf.' : label);
                       return `<tr>
                         <td style="padding:6px; border-bottom:1px solid #eee;">${displayLabel}</td>
                         <td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">${formatMoney(theo)}</td>
                         <td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">${formatMoney(decl)}</td>
                         <td style="padding:6px; border-bottom:1px solid #eee; text-align:right; color:${color}; font-weight:bold;">${formatMoney(diff)}</td>
                       </tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>

              <div class="small" style="font-weight:700; margin-top:8px;">Pedidos entregados</div>
              <div style="max-height:30vh; overflow:auto; border:1px solid #ddd; margin-bottom:8px;">
                <table style="width:100%; border-collapse:collapse;">
                  <thead><tr style="background:#f5f5f5;"><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">ID</th><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Creado</th><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Método</th><th style="text-align:right; padding:6px; border-bottom:1px solid #ddd;">Total</th></tr></thead>
                  <tbody>
                    ${orders.map(r => `<tr><td style="padding:6px; border-bottom:1px solid #eee;">${r.id}</td><td style="padding:6px; border-bottom:1px solid #eee;">${formatARDate(r.created_at||'')}</td><td style="padding:6px; border-bottom:1px solid #eee;">${r.payment_method||'-'}</td><td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">$${r.total||0}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
              <div class="small" style="font-weight:700;">Ingresos y salidas de dinero</div>
              <div class="small">Total ingresos: $${sumManualIn} · Total salidas: $${sumManualOut}</div>
              <div style="max-height:30vh; overflow:auto; border:1px solid #ddd;">
                <table style="width:100%; border-collapse:collapse;">
                  <thead><tr style="background:#f5f5f5;"><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Fecha</th><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:right; padding:6px; border-bottom:1px solid #ddd;">Monto</th><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Nota</th><th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Actor</th></tr></thead>
                  <tbody>
                    ${manualMovs.map(m => {
                      const isIn = m.type==='entrada' || m.type==='ingreso';
                      const label = isIn ? 'Ingreso' : 'Salida';
                      const sign = isIn ? '+' : '-';
                      const amt = Number(m.amount||0);
                      return `<tr><td style="padding:6px; border-bottom:1px solid #eee;">${formatARDate(m.created_at||'')}</td><td style="padding:6px; border-bottom:1px solid #eee;">${label}</td><td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">${sign}$${amt}</td><td style="padding:6px; border-bottom:1px solid #eee;">${m.note||''}</td><td style="padding:6px; border-bottom:1px solid #eee;">${m.actor||''}</td></tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              <div class="cash-row" style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                <button id="hist-close-modal">Cerrar</button>
              </div>
            `;
            dialog.setAttribute('data-open-amt', String(openAmt));
            dialog.setAttribute('data-close-amt', String(closeAmt));
            modal.appendChild(dialog);
            document.body.appendChild(modal);

            const cleanup = () => {
              try { document.body.removeChild(modal); } catch(_) {}
              document.removeEventListener('keydown', onKey);
            };
            const onKey = (e) => { if (e.key === 'Escape') cleanup(); };
            document.addEventListener('keydown', onKey);

            const closeBtn = document.getElementById('hist-close-modal');
            if (closeBtn) closeBtn.onclick = cleanup;
            modal.onclick = (e) => { if (e.target === modal) cleanup(); };

          } else if (mode === 'pdf') {
            const w = window.open('', '_blank');
            if (!w) return;
            
            const fmt = (n) => {
              try { return '$' + new Intl.NumberFormat('es-AR').format(Number(n||0)); } catch(_) { return '$' + Number(n||0); }
            };
            const doc = `<!doctype html><html><head><meta charset="utf-8"><title>Cierre #${sid}</title><style>body{font-family:system-ui,Segoe UI,Arial,sans-serif;padding:16px} h1{font-size:18px;margin:0 0 8px} table{width:100%;border-collapse:collapse} th,td{padding:6px;border-bottom:1px solid #ddd} th{background:#f5f5f5;text-align:left} .section{margin-top:12px}</style></head><body>
              <h1>Detalle de cierre #${sid}</h1>
              <div>Tenant: ${slug}</div>
              <div>Rango: ${formatARDate(opened||'')} → ${formatARDate(closed||'')}</div>
              <div>Notas (apertura): ${noteOpen||''}</div>
              <div>Notas (cierre): ${noteClose||''}</div>
              <div class="section"><strong>Resumen</strong>
                <div>Apertura: ${fmt(openAmt)}</div>
                <div>Ventas sesión: ${fmt(sumOrders)}</div>
                <div style="color:#666;">(Sin propina: ${fmt(baseSales)} · Propinas: ${fmt(tipTotal)} · Envíos: ${fmt(shippingTotal)})</div>
                <div>Ingresos: ${fmt(sumEntradas)} · Salidas: ${fmt(sumSalidas)}</div>
                <div>Sistema: ${fmt(systemTotal)}</div>
                <div>Contado: ${fmt(closeAmt)}</div>
                <div>Diferencia: ${fmt(diffTotal)}</div>
              </div>
              <div class="section"><strong>Desglose y Diferencias</strong>
                <table>
                  <thead><tr><th>Método</th><th style="text-align:right;">Teórico</th><th style="text-align:right;">Contado</th><th style="text-align:right;">Diferencia</th></tr></thead>
                  <tbody>
                    ${['efectivo','pos','transferencia','otros'].map(k => {
                       const theo = breakdown[k] || 0;
                       const decl = declared[k] || 0;
                       const diff = decl - theo;
                       const label = k.charAt(0).toUpperCase() + k.slice(1);
                       const displayLabel = k==='pos' ? 'POS/QR' : (k==='transferencia' ? 'Transf.' : label);
                       return `<tr><td>${displayLabel}</td><td style="text-align:right;">${fmt(theo)}</td><td style="text-align:right;">${fmt(decl)}</td><td style="text-align:right;">${fmt(diff)}</td></tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              <div class="section"><strong>Pedidos entregados</strong><table><thead><tr><th>ID</th><th>Creado</th><th style="text-align:right;">Total</th></tr></thead><tbody>
              ${orders.map(r => `<tr><td>${r.id}</td><td>${formatARDate(r.created_at||'')}</td><td style="text-align:right;">${fmt(r.total||0)}</td></tr>`).join('')}
              </tbody></table></div>
              <div class="section"><strong>Ingresos y salidas de dinero</strong>
              <table><thead><tr><th>Fecha</th><th>Tipo</th><th style="text-align:right;">Monto</th><th>Nota</th><th>Actor</th></tr></thead><tbody>
              ${manualMovs.map(m => {
                const isIn = m.type==='entrada' || m.type==='ingreso';
                const label = isIn ? 'Ingreso' : 'Salida';
                const sign = isIn ? '+' : '-';
                const amt = Number(m.amount||0);
                return `<tr><td>${formatARDate(m.created_at||'')}</td><td>${label}</td><td style="text-align:right;">${sign}${fmt(amt).replace('$','')}</td><td>${m.note||''}</td><td>${m.actor||''}</td></tr>`;
              }).join('')}
              </tbody></table></div>


<\/body><\/html>`;
            w.document.write(doc);
            w.document.close();
            try { w.focus(); w.print(); } catch(_) {}
          }
        } catch (_) {}
      };
      const viewBtns = box.querySelectorAll('button.hist-view');
      viewBtns.forEach(b => {
        b.addEventListener('click', () => attach(
          b.getAttribute('data-sid'),
          b.getAttribute('data-opened'),
          b.getAttribute('data-closed'),
          'view',
          b.getAttribute('data-note-open')||'',
          b.getAttribute('data-note-close')||'',
          b.getAttribute('data-open-amt')||'0',
          b.getAttribute('data-close-amt')||'0',
          b.getAttribute('data-tip')||'0',
          b.getAttribute('data-base')||'0',
          b.getAttribute('data-ship')||'0',
          b.getAttribute('data-metadata')||''
        ));
      });
      const pdfBtns = box.querySelectorAll('button.hist-pdf');
      pdfBtns.forEach(b => {
        b.addEventListener('click', () => attach(
          b.getAttribute('data-sid'),
          b.getAttribute('data-opened'),
          b.getAttribute('data-closed'),
          'pdf',
          b.getAttribute('data-note-open')||'',
          b.getAttribute('data-note-close')||'',
          b.getAttribute('data-open-amt')||'0',
          b.getAttribute('data-close-amt')||'0',
          b.getAttribute('data-tip')||'0',
          b.getAttribute('data-base')||'0',
          b.getAttribute('data-ship')||'0',
          b.getAttribute('data-metadata')||''
        ));
      });
    }

    async function loadSlaThresholds() {
      try {
        const slug = tenantInput.value.trim() || defaultSlug();
        const url = new URL('/api/tenant_sla', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        const resp = await fetch(url.toString());
        if (!resp.ok) return;
        const data = await resp.json();
        const w = Number(data.warning_minutes || 15);
        const c = Number(data.critical_minutes || 30);
        currentSlaThresholds = { warning: Math.max(1,w), critical: Math.max(w+1,c) };
        if (slaWarnInput && slaCritInput) {
          slaWarnInput.value = String(Math.max(1,w));
          slaCritInput.value = String(Math.max(Math.max(1,w)+1,c));
        }
      } catch (_) {}
    }
    async function logOrderEvent(orderId, type, meta) {
      try {
        const resp = await fetch(new URL(`/api/orders/${orderId}/events`, API_BASE).toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
          body: JSON.stringify({ type, meta: meta || {} })
        });
        return resp.ok;
      } catch (_) { return false; }
    }
    // Config events
    window.initOrdersConfigUI = function() {
      console.log('[DEBUG] initOrdersConfigUI called');
      try {
        const saveBtn = document.getElementById('cfg-save-btn');
        if (saveBtn) {
            // Use addEventListener to avoid overwriting
            saveBtn.replaceWith(saveBtn.cloneNode(true)); // remove old listeners
            const newSaveBtn = document.getElementById('cfg-save-btn');
            
            newSaveBtn.addEventListener('click', async () => {
                 console.log('[DEBUG] Save button clicked');
                 
                 const inp = document.getElementById('cfg-shipping-cost');
                 const val = inp ? (parseInt(inp.value)||0) : 0;

                 const tMesa = document.getElementById('cfg-time-mesa');
                 const tEspera = document.getElementById('cfg-time-espera');
                 const tDelivery = document.getElementById('cfg-time-delivery');
                 const tAuto = document.getElementById('cfg-time-auto');
                 
                 const valMesa = tMesa ? (parseInt(tMesa.value)||0) : 0;
                 const valEspera = tEspera ? (parseInt(tEspera.value)||0) : 0;
                 const valDelivery = tDelivery ? (parseInt(tDelivery.value)||0) : 0;
                 const valAuto = tAuto ? tAuto.checked : false;

                 // SLA Inputs
                 const slaWarnIn = document.getElementById('sla-warning');
                 const slaCritIn = document.getElementById('sla-critical');
                 const valSlaWarn = slaWarnIn ? parseInt(slaWarnIn.value || '15', 10) : 15;
                 const valSlaCrit = slaCritIn ? parseInt(slaCritIn.value || '30', 10) : 30;
                 
                 console.log('[DEBUG] Values to save:', { val, valMesa, valEspera, valDelivery, valAuto, valSlaWarn, valSlaCrit });
                 
                 const slug = currentTenantSlug || (document.getElementById('tenant-input') ? document.getElementById('tenant-input').value : '') || 'gastronomia-local1';

                 const bodyStr = JSON.stringify({
                       slug: slug, 
                       shipping_cost: val,
                       time_mesa: valMesa,
                       time_espera: valEspera,
                       time_delivery: valDelivery,
                       time_auto: valAuto
                 });

                 try {
                   // 1. Save General Config
                   const resp = await fetch('/api/config', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken || ''},
                     body: bodyStr
                   });
                   
                   if (!resp.ok) {
                      const err = await resp.json().catch(()=>({}));
                      throw new Error('Error en configuración general: ' + (err.error || resp.statusText));
                   }

                   // 2. Save SLA Config
                   const slaResp = await fetch(new URL('/api/tenant_sla', API_BASE).toString() + `?tenant_slug=${slug}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken || '' },
                        body: JSON.stringify({ warning_minutes: Math.max(1, valSlaWarn), critical_minutes: Math.max(valSlaWarn+1, valSlaCrit) })
                   });

                   if (!slaResp.ok) {
                      const err = await slaResp.json().catch(()=>({}));
                      throw new Error('Error en SLA: ' + (err.error || slaResp.statusText));
                   }

                   alert('Configuración guardada correctamente.');
                   const modal = document.getElementById('orders-config-modal');
                   if(modal) modal.style.display = 'none';
                   
                   // Refresh SLA
                   if (window.loadSlaThresholds) window.loadSlaThresholds();

                 } catch(e) { 
                   console.error('[DEBUG] Exception:', e);
                   alert('Error al guardar: ' + e.message);
                 }
            });
        } else {
             console.error('[DEBUG] cfg-save-btn NOT FOUND');
        }

        const btn = document.getElementById('orders-config-btn');
        const modal = document.getElementById('orders-config-modal');
        const close = document.getElementById('cfg-close-btn');
        
        console.log('[DEBUG] UI Elements:', { btn: !!btn, modal: !!modal, close: !!close });

        window.loadSlaThresholds = function() {
            const slug = currentTenantSlug || (document.getElementById('tenant-input') ? document.getElementById('tenant-input').value : '') || 'gastronomia-local1';
            const warnIn = document.getElementById('sla-warning');
            const critIn = document.getElementById('sla-critical');
            if(!warnIn || !critIn) return;
            
            fetch(new URL('/api/tenant_sla', API_BASE).toString() + `?tenant_slug=${slug}`)
                .then(r => r.json())
                .then(d => {
                    if(d.warning_minutes) warnIn.value = d.warning_minutes;
                    if(d.critical_minutes) critIn.value = d.critical_minutes;
                })
                .catch(e => console.error('Error loading SLA:', e));
        };

        if (btn && modal) {
          btn.onclick = () => {
            console.log('[DEBUG] Open config modal');
            modal.style.display = 'flex';
            
            if (window.loadSlaThresholds) window.loadSlaThresholds();

            // Sync filters
            document.querySelectorAll('.cfg-filter').forEach(cb => {
              if (ordersConfig && ordersConfig.filters && ordersConfig.filters.hasOwnProperty(cb.value)) cb.checked = ordersConfig.filters[cb.value];
            });

            // Load tenant config
            const slug = currentTenantSlug || (document.getElementById('tenant-input') ? document.getElementById('tenant-input').value : '') || 'gastronomia-local1';
            fetch(`/api/config?slug=${slug}`)
              .then(r => r.json())
              .then(d => {
                 console.log('[DEBUG] Config loaded:', d);
                 const inp = document.getElementById('cfg-shipping-cost');
                 if(inp) inp.value = d.shipping_cost || 0;

                 const tMesa = document.getElementById('cfg-time-mesa');
                 const tEspera = document.getElementById('cfg-time-espera');
                 const tDelivery = document.getElementById('cfg-time-delivery');
                 const tAuto = document.getElementById('cfg-time-auto');
                 
                 if(tMesa) tMesa.value = d.time_mesa || 0;
                 if(tEspera) tEspera.value = d.time_espera || 0;
                 if(tDelivery) tDelivery.value = d.time_delivery || 0;
                 if(tAuto) {
                   tAuto.checked = !!d.time_auto;
                   const updateState = () => {
                       const disabled = tAuto.checked;
                       if(tMesa) tMesa.disabled = disabled;
                       if(tEspera) tEspera.disabled = disabled;
                       if(tDelivery) tDelivery.disabled = disabled;
                       [tMesa, tEspera, tDelivery].forEach(el => {
                           if(el) el.style.opacity = disabled ? '0.6' : '1';
                       });
                   };
                   tAuto.onchange = updateState;
                   updateState();
                 }
              })
              .catch(err => console.error('[DEBUG] Load config error:', err));
          };
        }
        
        if (close && modal) close.onclick = () => modal.style.display = 'none';
        if (modal) modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        
        // Handle filters change
        document.querySelectorAll('.cfg-filter').forEach(cb => {
          cb.onchange = (e) => {
            if (!ordersConfig) ordersConfig = { filters: {} };
            ordersConfig.filters[e.target.value] = e.target.checked;
            localStorage.setItem('ordersConfig', JSON.stringify(ordersConfig));
            fetchOrders();
          };
        });

      } catch(e) {
        console.error('[DEBUG] initOrdersConfigUI crash:', e);
      }
    }
    
    // --- WHATSAPP CONFIG UI ---
    const DEFAULT_WHATSAPP_TEMPLATE = `¡Hola! \uD83D\uDC4B Espero que estés muy bien.

\uD83D\uDED2 Me gustaría realizar el siguiente pedido:

{PEDIDO_INFO}

{ITEMS}

{TOTALES}

{NOTAS}

¿Podrías confirmarme la disponibilidad y el método de entrega?

¡Muchas gracias! \uD83D\uDE0A`;

    function initWhatsappConfigUI() {
        try {
            const btn = document.getElementById('whatsapp-config-btn');
            const modal = document.getElementById('whatsapp-config-modal');
            const closeBtn = document.getElementById('cfg-whatsapp-close-btn');
            const saveBtn = document.getElementById('cfg-whatsapp-save-btn');
            const restoreBtn = document.getElementById('cfg-whatsapp-restore-btn');
            
            if (btn && modal) {
                btn.onclick = () => {
                    modal.style.display = 'flex';
                    // Load Config
                    const slug = currentTenantSlug || (document.getElementById('tenant-input') ? document.getElementById('tenant-input').value : '') || 'gastronomia-local1';
                    fetch(`/api/config?slug=${slug}`)
                      .then(r => r.json())
                      .then(d => {
                         const checkout = d.checkout || {};
                         const waEnabled = document.getElementById('cfg-whatsapp-enabled-modal');
                         const waNumber = document.getElementById('cfg-whatsapp-number-modal');
                         const waTemplate = document.getElementById('cfg-whatsapp-template-modal');
                         
                         if (waEnabled) waEnabled.checked = (typeof checkout.whatsappEnabled !== 'undefined') ? checkout.whatsappEnabled : true;
                         if (waNumber) waNumber.value = checkout.whatsappNumber || '';
                         if (waTemplate) waTemplate.value = checkout.whatsappTemplate || DEFAULT_WHATSAPP_TEMPLATE;
                      })
                      .catch(e => console.error('Error loading WhatsApp config:', e));
                };
            }
            
            if (closeBtn && modal) closeBtn.onclick = () => modal.style.display = 'none';
            if (modal) modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
            
            if (restoreBtn) {
                restoreBtn.onclick = () => {
                    const waTemplate = document.getElementById('cfg-whatsapp-template-modal');
                    if (waTemplate) waTemplate.value = DEFAULT_WHATSAPP_TEMPLATE;
                };
            }
            
            if (saveBtn) {
                saveBtn.onclick = async () => {
                     const slug = currentTenantSlug || (document.getElementById('tenant-input') ? document.getElementById('tenant-input').value : '') || 'gastronomia-local1';
                     const waEnabledIn = document.getElementById('cfg-whatsapp-enabled-modal');
                     const waNumberIn = document.getElementById('cfg-whatsapp-number-modal');
                     const waTemplateIn = document.getElementById('cfg-whatsapp-template-modal');
                     
                     const valWaEnabled = waEnabledIn ? waEnabledIn.checked : true;
                     const valWaNumber = waNumberIn ? waNumberIn.value.trim() : '';
                     const valWaTemplate = waTemplateIn ? waTemplateIn.value : '';
                     
                     try {
                        const waResp = await fetch(new URL('/api/tenant_checkout', API_BASE).toString() + `?tenant_slug=${slug}`, {
                            method: 'PATCH',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'X-CSRF-Token': (typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : '') 
                            },
                            body: JSON.stringify({ 
                                whatsapp_enabled: valWaEnabled, 
                                whatsapp_number: valWaNumber,
                                whatsapp_template: valWaTemplate
                            })
                        });
                        
                        if (!waResp.ok) {
                           const err = await waResp.json().catch(()=>({}));
                           throw new Error(err.error || waResp.statusText);
                        }
                        
                        alert('Configuración de WhatsApp guardada.');
                        if(modal) modal.style.display = 'none';
                        
                     } catch(e) {
                        console.error('Error saving WhatsApp config:', e);
                        alert('Error al guardar: ' + e.message);
                     }
                };
            }
            
        } catch(e) {
            console.error('initWhatsappConfigUI error:', e);
        }
    }

    // Call init when DOM is likely ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOrdersConfigUI);
        document.addEventListener('DOMContentLoaded', initWhatsappConfigUI);
    } else {
        initOrdersConfigUI();
        initWhatsappConfigUI();
    }
    // --- NEW ORDER MODAL LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('create-order-modal');
      const openBtn = document.getElementById('btn-new-order');
      const closeBtn = modal ? modal.querySelector('.close-modal-btn') : null;
      const overlay = modal ? modal.querySelector('.kds-modal-overlay') : null;
      const tenantSelect = document.getElementById('new-order-tenant');
      const searchInput = document.getElementById('new-order-search');
      const productsGrid = document.getElementById('new-order-products');
      const cartContainer = document.getElementById('new-order-cart');
      const subtotalEl = document.getElementById('new-order-subtotal');
      const totalEl = document.getElementById('new-order-total');
      const confirmBtn = document.getElementById('btn-create-order-confirm');
      const typeSelect = document.getElementById('new-order-type');
      
      // Fields
      const fieldMesa = document.getElementById('field-mesa');
      const fieldAddress = document.getElementById('field-address');
      const fieldContact = document.getElementById('field-contact');
      
      let cart = [];
      let products = [];
      
      // Init Tenants
      const tenants = [
        { slug: 'gastronomia-local1', name: 'Gastronomía Local 1' },
        { slug: 'gastronomia-local2', name: 'Gastronomía Local 2' },
        { slug: 'gastronomia-local3', name: 'Gastronomía Local 3' },
        { slug: 'gastronomia-local4', name: 'Gastronomía Local 4' },
        { slug: 'gastronomia-local5', name: 'Gastronomía Local 5' }
      ];
      
      if (tenantSelect) {
        // Initial sync
        const current = (typeof tenantInput !== 'undefined' && tenantInput.value) ? tenantInput.value : 'gastronomia-local1';
        const t = tenants.find(x => x.slug === current) || tenants[0];
        tenantSelect.innerHTML = `<option value="${t.slug}">${t.name}</option>`;
        tenantSelect.value = t.slug;
        tenantSelect.disabled = true;
      }
      
      // Events
      if (openBtn) openBtn.addEventListener('click', () => {
        if (!modal) return;
        
        // Sync with current tenant before opening
        if (tenantSelect && typeof tenantInput !== 'undefined' && tenantInput.value) {
             const current = tenantInput.value;
             const t = tenants.find(x => x.slug === current) || tenants[0];
             tenantSelect.innerHTML = `<option value="${t.slug}">${t.name}</option>`;
             tenantSelect.value = t.slug;
        }

        modal.classList.add('active');
        modal.style.display = 'flex'; // Ensure display flex
        populateTableSelect(); // Load tables from storage
        loadProducts();
        renderCart();
      });
      
      const closeModal = () => {
        if (!modal) return;
        modal.classList.remove('active');
        modal.style.display = 'none';
        cart = [];
        renderCart();
      };
      
      if (closeBtn) closeBtn.addEventListener('click', closeModal);
      if (overlay) overlay.addEventListener('click', closeModal);
      
      if (typeSelect) typeSelect.addEventListener('change', () => {
        const val = typeSelect.value;
        if (fieldMesa) {
            fieldMesa.style.display = (val === 'mesa') ? 'block' : 'none';
            if (val === 'mesa') populateTableSelect();
        }
        if (fieldAddress) fieldAddress.style.display = (val === 'direccion') ? 'block' : 'none';
        if (fieldContact) fieldContact.style.display = (val !== 'mesa') ? 'block' : 'none';
      });
      
      if (tenantSelect) tenantSelect.addEventListener('change', loadProducts);
      if (searchInput) searchInput.addEventListener('input', renderProducts);

      function populateTableSelect() {
        const tableSelect = document.getElementById('new-order-table');
        if (!tableSelect || tableSelect.tagName !== 'SELECT') return;
        
        const currentVal = tableSelect.value;
        tableSelect.innerHTML = '<option value="">Seleccionar Mesa...</option>';
        
        const slug = (typeof currentTenantSlug !== 'undefined' && currentTenantSlug) ? currentTenantSlug : 
                     (document.getElementById('tenant-input')?.value || 'gastronomia-local1');

        let stored = localStorage.getItem('kds_tables_' + slug);
        if (!stored) stored = localStorage.getItem('kds_tables');

        if (!stored) {
             tableSelect.innerHTML += '<option value="" disabled>Sin mesas configuradas</option>';
             return;
        }
        
        try {
            const data = JSON.parse(stored);
            const zones = data.zones || [];
            
            if (zones.length === 0) {
                 tableSelect.innerHTML += '<option value="" disabled>Sin mesas configuradas</option>';
                 return;
            }
            
            zones.forEach(zone => {
                const group = document.createElement('optgroup');
                group.label = zone.name;
                
                (zone.tables || []).forEach(table => {
                    const opt = document.createElement('option');
                    opt.value = table.label; 
                    const statusMap = { 'free': 'Libre', 'occupied': 'Ocupada', 'reserved': 'Reservada', 'bill': 'Cuenta' };
                    opt.textContent = `${table.label} (${statusMap[table.status] || table.status})`;
                    group.appendChild(opt);
                });
                
                tableSelect.appendChild(group);
            });
            
            if (currentVal) {
                // Check if value still exists
                const options = Array.from(tableSelect.options).map(o => o.value);
                if (options.includes(currentVal)) tableSelect.value = currentVal;
            }
        } catch(e) {
            console.error('Error parsing tables for select:', e);
        }
      }
      
      async function loadProducts() {
        productsGrid.innerHTML = '<div class="small">Cargando...</div>';
        try {
          const allProducts = await fetchProducts(); // Uses existing function
          const slug = tenantSelect.value;
          
          // Filter by tenant prefix logic
          let prefix = '';
          if (slug === 'gastronomia-local2') prefix = 'l2-';
          else if (slug === 'gastronomia-local3') prefix = 'l3-';
          else if (slug === 'gastronomia-local4') prefix = 'l4-';
          else if (slug === 'gastronomia-local5') prefix = 'l5-';
          
          products = allProducts.filter(p => {
             if (prefix) return p.id.startsWith(prefix);
             // Local 1: Not starting with any other prefix
             return !p.id.startsWith('l2-') && !p.id.startsWith('l3-') && !p.id.startsWith('l4-') && !p.id.startsWith('l5-');
          });
          
          renderProducts();
        } catch (e) {
          productsGrid.innerHTML = '<div class="small error">Error al cargar productos</div>';
        }
      }
      
      function renderProducts() {
        const term = searchInput ? searchInput.value.toLowerCase() : '';
        const filtered = products.filter(p => {
          return p.name.toLowerCase().includes(term) || p.id.toLowerCase().includes(term);
        });
        
        productsGrid.innerHTML = '';
        if (filtered.length === 0) {
          productsGrid.innerHTML = '<div class="small" style="grid-column: 1/-1; text-align:center;">No se encontraron productos</div>';
          return;
        }
        
        filtered.forEach(p => {
          const el = document.createElement('div');
          el.className = 'product-card-simple';
          el.style.cssText = 'border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fff; cursor: pointer; transition: all 0.2s; display:flex; flex-direction:column; justify-content:space-between; height: 100%;';
          el.onmouseover = () => el.style.borderColor = '#bbb';
          el.onmouseout = () => el.style.borderColor = '#eee';
          const hasDetails = p.details && p.details.trim().length > 0;
          el.innerHTML = `
            <div style="flex:1;">
              <div style="display:flex; align-items:center; margin-bottom: 2px;">
                 <span style="font-weight: 600; font-size: 14px; line-height: 1.2;">${p.name}</span>
                 ${hasDetails ? `<span class="info-icon" style="margin-left:8px; color:#2196F3; font-size:16px; padding:0 4px; cursor:pointer;" onclick="event.stopPropagation(); this.closest('.product-card-simple').querySelector('.prod-detail-text').classList.toggle('visible');">&#9432;</span>` : ''}
              </div>
              <div class="prod-detail-text" style="font-size: 11px; color: #888;">${p.details || ''}</div>
            </div>
            <div style="font-weight: 700; color: #2e7d32; text-align: right;">$${p.price}</div>
          `;
          el.onclick = () => addToCart(p);
          productsGrid.appendChild(el);
        });
      }
      
      function addToCart(p) {
        const existing = cart.find(i => i.id === p.id);
        if (existing) {
          existing.qty++;
        } else {
          cart.push({ ...p, qty: 1 });
        }
        renderCart();
      }
      
      window.updateCartQty = (id, delta) => {
        const idx = cart.findIndex(i => i.id === id);
        if (idx === -1) return;
        const item = cart[idx];
        item.qty += delta;
        if (item.qty <= 0) cart.splice(idx, 1);
        renderCart();
      };
      
      window.updateCartItemNote = (id, note) => {
        const item = cart.find(i => i.id === id);
        if (item) {
            item.notes = note;
        }
      };
      
      function renderCart() {
        if (!cartContainer) return;
        cartContainer.innerHTML = '';
        let total = 0;
        
        if (cart.length === 0) {
          cartContainer.innerHTML = '<div class="small" style="text-align: center; padding: 20px; color: #999; font-style: italic;">Carrito vacío</div>';
        } else {
          cart.forEach(item => {
            const rowTotal = item.price * item.qty;
            total += rowTotal;
            const row = document.createElement('div');
            row.style.cssText = 'display: flex; flex-direction: column; padding: 8px; background: #f9f9f9; border-radius: 6px; font-size: 13px; gap: 8px;';
            row.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; margin-right: 8px;">
                  <div style="font-weight: 600;">${item.name}</div>
                  <div style="color: #666;">$${item.price} x ${item.qty}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <button onclick="updateCartQty('${item.id}', -1)" style="width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; background: #ddd; color: #333; border-radius: 4px;">-</button>
                  <span style="font-weight: 600; width: 16px; text-align: center;">${item.qty}</span>
                  <button onclick="updateCartQty('${item.id}', 1)" style="width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; background: #ddd; color: #333; border-radius: 4px;">+</button>
                </div>
              </div>
              <div>
                <input type="text" placeholder="Notas (ej. sin sal)" value="${item.notes || ''}" onchange="updateCartItemNote('${item.id}', this.value)" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
              </div>
            `;
            cartContainer.appendChild(row);
          });
        }
        
        if (subtotalEl) subtotalEl.textContent = '$' + total;
        if (totalEl) totalEl.textContent = '$' + total;
        
        // Update confirm button state
        if (confirmBtn) {
           confirmBtn.disabled = cart.length === 0;
           confirmBtn.style.opacity = cart.length === 0 ? '0.5' : '1';
        }
      }
      
      if (confirmBtn) confirmBtn.addEventListener('click', async () => {
        if (cart.length === 0) return;
        
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Enviando...';
        
        try {
          const type = typeSelect.value;
          const tenant = tenantSelect.value;
          const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
          
          let address = '';
          let table = '';
          
          if (type === 'mesa') {
            table = document.getElementById('new-order-table').value;
            if (!table) { alert('Ingrese número de mesa'); confirmBtn.disabled=false; confirmBtn.textContent='Confirmar Pedido'; return; }
          } else if (type === 'direccion') {
            address = document.getElementById('new-order-address').value;
            if (!address) { alert('Ingrese dirección'); confirmBtn.disabled=false; confirmBtn.textContent='Confirmar Pedido'; return; }
          }
          
          const name = document.getElementById('new-order-name').value || (type === 'mesa' ? table : 'Cliente Mostrador');
          const phone = document.getElementById('new-order-phone').value || '';
          const notes = document.getElementById('new-order-notes').value || '';
          
          const payload = {
            tenant_slug: tenant,
            order_type: type,
            customer_name: name,
            customer_phone: phone,
            items: cart.map(i => ({
              id: i.id,
              name: i.name,
              price: i.price,
              quantity: i.qty,
              details: i.details,
              notes: i.notes || ''
            })),
            total: total,
            status: 'pendiente',
            order_notes: notes,
            created_at: new Date().toISOString()
          };
          
          if (type === 'mesa') payload.table_number = table;
          if (type === 'direccion' || type === 'espera') payload.address = address || 'Retiro en local';
          
          // Ensure CSRF
          if (!CSRF_TOKEN || CSRF_TOKEN === '') {
              try { await fetchCsrfToken(); } catch(e) { console.error(e); }
          }
          const headers = { 'Content-Type': 'application/json' };
          if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

          let resp = await fetch('/api/orders', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'
          });
          
          if (resp.status === 403) {
             await fetchCsrfToken();
             if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
             resp = await fetch('/api/orders', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload),
                credentials: 'include'
             });
          }
          
          if (resp.ok) {
            // Update table status if applicable
            if (type === 'mesa' && table) {
                try {
                    const slug = tenant || 'gastronomia-local1';
                    let stored = localStorage.getItem('kds_tables_' + slug);
                    if (!stored) stored = localStorage.getItem('kds_tables');

                    if (stored) {
                        const data = JSON.parse(stored);
                        let found = false;
                        if (data.zones) {
                            data.zones.forEach(z => {
                                const t = z.tables.find(tbl => tbl.label === table);
                                if (t) {
                                    t.status = 'occupied';
                                    found = true;
                                }
                            });
                        }
                        
                        if (found) {
                            localStorage.setItem('kds_tables_' + slug, JSON.stringify(data));
                        }
                    }
                } catch(e) { console.error('Error updating table status', e); }
            }

            closeModal();
            alert('Pedido creado exitosamente');
            if (typeof load === 'function') load(); // Reload orders
          } else {
            const err = await resp.json().catch(()=>({}));
            alert('Error al crear pedido: ' + (err.error || 'Desconocido'));
          }
        } catch (e) {
          alert('Error de conexión');
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirmar Pedido';
        }
      });
      
    });
  </script>
<style>
  /* Mobile responsiveness for Create Order Modal */
  #create-order-modal .create-order-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    height: 100%;
    flex-wrap: wrap; /* Fallback for responsiveness */
  }
  
  #create-order-modal .create-order-left {
    flex: 1 1 400px; /* Grow, shrink, base 400px */
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--kds-border);
    background: #f9fafb;
    min-height: 300px;
  }

  #create-order-modal .create-order-right {
    flex: 0 0 320px; /* Fixed width on desktop */
    width: 320px;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-left: 1px solid var(--kds-border);
    box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    z-index: 2;
  }

  @media (max-width: 900px) {
    #create-order-modal .create-order-body {
      flex-direction: column;
      overflow: hidden;
    }
    #create-order-modal .create-order-left {
      flex: 1 1 0% !important; /* Force equal split using flex-grow/shrink/basis */
      height: auto !important;
      width: 100%;
      border-right: none;
      border-bottom: 4px solid #e0e0e0; /* Distinct separator */
      min-height: 0;
      overflow-y: auto;
    }
    #create-order-modal .create-order-right {
      flex: 1 1 0% !important; /* Force equal split */
      height: auto !important;
      max-height: none !important;
      width: 100%;
      min-width: 0;
      border-left: none;
      box-shadow: none; /* Remove shadow in mobile to avoid confusion */
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    #create-order-modal .kds-modal-content {
      width: 100% !important;
      height: 100vh !important;
      max-width: 100% !important;
      border-radius: 0 !important;
    }

    /* Compact List Mode for Mobile */
    #new-order-products {
      display: flex !important;
      flex-direction: column !important;
      gap: 0 !important;
      padding: 0 !important;
    }
    #new-order-products .product-card-simple {
      border-radius: 0 !important;
      border: none !important;
      border-bottom: 1px solid #eee !important;
      padding: 12px 16px !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: space-between !important;
      height: auto !important;
      margin: 0 !important;
      background: #fff !important;
    }
    #new-order-products .product-card-simple > div:first-child {
      flex: 1;
      margin-right: 12px;
    }
    #new-order-products .product-card-simple > div:first-child > div:first-child {
      margin-bottom: 2px !important;
      font-size: 14px !important;
    }
    #new-order-products .product-card-simple .prod-detail-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 11px;
      color: #888;
    }
    #new-order-products .product-card-simple .prod-detail-text.visible {
      display: block !important;
      -webkit-line-clamp: unset;
    }
  }

  @media (max-width: 900px) {
    #create-order-modal .create-order-body {
      flex-direction: column;
      overflow: hidden;
    }
    /* ... (rest of media query) ... */
    #new-order-products .product-card-simple > div:first-child > div:first-child {
      margin-bottom: 2px !important;
      font-size: 14px !important;
    }
    #new-order-products .product-card-simple .prod-detail-text {
      display: none; /* Hide description for compact view */
    }
    #new-order-products .product-card-simple .prod-detail-text.visible {
      display: block !important; /* Visible when toggled */
      margin-top: 4px;
      white-space: normal;
    }
    #new-order-products .product-card-simple > div:last-child {
      margin-top: 0 !important;
      font-size: 14px !important;
      font-weight: 700 !important;
    }
  }
</style>
<!-- Create Order Modal -->
<div id="create-order-modal" class="kds-modal">
  <div class="kds-modal-overlay"></div>
  <div class="kds-modal-content" style="width: 95vw; max-width: 1000px; height: 90vh; display: flex; flex-direction: column; padding: 0;">
    <div style="padding: 16px; border-bottom: 1px solid var(--kds-border); display: flex; justify-content: space-between; align-items: center; background: #fff;">
      <h2 style="margin: 0; font-size: 1.25rem; color: #333;">Nuevo Pedido</h2>
      <button class="close-modal-btn" style="background: transparent; border: none; font-size: 24px; color: #666; cursor: pointer; padding: 0; width: auto; box-shadow: none;">&times;</button>
    </div>
    
    <div class="create-order-body">
      <!-- Product Selection (Left) -->
      <div class="create-order-left">
        <div style="padding: 12px; border-bottom: 1px solid var(--kds-border); background: #fff;">
          <input type="text" id="new-order-search" placeholder="Buscar productos..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;">
        </div>
        <div id="new-order-products" style="flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; align-content: start;">
          <!-- Products will be injected here -->
        </div>
      </div>

      <!-- Order Details (Right) -->
      <div class="create-order-right">
        <div style="padding: 16px; overflow-y: auto; flex: 1;">
          <!-- Customer Info -->
          <div style="display: grid; gap: 12px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Local</label>
              <select id="new-order-tenant" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; font-size: 13px;">
                <!-- Tenant options populated by JS -->
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Tipo</label>
              <select id="new-order-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                <option value="mesa">Mesa</option>
                <option value="direccion">Delivery</option>
                <option value="espera">Retiro / Para llevar</option>
              </select>
            </div>
            
            <div id="field-mesa" class="order-type-field">
              <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Nº Mesa</label>
              <select id="new-order-table" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #fff;">
                <option value="">Seleccionar Mesa...</option>
              </select>
            </div>

            <div id="field-address" class="order-type-field" style="display: none;">
              <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Dirección</label>
              <input type="text" id="new-order-address" placeholder="Calle y número" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>

            <div id="field-contact" class="order-type-field" style="display: none;">
               <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Nombre Cliente</label>
               <input type="text" id="new-order-name" placeholder="Nombre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
               <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px; margin-top: 8px;">Teléfono</label>
               <input type="text" id="new-order-phone" placeholder="WhatsApp" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            
            <div>
               <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 4px;">Notas</label>
               <textarea id="new-order-notes" placeholder="Notas del pedido..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
            </div>
          </div>

          <!-- Cart Items -->
          <h3 style="font-size: 14px; margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 6px; color: #333;">Items</h3>
          <div id="new-order-cart" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Cart items here -->
            <div class="small" style="text-align: center; padding: 20px; color: #999; font-style: italic;">Carrito vacío</div>
          </div>
        </div>

        <!-- Footer / Totals -->
        <div style="padding: 16px; border-top: 1px solid var(--kds-border); background: #f5f7fb;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px; color: #666;">
            <span>Subtotal:</span>
            <span id="new-order-subtotal">$0</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 16px; font-weight: 800; font-size: 1.25rem; color: #333;">
            <span>Total:</span>
            <span id="new-order-total">$0</span>
          </div>
          <button id="btn-create-order-confirm" style="width: 100%; padding: 12px; font-weight: 600; font-size: 16px; background: #2e7d32; color: #fff; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 6px rgba(46,125,50,0.3);">Confirmar Pedido</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // --- Table Management Logic ---
  (function() {
    const tmSection = document.getElementById('table-management');
    const tmBtn = document.getElementById('tables-open');
    const mapContainer = document.getElementById('restaurant-map');
    
    // Controls
    const addTableBtn = document.getElementById('tm-add-table');
    const mergeBtn = document.getElementById('tm-merge-btn');
    const mergeControls = document.getElementById('tm-merge-controls');
    const confirmMergeBtn = document.getElementById('tm-confirm-merge');
    const cancelMergeBtn = document.getElementById('tm-cancel-merge');
    const mergeMsg = document.getElementById('tm-merge-msg');
    const saveLayoutBtn = document.getElementById('tm-save-layout');
    const shapeSelect = document.getElementById('tm-shape-select');
    const sizeSelect = document.getElementById('tm-size-select');
    const rotateBtn = document.getElementById('tm-rotate-btn');
    const delBtn = document.getElementById('tm-del-btn');
    
    // Zone Controls
    const zoneSelect = document.getElementById('tm-zone-select');
    const addZoneBtn = document.getElementById('tm-add-zone');
    const editZoneBtn = document.getElementById('tm-edit-zone');
    const delZoneBtn = document.getElementById('tm-del-zone');
    
    // State
    let data = {
      zones: [
        { id: 1, name: 'Salón Principal', tables: [] }
      ]
    };
    let currentZoneId = 1;
    let selectedTableId = null;
    let mergeState = { active: false, selectedIds: [] };

    function initTableManagement() {
      if (!tmBtn || !tmSection) return;

      loadData();
      
      // Listen for external updates
      window.addEventListener('kds-tables-changed', () => {
        loadData();
        renderTables();
      });

      window.addEventListener('kds-orders-updated', () => {
         if (tmSection.style.display !== 'none') {
             renderTables();
         }
      });

      // Navigation
      tmBtn.addEventListener('click', () => {
        document.querySelectorAll('section.grid, #analytics').forEach(el => el.style.display = 'none');
        document.body.classList.remove('show-analytics');
        tmSection.style.display = 'block';
        renderZones();
        renderTables();
      });
      
      const closeTmMgr = () => {
        tmSection.style.display = 'none';
        const grid = document.querySelector('section.grid');
        if (grid) grid.style.display = '';
      };

      const closeBtn = document.getElementById('tm-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', closeTmMgr);

      const otherNavs = ['analytics-open', 'orders-config-btn'];
      otherNavs.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', closeTmMgr);
      });
      
      // Zone Events
      zoneSelect.addEventListener('change', (e) => {
        currentZoneId = parseInt(e.target.value);
        selectedTableId = null;
        updateToolbarState();
        renderTables();
      });

      addZoneBtn.addEventListener('click', () => {
        const name = prompt('Nombre del nuevo salón:', 'Patio');
        if (name) {
          const newId = data.zones.length > 0 ? Math.max(...data.zones.map(z => z.id)) + 1 : 1;
          data.zones.push({ id: newId, name: name, tables: [] });
          currentZoneId = newId;
          saveData();
          renderZones();
          renderTables();
        }
      });

      editZoneBtn.addEventListener('click', () => {
        const zone = data.zones.find(z => z.id === currentZoneId);
        if (zone) {
          const newName = prompt('Nuevo nombre del salón:', zone.name);
          if (newName) {
            zone.name = newName;
            saveData();
            renderZones();
          }
        }
      });

      delZoneBtn.addEventListener('click', () => {
        if (data.zones.length <= 1) {
          alert('Debe existir al menos un salón.');
          return;
        }
        if (confirm('¿Estás seguro de eliminar este salón y todas sus mesas?')) {
          data.zones = data.zones.filter(z => z.id !== currentZoneId);
          currentZoneId = data.zones[0].id;
          selectedTableId = null;
          saveData();
          renderZones();
          renderTables();
        }
      });

      // Merge Events
      if (mergeBtn) {
          mergeBtn.addEventListener('click', () => {
              mergeState.active = true;
              mergeState.selectedIds = [];
              mergeBtn.style.display = 'none';
              addTableBtn.style.display = 'none';
              mergeControls.style.display = 'flex';
              selectedTableId = null;
              renderTables();
          });
      }

      if (cancelMergeBtn) {
          cancelMergeBtn.addEventListener('click', () => {
              mergeState.active = false;
              mergeState.selectedIds = [];
              mergeBtn.style.display = '';
              addTableBtn.style.display = '';
              mergeControls.style.display = 'none';
              renderTables();
          });
      }

      if (confirmMergeBtn) {
          confirmMergeBtn.addEventListener('click', () => {
              if (mergeState.selectedIds.length < 2) {
                  alert('Selecciona al menos 2 mesas para unir.');
                  return;
              }
              const zone = data.zones.find(z => z.id === currentZoneId);
              if (!zone) return;

              const tablesToMerge = zone.tables.filter(t => mergeState.selectedIds.includes(t.id));
              const busy = tablesToMerge.find(t => t.status !== 'free');
              if (busy) {
                  alert('Solo se pueden unir mesas libres.');
                  return;
              }

              const newLabel = prompt('Nombre para la mesa unida:', tablesToMerge[0].label + '+' + tablesToMerge[1].label.split(' ').pop());
              if (!newLabel) return;

              const avgX = tablesToMerge.reduce((sum, t) => sum + t.x, 0) / tablesToMerge.length;
              const avgY = tablesToMerge.reduce((sum, t) => sum + t.y, 0) / tablesToMerge.length;

              const newTable = {
                  id: Date.now(),
                  label: newLabel,
                  type: 'rect',
                  size: 'large',
                  x: avgX,
                  y: avgY,
                  status: 'free',
                  rotation: 0,
                  is_merged: true,
                  merged_ids: mergeState.selectedIds,
                  original_tables: JSON.parse(JSON.stringify(tablesToMerge))
              };

              zone.tables = zone.tables.filter(t => !mergeState.selectedIds.includes(t.id));
              zone.tables.push(newTable);

              mergeState.active = false;
              mergeState.selectedIds = [];
              mergeBtn.style.display = '';
              addTableBtn.style.display = '';
              mergeControls.style.display = 'none';
              
              saveData();
              renderTables();
          });
      }

      // Table Events
      addTableBtn.addEventListener('click', () => {
        const zone = data.zones.find(z => z.id === currentZoneId);
        if (!zone) return;
        
        const newId = Date.now(); // Simple unique ID
        const shape = shapeSelect.value;
        const size = sizeSelect.value;
        
        // Smart Naming Logic (Fill gaps)
        const prefix = shape === 'bar' ? 'Barra' : 'Mesa';
        let nextNum = 1;
        
        // Extract numbers from existing labels of the same type
        const existingNums = zone.tables
          .map(t => {
            const match = t.label.match(new RegExp(`^${prefix}\\s+(\\d+)$`));
            return match ? parseInt(match[1]) : null;
          })
          .filter(n => n !== null)
          .sort((a, b) => a - b);

        // Find first gap
        for (const num of existingNums) {
          if (num === nextNum) {
            nextNum++;
          } else if (num > nextNum) {
            break; // Found a gap
          }
        }
        
        const defaultLabel = `${prefix} ${nextNum}`;
        const label = prompt('Nombre de la mesa:', defaultLabel);
        
        if (!label) return; // User cancelled

        zone.tables.push({
          id: newId,
          label: label,
          type: shape,
          size: size,
          x: 50,
          y: 50,
          status: 'free',
          rotation: 0
        });
        
        selectedTableId = newId;
        renderTables();
        saveData();
      });

      rotateBtn.addEventListener('click', () => {
        if (!selectedTableId) return;
        const zone = data.zones.find(z => z.id === currentZoneId);
        const table = zone.tables.find(t => t.id === selectedTableId);
        if (table) {
          table.rotation = (table.rotation || 0) + 90;
          if (table.rotation >= 360) table.rotation = 0;
          renderTables();
          saveData();
        }
      });

      delBtn.addEventListener('click', () => {
        if (!selectedTableId) return;
        if (confirm('¿Eliminar esta mesa?')) {
          const zone = data.zones.find(z => z.id === currentZoneId);
          zone.tables = zone.tables.filter(t => t.id !== selectedTableId);
          selectedTableId = null;
          renderTables();
          saveData();
        }
      });

      saveLayoutBtn.addEventListener('click', () => {
        saveData();
        alert('Distribución guardada');
      });
      
      // Click outside to deselect
      mapContainer.addEventListener('click', (e) => {
        if (e.target === mapContainer) {
          selectedTableId = null;
          renderTables();
        }
      });

      // Global Drag Handlers (moved out of render loop to prevent memory leaks and bugs)
      window.addEventListener('mousemove', (e) => {
        if (!dragState.active || !dragState.el) return;
        
        const dx = e.clientX - dragState.startX;
        const dy = e.clientY - dragState.startY;
        
        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) dragState.hasMoved = true;
        
        // Update model
        if (dragState.table) {
          dragState.table.x = dragState.initialLeft + dx;
          dragState.table.y = dragState.initialTop + dy;
          
          // Update DOM
          dragState.el.style.left = dragState.table.x + 'px';
          dragState.el.style.top = dragState.table.y + 'px';
        }
      });

      window.addEventListener('mouseup', () => {
        if (dragState.active) {
          // Set flag if moved so click handler knows to ignore
          if (dragState.hasMoved && dragState.el) {
             dragState.el.dataset.wasDragging = 'true';
             saveData();
          }

          dragState.active = false;
          if (dragState.el) dragState.el.style.zIndex = '';
          
          dragState.el = null;
          dragState.table = null;
        }
      });
    }

    async function loadData() {
      const slug = document.getElementById('tenant-input')?.value || 'gastronomia-local1';
      
      // 1. Try to fetch from Server
      try {
        const url = new URL('/api/tenant_tables', window.location.origin);
        url.searchParams.set('tenant_slug', slug);
        
        const res = await fetch(url);
        if (res.ok) {
           const serverData = await res.json();
           if (serverData && serverData.zones && serverData.zones.length > 0) {
               // Check if it's the default empty structure
               const isDefault = serverData.zones.length === 1 && serverData.zones[0].tables.length === 0 && serverData.zones[0].name === 'Salón Principal';
               
               if (!isDefault) {
                   data = serverData;
                   // Sync to local storage so populateTableSelect can see it
                   localStorage.setItem('kds_tables_' + slug, JSON.stringify(data));
                   ensureCurrentZone();
                   renderZones();
                   renderTables();
                   return;
               }
           }
        }
      } catch (e) {
        console.error('Error loading tables from server:', e);
      }

      // 2. Fallback / Migration: Check LocalStorage
      // Check tenant-specific key first
      let stored = localStorage.getItem('kds_tables_' + slug);
      if (!stored) {
         // Check legacy global key
         stored = localStorage.getItem('kds_tables');
      }
      
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed)) {
            data.zones[0].tables = parsed;
          } else if (parsed.zones) {
            data = parsed;
          }
          ensureCurrentZone();
          
          // If we found local data but server was empty/default, sync to server
          saveData(); 
        } catch(e) {}
      }
      
      renderZones();
      renderTables();
    }
    
    function ensureCurrentZone() {
        if (!data.zones.find(z => z.id === currentZoneId)) {
          currentZoneId = data.zones[0]?.id || 1;
        }
    }

    async function saveData() {
      const slug = document.getElementById('tenant-input')?.value || 'gastronomia-local1';
      const btn = document.getElementById('tm-save-layout');
      const originalText = btn ? btn.innerText : 'Guardar Distribución';
      
      if (btn) {
          btn.innerText = 'Guardando...';
          btn.disabled = true;
          btn.style.opacity = '0.7';
      }

      // Ensure CSRF Token is present
      if (!CSRF_TOKEN || CSRF_TOKEN === '') {
          console.warn('CSRF Token missing in saveData, fetching...');
          try { await fetchCsrfToken(); } catch(e) { console.error(e); }
      }
      
      // 1. Save Local (Backup/Offline)
      localStorage.setItem('kds_tables_' + slug, JSON.stringify(data));
      updateToolbarState();
      
      // 2. Save Server
      try {
         const headers = {
            'Content-Type': 'application/json'
         };
         if (typeof CSRF_TOKEN !== 'undefined' && CSRF_TOKEN) {
             headers['X-CSRFToken'] = CSRF_TOKEN;
         }
         
         let res = await fetch(`/api/tenant_tables?tenant_slug=${slug}`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(data),
            credentials: 'include'
         });

         // Retry once on 403
         if (res.status === 403) {
             console.warn('403 Forbidden in saveData, retrying with new token...');
             await fetchCsrfToken();
             if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
             res = await fetch(`/api/tenant_tables?tenant_slug=${slug}`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data),
                credentials: 'include'
             });
         }
         
         if (!res.ok) throw new Error('Error en servidor: ' + res.status);
         
         if (btn) {
             btn.innerText = '¡Guardado!';
             setTimeout(() => {
                 btn.innerText = originalText;
                 btn.disabled = false;
                 btn.style.opacity = '1';
             }, 1500);
         }
      } catch(e) {
          console.error('Error saving tables to server:', e);
          if (btn) {
             btn.innerText = 'Error al guardar';
             btn.style.background = '#dc3545';
             setTimeout(() => {
                 btn.innerText = originalText;
                 btn.disabled = false;
                 btn.style.background = '';
                 btn.style.opacity = '1';
             }, 2000);
          }
          alert('Error al guardar en el servidor. Verifique su conexión.');
      }
    }

    function renderZones() {
      zoneSelect.innerHTML = '';
      data.zones.forEach(z => {
        const opt = document.createElement('option');
        opt.value = z.id;
        opt.textContent = z.name;
        if (z.id === currentZoneId) opt.selected = true;
        zoneSelect.appendChild(opt);
      });
    }

    function updateToolbarState() {
      if (selectedTableId) {
        rotateBtn.disabled = false;
        delBtn.disabled = false;
        rotateBtn.style.opacity = '1';
        delBtn.style.opacity = '1';
      } else {
        rotateBtn.disabled = true;
        delBtn.disabled = true;
        rotateBtn.style.opacity = '0.5';
        delBtn.style.opacity = '0.5';
      }
    }

    // Drag State
    let dragState = {
      active: false,
      el: null,
      table: null,
      startX: 0,
      startY: 0,
      initialLeft: 0,
      initialTop: 0,
      hasMoved: false
    };

    window.printBill = async function(orderId) {
        try {
            const res = await fetch(`/api/orders/${orderId}`);
            if (!res.ok) throw new Error('Error al cargar pedido');
            const data = await res.json();
            const o = data.order;
            const items = data.items || [];
            
            const tenantName = document.getElementById('tenant-input')?.value || 'Restaurante';
            const dateStr = new Date(o.created_at).toLocaleString('es-AR');
            
            const typeRaw = String(o.order_type || '').trim().toLowerCase();
            const isMesa = (typeRaw === 'mesa');
            const isDireccion = (typeRaw === 'direccion');
            const isEspera = (typeRaw === 'espera');

            let destText = 'Mostrador';
            if (isMesa) {
                destText = `Mesa: ${o.table_number || 'Mostrador'}`;
            } else if (isDireccion) {
                const addr = getAddressText(o.address_json);
                const name = (o.customer_name || '').trim();
                destText = `Delivery: ${addr}`;
                if (name) destText += `<br>Cliente: ${name}`;
            } else if (isEspera) {
                const name = (o.customer_name || '').trim();
                destText = `Retira: ${name || 'Mostrador'}`;
            }
            
            let itemsHtml = '<table style="width:100%; border-collapse:collapse; font-size:12px; margin:10px 0;">';
            itemsHtml += '<tr style="border-bottom:1px solid #000;"><th>Cant</th><th style="text-align:left;">Desc</th><th style="text-align:right;">Tot</th></tr>';
            
            items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td style="text-align:center;">${item.qty}</td>
                        <td>${item.name}</td>
                        <td style="text-align:right;">$${item.qty * item.unit_price}</td>
                    </tr>
                `;
            });

            if (isDireccion && o.shipping_cost) {
                itemsHtml += `
                    <tr>
                        <td style="text-align:center;">1</td>
                        <td>Envío</td>
                        <td style="text-align:right;">$${o.shipping_cost}</td>
                    </tr>
                `;
            }

            itemsHtml += '</table>';
            
            let total = o.total;
            const tip = Math.round(total * 0.10);
            const totalWithTip = total + tip;
            
            let tipSection = '';
            if (isMesa) {
                tipSection = `
                    <div style="margin-top:10px; border-top: 1px dotted #000; padding-top:5px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                            <span>Propina Sugerida (10%):</span>
                            <span>$${tip}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1em; margin-top:2px;">
                            <span>Total con Propina:</span>
                            <span>$${totalWithTip}</span>
                        </div>
                    </div>
                `;
            }

            const html = `
                <html>
                <head>
                    <title>Cuenta #${o.id}</title>
                    <style>
                        @media print {
                            @page { margin: 0; size: auto; }
                            body { margin: 0; padding: 0; }
                        }
                        body { font-family: 'Courier New', monospace; width: 100%; max-width: 80mm; margin: 0 auto; padding: 5px; color: #000; box-sizing: border-box; }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .line { border-bottom: 1px dashed #000; margin: 10px 0; }
                        .cut-feed { display: block; height: 20mm; color: transparent; }
                    </style>
                </head>
                <body>
                    <div class="center bold">${tenantName.toUpperCase()}</div>
                    <div class="center">${destText}</div>
                    <div class="center">Pedido: #${o.id}</div>
                    <div class="center">${dateStr}</div>
                    <div class="line"></div>
                    ${itemsHtml}
                    <div class="line"></div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1em;">
                        <span>TOTAL:</span>
                        <span>$${total}</span>
                    </div>
                    ${tipSection}
                    <div class="center" style="margin-top:20px;">¡Gracias por su visita!</div>
                    <div class="cut-feed">.</div>
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `;
            
            const win = window.open('', 'PrintBill', 'height=600,width=400');
            win.document.write(html);
            win.document.close();
            
        } catch (e) {
            alert('Error al imprimir: ' + e.message);
        }
    };

    window.printKitchen = async function(orderId) {
        try {
            const res = await fetch(`/api/orders/${orderId}`);
            if (!res.ok) throw new Error('Error al cargar pedido');
            const data = await res.json();
            const o = data.order;
            const items = data.items || [];
            
            const dateStr = new Date(o.created_at).toLocaleString('es-AR');

            const typeRaw = String(o.order_type || '').trim().toLowerCase();
            const isMesa = (typeRaw === 'mesa');
            const isDireccion = (typeRaw === 'direccion');
            const isEspera = (typeRaw === 'espera');

            let destText = 'Mostrador';
            if (isMesa) {
                destText = `Mesa: ${o.table_number || 'Mostrador'}`;
            } else if (isDireccion) {
                const addr = getAddressText(o.address_json);
                const name = (o.customer_name || '').trim();
                destText = `Delivery: ${addr}`;
                if (name) destText += `<br>Cliente: ${name}`;
            } else if (isEspera) {
                const name = (o.customer_name || '').trim();
                destText = `Retira: ${name || 'Mostrador'}`;
            }
            
            let itemsHtml = '<table style="width:100%; border-collapse:collapse; font-size:14px; margin:10px 0;">';
            itemsHtml += '<tr style="border-bottom:2px solid #000;"><th>Cant</th><th style="text-align:left;">Producto</th></tr>';
            
            items.forEach(item => {
                let details = '';
                if (item.modifiers_json) {
                    try {
                        const mods = JSON.parse(item.modifiers_json);
                        if (Array.isArray(mods) && mods.length > 0) {
                            details += `<div style="font-size:12px; margin-left:10px;">- ${mods.map(m => m.name).join('<br>- ')}</div>`;
                        } else if (typeof mods === 'object') {
                             // Handle object format if necessary
                        }
                    } catch(e) {}
                }
                if (item.notes) {
                    details += `<div style="font-size:12px; margin-left:10px; font-weight:bold;">NOTA: ${item.notes}</div>`;
                }
                
                itemsHtml += `
                    <tr>
                        <td style="text-align:center; font-weight:bold; font-size:16px; padding: 5px 0;">${item.qty}</td>
                        <td style="padding: 5px 0;">
                            <div style="font-weight:bold; font-size:16px;">${item.name}</div>
                            ${details}
                        </td>
                    </tr>
                `;
            });
            itemsHtml += '</table>';
            
            const html = `
                <html>
                <head>
                    <title>Comanda #${o.id}</title>
                    <style>
                        @media print {
                            @page { margin: 0; size: auto; }
                            body { margin: 0; padding: 0; }
                        }
                        body { font-family: 'Courier New', monospace; width: 100%; max-width: 80mm; margin: 0 auto; padding: 5px; color: #000; box-sizing: border-box; }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .big { font-size: 1.5em; }
                        .line { border-bottom: 2px dashed #000; margin: 10px 0; }
                        .cut-feed { display: block; height: 20mm; color: transparent; }
                    </style>
                </head>
                <body>
                    <div class="center bold big">COCINA</div>
                    <div class="center bold">${destText}</div>
                    <div class="center">Pedido: #${o.id}</div>
                    <div class="center">${dateStr}</div>
                    <div class="line"></div>
                    ${itemsHtml}
                    <div class="line"></div>
                    ${o.order_notes ? `<div style="font-weight:bold; font-size:1.2em; border: 2px solid #000; padding: 5px;">NOTA GRAL: ${o.order_notes}</div>` : ''}
                    <div class="cut-feed">.</div>
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `;
            
            const win = window.open('', 'PrintKitchen', 'height=600,width=400');
            win.document.write(html);
            win.document.close();
            
        } catch (e) {
            alert('Error al imprimir comanda: ' + e.message);
        }
    };

    window.showPrintOptions = function(orderId) {
        const modal = document.getElementById('print-options-modal');
        if (!modal) {
            const m = document.createElement('div');
            m.id = 'print-options-modal';
            m.className = 'kds-modal';
            m.innerHTML = `
                <div class="kds-modal-overlay" onclick="document.getElementById('print-options-modal').classList.remove('active')"></div>
                <div class="kds-modal-content" style="width: 300px; padding: 20px; text-align: center;">
                    <h3 style="margin-top:0;">Imprimir Pedido</h3>
                    <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                        <button onclick="window.printBill(window._printOrderId); document.getElementById('print-options-modal').classList.remove('active');" style="padding:12px; background:#607d8b; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center;">
                            <svg style="width:20px;height:20px;margin-right:8px;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
                            Ticket Cliente (Cuenta)
                        </button>
                        <button onclick="window.printKitchen(window._printOrderId); document.getElementById('print-options-modal').classList.remove('active');" style="padding:12px; background:#ef6c00; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center;">
                            <svg style="width:20px;height:20px;margin-right:8px;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 12.99l1.47-1.46z"/></svg>
                            Ticket Cocina (Comanda)
                        </button>
                    </div>
                    <button onclick="document.getElementById('print-options-modal').classList.remove('active')" style="margin-top:20px; background:transparent; border:1px solid #ccc; color:#666; width:100%; padding:8px;">Cancelar</button>
                </div>
            `;
            document.body.appendChild(m);
        }
        window._printOrderId = orderId;
        const m = document.getElementById('print-options-modal');
        m.querySelector('h3').textContent = 'Imprimir Pedido #' + orderId;
        m.classList.add('active');
    };

    function renderOrderInModal(detail, container) {
         container.innerHTML = '';
         const o = detail.order;
         if (!o) {
             container.innerHTML = '<div class="small error">Datos de pedido no válidos</div>';
             return;
         }
         
         const typeRaw = String(o.order_type || '').trim().toLowerCase();
         const isMesa = (typeRaw === 'mesa');
         const isEspera = (typeRaw === 'espera');
         const isDireccion = (typeRaw === 'direccion');
         const isPaid = (String(o.payment_status || '').toLowerCase() === 'paid');
         
         const destLabel = (typeof destinoLabelFor === 'function') ? destinoLabelFor(o) : (o.table_number || o.order_type);
         
         const phoneRaw = ((isDireccion || isEspera) && o.customer_phone) ? String(o.customer_phone) : '';
         const phoneDigits = phoneRaw.replace(/\D/g, '');
         const waUrl = getWaLink(o, phoneDigits);
         
         const statusClass = (typeof statusClasses !== 'undefined' && statusClasses[o.status]) ? statusClasses[o.status] : 'status-pendiente';
         const statusLabelText = (isMesa && o.status === 'en_camino') ? 'mesa' : o.status;
         
         // Buttons logic
         let pDisabled = '', lDisabled = '', eDisabled = '', cDisabled = '';
         const s = o.status;
         
         if (isMesa || isEspera) {
             const isPrepOrLater = ['preparacion', 'listo', 'en_camino', 'entregado'].includes(s);
             const isListoOrLater = ['listo', 'en_camino', 'entregado'].includes(s);
             if (!isPrepOrLater) lDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isListoOrLater) eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (isEspera && !isPaid) eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;" title="Debe cobrar antes de entregar"';
         } else {
             const isPrepOrLater = ['preparacion', 'listo', 'en_camino', 'entregado'].includes(s);
             const isListoOrLater = ['listo', 'en_camino', 'entregado'].includes(s);
             const isEnCaminoOrLater = ['en_camino', 'entregado'].includes(s);
             if (!isPrepOrLater) lDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isListoOrLater) cDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
             if (!isEnCaminoOrLater) eDisabled = 'disabled style="opacity:0.3;cursor:not-allowed;"';
         }

         let enCaminoBtn = '';
         const payBtn = isPaid 
             ? `<button class="status-action mesa paid" disabled style="opacity:0.3;cursor:default;" aria-label="Pagado" data-tip="Pagado">$</button>`
             : `<button class="status-action mesa" data-action="pay" aria-label="Cobrar" data-tip="Cobrar">$</button>`;

         if (isMesa || isEspera) {
             enCaminoBtn = payBtn;
         } else {
             enCaminoBtn = `<button class="status-action en_camino" data-status="en_camino" aria-label="En camino" data-tip="En camino" ${cDisabled}>C</button>${payBtn}`;
         }
         
         const entregadoBtn = `<button class="status-action entregado" data-status="entregado" aria-label="Entregado" data-tip="Entregado" ${eDisabled}>E</button>`;
         const prepBtn = `<button class="status-action preparacion" data-status="preparacion" aria-label="Preparación" data-tip="Preparación" ${pDisabled}>P</button>`;
         const listoBtn = `<button class="status-action listo" data-status="listo" aria-label="Listo" data-tip="Listo" ${lDisabled}>L</button>`;
         
         const card = document.createElement('div');
         card.className = 'card';
         
         const itemsHtml = (detail.items || []).map(it => 
             `<div class="small" style="display:flex; justify-content:space-between;"><span>${it.qty} x ${it.name}</span><span>$${it.qty*it.unit_price}</span></div>`
         ).join('');

         card.innerHTML = `
            <div class="card-content">
              <div class="title">Pedido #${o.id} · Destino: ${(isMesa || isEspera)?`<span class='pill pill-mesa'>${destLabel}</span>`:destLabel}</div>
              <div class="meta">${new Date(o.created_at).toLocaleString()} · ${o.order_type}</div>
              <div class="meta">${phoneRaw ? `Tel: ${phoneRaw}` : ''} ${waUrl ? `<a href='${waUrl}' target='_blank' rel='noopener'>WhatsApp</a>`:''}</div>
              <div class="grid">
                <div>Total: $${o.total}</div>
                ${(isDireccion && o.shipping_cost) ? `<div class="total-tip" style="color:#666;">Envío: ${o.shipping_cost}</div>` : ''}
              </div>
              <div class="items-preview" style="margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
                  ${itemsHtml}
              </div>
            </div>
            <div class="state-line"><span class="status-badge ${statusClass}">${statusLabelText}</span>${(typeof renderSLA === 'function')?renderSLA(o):''}</div>
            <div class="actions">
              <div class="status-quick">
                ${prepBtn}
                ${listoBtn}
                ${enCaminoBtn}
                ${entregadoBtn}
                <button class="status-action" onclick="EditOrder.open({id:${o.id}, table_number:'${o.table_number||''}'}, ${JSON.stringify(detail.items || []).replace(/"/g, '&quot;')})" style="background:#f3f4f6; color:#374151; width:auto; padding:0 10px;" title="Editar Items"><svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                <button class="status-action cancelado" data-status="cancelado" aria-label="Cancelado" data-tip="Cancelado">X</button>
              </div>
              <div class="print-actions" style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px;">
                <button class="status-action" onclick="window.showPrintOptions(${o.id})" style="width: 100%; padding: 10px; background: #607d8b; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer;" title="Imprimir">
                    <svg style="width:18px;height:18px;margin-right:6px;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
                    Imprimir
                </button>
              </div>
            </div>
         `;
         
         container.appendChild(card);
         
         const quickBtns = Array.from(card.querySelectorAll('.status-action'));
         quickBtns.forEach(qb => {
            qb.addEventListener('click', async (e) => {
                 e.stopPropagation(); 
                 const action = qb.getAttribute('data-action');
                 if (action === 'pay') {
                      if (qb.classList.contains('paid')) return;
                      if (typeof askPaymentMethod === 'function' && typeof payOrder === 'function') {
                          const methodData = await askPaymentMethod(o.total, (o.order_type || '').toLowerCase() === 'mesa');
                          if (!methodData) return;
                          try {
                              await payOrder(o.id, methodData);
                              o.payment_status = 'paid';
                              qb.classList.add('paid');
                              qb.disabled = true;
                              qb.style.opacity = '0.3';
                              qb.style.cursor = 'default';
                              const parent = qb.closest('.status-quick');
                              if (parent) {
                                  const entBtn = parent.querySelector('.entregado');
                                  if (entBtn) {
                                      entBtn.disabled = false;
                                      entBtn.style.opacity = '';
                                      entBtn.style.cursor = '';
                                  }
                              }
                          } catch(err) { alert(err.message); }
                      }
                      return;
                 }
                 
                 const newStatus = qb.getAttribute('data-status');
                 if (!newStatus) return;
                 
                 if (newStatus === 'entregado') {
                      if (typeof askConfirm === 'function') {
                          if (!await askConfirm('¿Confirma entrega?')) return;
                      }
                 } else if (newStatus !== 'entregado') {
                      if (typeof askConfirm === 'function') {
                          if (!await askConfirm(`¿Cambiar estado a ${newStatus}?`)) return;
                      }
                 }
                 
                 let reason = '';
                 if (newStatus === 'cancelado') {
                      reason = prompt('Motivo de cancelación:') || '';
                 }
                 
                 if (typeof updateStatus === 'function') {
                     try {
                         await updateStatus(o.id, newStatus, reason);
                         const modal = document.getElementById('table-detail-modal');
                         if(modal) {
                            modal.style.display = 'none';
                            modal.classList.remove('active');
                         }
                         if (typeof renderTables === 'function') renderTables();
                     } catch(err) {
                         alert('Error al actualizar: ' + err.message);
                     }
                 }
            });
         });
    }

    function openTableDetails(table) {
        const modal = document.getElementById('table-detail-modal');
        const title = document.getElementById('tdm-title');
        const container = document.getElementById('tdm-order-container');
        const closeBtn = document.getElementById('tdm-close');
        const overlay = modal.querySelector('.kds-modal-overlay');
        const btns = modal.querySelectorAll('.btn-status');
        
        // QR Elements
        const qrBtn = document.getElementById('tdm-generate-qr');
        const qrDisplay = document.getElementById('tdm-qr-display');
        const qrCodeContainer = document.getElementById('tdm-qr-code');
        const qrLink = document.getElementById('tdm-qr-link');
        const qrPrintBtn = document.getElementById('tdm-print-qr');
        
        if(!modal) return;
        
        title.textContent = `Detalle: ${table.label}`;
        
        // Separate Button Logic
        const existingSepBtn = document.getElementById('tdm-separate-btn');
        if (existingSepBtn) existingSepBtn.remove();

        if (table.is_merged) {
             const sepBtn = document.createElement('button');
             sepBtn.id = 'tdm-separate-btn';
             sepBtn.textContent = 'Separar Mesas';
             sepBtn.style.cssText = 'background: #f57c00; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 12px;';
             sepBtn.onclick = () => {
                 if (confirm('¿Separar las mesas y restaurar las originales?')) {
                     const zone = data.zones.find(z => z.id === currentZoneId);
                     if (zone) {
                         // Remove merged table
                         zone.tables = zone.tables.filter(t => t.id !== table.id);
                         // Restore originals
                         if (table.original_tables && Array.isArray(table.original_tables)) {
                             zone.tables.push(...table.original_tables);
                         }
                         saveData();
                         renderTables();
                         close();
                     }
                 }
             };
             title.appendChild(sepBtn);
        }

        modal.classList.add('active');
        modal.style.display = 'flex';
        
        // Reset QR
        if (qrDisplay) qrDisplay.style.display = 'none';
        if (qrCodeContainer) qrCodeContainer.innerHTML = '';
        
        if (qrBtn) {
            qrBtn.onclick = () => {
                if (!qrDisplay || !qrCodeContainer) return;
                
                qrCodeContainer.innerHTML = '';
                const origin = window.location.origin;
                // Usar gastronomia-local1.html
                const targetUrl = `${origin}/gastronomia-local1.html?table=${encodeURIComponent(table.label)}`;
                
                new QRCode(qrCodeContainer, {
                    text: targetUrl,
                    width: 128,
                    height: 128,
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                if (qrLink) {
                    qrLink.href = targetUrl;
                    qrLink.textContent = targetUrl;
                }
                
                qrDisplay.style.display = 'flex';
            };
        }

        if (qrPrintBtn) {
            qrPrintBtn.onclick = () => {
                const img = qrCodeContainer.querySelector('img');
                if (img && img.src) {
                    const win = window.open('', 'Print', 'height=600,width=800');
                    const label = table.label.toLowerCase().startsWith('mesa') ? table.label : 'Mesa ' + table.label;
                    win.document.write('<html><head><title>' + label + '</title></head><body style="text-align:center; font-family: sans-serif; padding-top: 50px;">');
                    win.document.write('<h1 style="margin-bottom: 20px;">' + label + '</h1>');
                    win.document.write('<img src="' + img.src + '" style="width:300px; height:300px;"/>');
                    win.document.write('<p style="margin-top: 20px;">Escanea para ver el menú</p>');
                    win.document.write('<script>window.onload = function(){ window.print(); window.close(); }<\/script>');
                    win.document.write('</body></html>');
                    win.document.close();
                } else {
                    alert('El código QR aún se está generando. Intente nuevamente.');
                }
            };
        }
        
        const close = () => {
            modal.style.display = 'none';
            modal.classList.remove('active');
        };
        
        closeBtn.onclick = close;
        if(overlay) overlay.onclick = close;
        // Fallback for click outside content if overlay doesn't catch it
        modal.onclick = (e) => { if(e.target === modal) close(); };
        
        btns.forEach(btn => {
            btn.onclick = () => {
                table.status = btn.dataset.status;
                saveData();
                renderTables();
                close();
            };
        });
        
        container.innerHTML = '<div class="small" style="text-align: center; color: #888; padding: 20px;">Buscando pedido...</div>';
        
        const activeOrders = window.currentOrders || [];
        const order = activeOrders.find(o => {
            if ((o.order_type || '').toLowerCase() !== 'mesa') return false;
            // Permitir ver pedidos entregados si la mesa sigue ocupada/cuenta (opcional, pero por ahora mantenemos filtro activo)
            // Si queremos mostrar la cuenta pendiente, deberíamos incluir 'entregado' si payment_status != 'paid'
            // Pero el usuario dice "Sin pedido activo", asumamos que busca pedidos en curso (pendiente/preparacion/listo)
            if (o.status === 'cancelado') return false;
            if (o.status === 'entregado' && (o.payment_status||'').toLowerCase() === 'paid') return false; 

            const tNum = String(o.table_number || '').trim().toLowerCase();
            const tLbl = String(table.label || '').trim().toLowerCase();
            
            if (!tNum) return false;
            
            // Exact or number match
            if (tNum === tLbl) return true;
            
            const n1 = tNum.match(/\d+/);
            const n2 = tLbl.match(/\d+/);

            if (n1 && n2) {
                // Both have numbers -> Compare numeric values strictly
                if (parseInt(n1[0], 10) === parseInt(n2[0], 10)) return true;
            } else if (!n1 && !n2) {
                 // Neither has numbers -> Fuzzy string match (e.g. "Barra")
                 if (tLbl.includes(tNum) || tNum.includes(tLbl)) return true;
            }
            
            return false;
        });
        
        if (order) {
            if (typeof fetchOrderDetail === 'function') {
                fetchOrderDetail(order.id).then(detail => {
                     renderOrderInModal(detail, container);
                }).catch(() => {
                    container.innerHTML = '<div class="small error">Error al cargar pedido</div>';
                });
            } else {
                 container.innerHTML = '<div class="small">Detalles no disponibles</div>';
            }
        } else {
            container.innerHTML = '<div class="small" style="text-align: center; padding: 20px; color: #666;">Sin pedido activo</div>';
            
            const createBtn = document.createElement('button');
            createBtn.textContent = 'Crear Pedido';
            createBtn.style.cssText = 'display:block; margin: 10px auto; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;';
            createBtn.onclick = () => {
                close();
                const newOrderBtn = document.getElementById('btn-new-order');
                if (newOrderBtn) newOrderBtn.click();
                
                setTimeout(() => {
                    const typeSelect = document.getElementById('new-order-type');
                    if(typeSelect) {
                        typeSelect.value = 'mesa';
                        typeSelect.dispatchEvent(new Event('change'));
                    }
                    const tableSelect = document.getElementById('new-order-table');
                    if(tableSelect) {
                         // Attempt to set table
                         // Options values are strictly table.label
                         tableSelect.value = table.label;
                    }
                }, 200);
            };
            container.appendChild(createBtn);
        }
    }

    function renderTables() {
      if (!mapContainer) return;
      mapContainer.innerHTML = '';
      
      const zone = data.zones.find(z => z.id === currentZoneId);
      if (!zone) return;

      const activeOrders = window.currentOrders || [];

      zone.tables.forEach(table => {
        const el = document.createElement('div');
        
        // --- Logic to check for active order ---
        let displayStatus = table.status;
        let displayTotal = null;
        
        // Find matching active order
        // Logic similar to openTableDetails
        const order = activeOrders.find(o => {
            if ((o.order_type || '').toLowerCase() !== 'mesa') return false;
            if (o.status === 'cancelado') return false;
            // If delivered but unpaid, it is still occupied (cuenta)
            // If delivered and paid, it should be free visually unless manual status says otherwise?
            // Usually 'entregado' + 'paid' = customer left.
            if (o.status === 'entregado' && (o.payment_status||'').toLowerCase() === 'paid') return false; 

            const tNum = String(o.table_number || '').trim().toLowerCase();
            const tLbl = String(table.label || '').trim().toLowerCase();
            if (!tNum) return false;
            
            // Exact or number match
            if (tNum === tLbl) return true;
            
            const n1 = tNum.match(/\d+/);
            const n2 = tLbl.match(/\d+/);

            if (n1 && n2) {
                // Both have numbers -> Compare numeric values strictly
                if (parseInt(n1[0], 10) === parseInt(n2[0], 10)) return true;
            } else if (!n1 && !n2) {
                 // Neither has numbers -> Fuzzy string match (e.g. "Barra")
                 if (tLbl.includes(tNum) || tNum.includes(tLbl)) return true;
            }
            
            return false;
        });
        
        if (order) {
            displayStatus = 'occupied';
            // If waiting for payment (entregado but not paid), maybe blue?
            if (order.status === 'entregado' && (order.payment_status||'').toLowerCase() !== 'paid') {
                displayStatus = 'bill'; // Blue
            }
            displayTotal = order.total;
        }
        // ---------------------------------------

        el.className = `table-item ${table.type} status-${displayStatus}`;
        if (table.id === selectedTableId) el.classList.add('selected');
        
        el.style.left = table.x + 'px';
        el.style.top = table.y + 'px';
        el.style.transform = `rotate(${table.rotation || 0}deg)`;
        
        // Dimensions
        let w = 100, h = 80;
        const sizeMultiplier = { small: 0.7, medium: 1, large: 1.3, xlarge: 1.6 };
        const mult = sizeMultiplier[table.size || 'medium'] || 1;
        
        if (table.type === 'round') { w = 80 * mult; h = 80 * mult; }
        else if (table.type === 'bar') { w = 160 * mult; h = 60 * mult; }
        else { w = 100 * mult; h = 80 * mult; }
        
        el.style.width = w + 'px';
        el.style.height = h + 'px';
        
        let displayTime = '';
        let timeColor = '#333';
        
        if (order && order.created_at) {
             const created = parseDateSafe(order.created_at);
             const now = Date.now();
             const diff = Math.floor((now - created) / 60000); // minutes
             const hrs = Math.floor(diff / 60);
             const mins = diff % 60;
             displayTime = `${hrs > 0 ? hrs + 'h ' : ''}${mins}m`;
             
             // Lógica Semáforo (Alertas Visuales)
             if (diff > 60) {
                 // Crítico (> 1 hora)
                 timeColor = '#d32f2f';
                 el.style.border = '3px solid #d32f2f';
                 el.style.boxShadow = '0 0 10px rgba(211, 47, 47, 0.5)';
                 el.style.animation = 'pulse-border 2s infinite';
             } else if (diff > 30) {
                 // Advertencia (30-60 min)
                 timeColor = '#e65100';
                 el.style.border = '2px solid #fb8c00';
             } else {
                 // Normal (< 30 min)
                 timeColor = '#2e7d32';
             }
        }

        let contentHtml = `
          <div class="table-label" style="font-size:${14*mult}px">${table.label}</div>
          <div class="table-seats" style="font-size:${10*mult}px">${displayStatus.toUpperCase()}</div>
        `;
        
        if (displayTime) {
             contentHtml += `<div class="table-time" style="font-size:${10*mult}px; color:${timeColor}; font-weight:bold; margin-top:2px;">⏱ ${displayTime}</div>`;
        }

        if (displayTotal !== null) {
            contentHtml += `<div class="table-total" style="font-size:${11*mult}px">$${displayTotal}</div>`;
        }
        
        if (mergeState.active && mergeState.selectedIds.includes(table.id)) {
             el.style.border = '3px dashed #2196F3';
             el.style.backgroundColor = '#E3F2FD';
             el.style.zIndex = 1000;
        }

        el.innerHTML = contentHtml;
        
        el.addEventListener('mousedown', (e) => {
          if (e.button !== 0) return;
          e.stopPropagation(); // Prevent map click
          
          delete el.dataset.wasDragging; // Clear stale drag state
          
          // Update Selection without re-rendering
          selectedTableId = table.id;
          document.querySelectorAll('.table-item').forEach(item => item.classList.remove('selected'));
          el.classList.add('selected');
          updateToolbarState();

          // Init Drag
          dragState.active = true;
          dragState.el = el;
          dragState.table = table;
          dragState.startX = e.clientX;
          dragState.startY = e.clientY;
          dragState.initialLeft = table.x;
          dragState.initialTop = table.y;
          dragState.hasMoved = false;
          
          el.style.zIndex = 100;
        });

        // Revised Click Handler
        el.onclick = (e) => {
          e.stopPropagation();

          if (mergeState.active) {
              const idx = mergeState.selectedIds.indexOf(table.id);
              if (idx >= 0) {
                  mergeState.selectedIds.splice(idx, 1);
              } else {
                  if (table.status !== 'free' && table.status !== 'libre') {
                      alert('Solo se pueden seleccionar mesas libres.');
                      return;
                  }
                  mergeState.selectedIds.push(table.id);
              }
              renderTables();
              return;
          }

          // If we just dragged, don't toggle.
          // We can check if the position changed significantly from mousedown start?
          // But we don't have access to mousedown start here easily unless we store it on the element.
          
          // Let's use the 'dragState.hasMoved' but we need to ensure it's not cleared before click fires.
          // Click fires immediately after mouseup.
          // Let's clear dragState in a setTimeout in mouseup? No, risky.
          
          // Alternative: Status toggling only happens on double click? Or right click?
          // User asked for drag fix. Let's keep single click but make sure drag doesn't trigger it.
          
          // I'll add a 'wasDragging' flag to the element in mouseup if moved.
          if (el.dataset.wasDragging === 'true') {
            delete el.dataset.wasDragging;
            return;
          }

          openTableDetails(table);
        };

        mapContainer.appendChild(el);
      });
      
      updateToolbarState();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTableManagement);
    } else {
      initTableManagement();
    }
  })();
</script>
<!-- Table Details Modal -->
<div id="table-detail-modal" class="kds-modal" style="display: none; align-items: center; justify-content: center; z-index: 2000;" aria-hidden="true" role="dialog">
  <div class="kds-modal-overlay"></div>
  <div class="kds-modal-content" style="width: 90%; max-width: 500px; display: flex; flex-direction: column; padding: 0;">
    <div class="kds-modal-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
      <h2 id="tdm-title" style="margin: 0; font-size: 1.2rem;">Detalle de Mesa</h2>
      <button id="tdm-close" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">CERRAR</button>
    </div>
    <div class="kds-modal-body" style="padding: 15px; overflow-y: auto;">
      
      <!-- Order Content -->
      <div id="tdm-order-container">
        <div class="small" style="text-align: center; color: #888; padding: 20px;">Cargando información...</div>
      </div>

      <!-- QR Code Section -->
      <div id="tdm-qr-section" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; text-align: center;">
        <button id="tdm-generate-qr" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Generar QR de Mesa</button>
        <div id="tdm-qr-display" style="margin-top: 15px; display: none; flex-direction: column; align-items: center; gap: 8px;">
            <div id="tdm-qr-code"></div>
            <a id="tdm-qr-link" href="#" target="_blank" style="font-size: 12px; color: #2563eb;">Abrir enlace</a>
            <button id="tdm-print-qr" style="background: #10b981; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px;">🖨 Imprimir QR</button>
        </div>
      </div>

      <!-- Status Controls -->
      <div class="tm-status-controls" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
        <h3 style="font-size: 14px; margin-bottom: 10px; color: #555;">Cambiar Estado:</h3>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
           <button class="btn-status" data-status="free" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background: #e8f5e9; color: #2e7d32; font-weight: 600;">Libre</button>
           <button class="btn-status" data-status="occupied" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background: #ffebee; color: #c62828; font-weight: 600;">Ocupada</button>
           <button class="btn-status" data-status="reserved" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background: #fff3e0; color: #ef6c00; font-weight: 600;">Reservada</button>
           <button class="btn-status" data-status="bill" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background: #e3f2fd; color: #1565c0; font-weight: 600;">Cuenta</button>
        </div>
      </div>

    </div>
  </div>
</div>
<!-- Edit Order Modal -->
<div id="edit-order-modal" class="kds-modal" style="display: none; z-index: 2100;">
  <div class="kds-modal-overlay"></div>
  <div class="kds-modal-content" style="width: 95vw; max-width: 800px; height: 85vh; display: flex; flex-direction: column; padding: 0;">
    <div class="kds-modal-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Editar Pedido #<span id="eom-id"></span></h2>
        <button id="eom-close" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div class="kds-modal-body" style="flex: 1; display: flex; overflow: hidden;">
        <!-- Products Column -->
        <div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #eee; padding: 10px;">
            <input type="text" id="eom-search" placeholder="Buscar productos..." style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; width: 100%; box-sizing: border-box;">
            <div id="eom-products" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; align-content: start;"></div>
        </div>
        <!-- Cart Column -->
        <div style="width: 350px; display: flex; flex-direction: column; padding: 10px; background: #f9fafb;">
            <h3 style="margin: 0 0 10px 0; font-size: 1rem;">Items del Pedido</h3>
            <div id="eom-items" style="flex: 1; overflow-y: auto; gap: 8px; display: flex; flex-direction: column;"></div>
            <div style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 4px;">Detalle adicional (Orden)</label>
                    <textarea id="eom-notes" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical;" placeholder="Notas generales del pedido..."></textarea>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px;">
                    <span>Total:</span>
                    <span id="eom-total">$0</span>
                </div>
                <button id="eom-save" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Guardar Cambios</button>
            </div>
        </div>
    </div>
  </div>
</div>

<div id="product-create-modal" class="kds-modal" style="display:none;">
  <div class="kds-modal-content" style="max-width: 800px; display: flex; flex-direction: column;">
    <div class="kds-modal-header">
      <h2>Nuevo Producto</h2>
      <span class="close-create-modal" style="cursor:pointer; font-size:24px;">&times;</span>
    </div>
    <div class="kds-modal-body" style="display: flex; gap: 20px;">
      <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
        <div>
          <label>ID Producto (único)</label>
          <input type="text" id="create-prod-id" placeholder="Ej: pizza-napolitana" style="width:100%; padding:8px;">
        </div>
        <div>
          <label>Nombre del Producto</label>
          <input type="text" id="create-prod-name" placeholder="Ej: Pizza Napolitana" style="width:100%; padding:8px;">
        </div>
        <div>
          <label>Descripción / Detalles</label>
          <textarea id="create-prod-details" rows="3" placeholder="Ingredientes, detalles..." style="width:100%; padding:8px;"></textarea>
        </div>
        <div style="display:flex; gap:10px;">
          <div style="flex:1;">
            <label>Precio</label>
            <input type="number" id="create-prod-price" placeholder="0" style="width:100%; padding:8px;">
          </div>
          <div style="flex:1;">
            <label>Stock</label>
            <input type="number" id="create-prod-stock" placeholder="0" style="width:100%; padding:8px;">
          </div>
        </div>
        <div>
          <label>Sección en Carta Online</label>
          <select id="create-prod-section" style="width:100%; padding:8px;">
            <option value="">-- Sin asignar --</option>
            <option value="featured">Platos destacados</option>
            <option value="main">Menú principal</option>
            <option value="interest">Recomendados por interés</option>
          </select>
        </div>
        <div>
          <label>Categorías de filtro (menú principal)</label>
          <select id="create-prod-food-cats" multiple style="width:100%; padding:8px;">
            <option value="sandwich">Sándwich</option>
            <option value="pizzas">Pizzas</option>
            <option value="comen-dos">Comen dos</option>
            <option value="al-plato">Al plato</option>
            <option value="bebidas">Bebidas</option>
            <option value="cocteles">Cocteles</option>
            <option value="postres">Postres</option>
          </select>
          <small>Usado para los filtros de la carta online.</small>
        </div>
        <div>
          <label>Etiqueta de interés (opcional)</label>
          <select id="create-prod-interest" style="width:100%; padding:8px;">
            <option value="">Sin etiqueta</option>
            <option value="2x1">2x1</option>
            <option value="promocion">Promoción</option>
            <option value="oferta">Oferta</option>
            <option value="especialidad">Especialidad</option>
          </select>
        </div>
        <div>
          <label>Imagen del Producto</label>
          <input type="file" id="create-prod-file" accept="image/*" style="width:100%; padding:8px;">
          <input type="hidden" id="create-prod-image-url">
          <small id="create-prod-upload-status" style="color:blue;"></small>
        </div>
      </div>
      
      <!-- Preview Column -->
      <div style="width: 300px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
        <h3 style="margin-top:0;">Vista Previa</h3>
        <div class="product-card" style="border:1px solid #eee; background:white; border-radius:8px; overflow:hidden;">
            <div class="product-image" style="height:200px; background:#eee; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                <img id="create-preview-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <span id="create-preview-img-placeholder" style="color:#999;">Sin imagen</span>
            </div>
            <div class="product-info" style="padding:15px;">
                <h3 id="create-preview-title" style="margin:0 0 10px 0; font-size:1.1rem;">Título Producto</h3>
                <p id="create-preview-desc" style="color:#666; font-size:0.9rem; margin-bottom:10px;">Descripción del producto...</p>
                <p id="create-preview-price" style="font-weight:bold; color:#2e7d32; font-size:1.1rem;">$0 ARS</p>
                <button class="add-to-cart-btn" style="width:100%; background:#ff9800; color:white; border:none; padding:8px; border-radius:4px; margin-top:10px;">Añadir al carrito</button>
            </div>
        </div>
      </div>
    </div>
    <div class="kds-modal-footer" style="padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
      <button class="cancel-create-btn" style="padding: 8px 16px; background: #eee; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
      <button id="do-create-product" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Crear Producto</button>
    </div>
  </div>
</div>

<script>
window.EditOrder = {
    currentOrder: null,
    items: [],
    
    init: function() {
        this.modal = document.getElementById('edit-order-modal');
        this.closeBtn = document.getElementById('eom-close');
        this.search = document.getElementById('eom-search');
        this.productsContainer = document.getElementById('eom-products');
        this.itemsContainer = document.getElementById('eom-items');
        this.totalEl = document.getElementById('eom-total');
        this.saveBtn = document.getElementById('eom-save');
        this.notesEl = document.getElementById('eom-notes');
        
        if(this.closeBtn) this.closeBtn.onclick = () => this.close();
        const overlay = this.modal.querySelector('.kds-modal-overlay');
        if(overlay) overlay.onclick = () => this.close();
        if(this.search) this.search.oninput = (e) => this.renderProducts(e.target.value);
        if(this.saveBtn) this.saveBtn.onclick = () => this.save();
    },
    
    openWithFetch: async function(orderId, tableNumber) {
        if (!this.modal) this.init();
        try {
            const detail = await fetchOrderDetail(orderId);
            // detail has structure { order: {...}, items: [...] }
            this.open({
                id: orderId, 
                table_number: tableNumber,
                order_notes: detail.order ? detail.order.order_notes : '' // Access via detail.order
            }, detail.items || []);
        } catch(e) {
            console.error(e);
            alert('Error al cargar items del pedido');
        }
    },

    open: function(order, initialItems) {
        if (!this.modal) this.init();
        
        this.currentOrder = order;
        // Clone items
        this.items = initialItems.map(i => ({
            id: i.product_id || i.id, 
            item_id: i.id, // ID DB (pk)
            created_at: i.created_at,
            name: i.name,
            price: parseFloat(i.unit_price || i.price),
            qty: parseInt(i.qty || i.quantity || 1),
            notes: i.notes || ''
        }));
        
        const idEl = document.getElementById('eom-id');
        if(idEl) idEl.textContent = order.id;
        
        if (this.notesEl) {
            this.notesEl.value = order.order_notes || '';
        }
        
        this.modal.style.display = 'flex';
        this.modal.classList.add('active');
        
        this.renderProducts('');
        this.renderItems();
    },
    
    close: function() {
        if (!this.modal) return;
        this.modal.style.display = 'none';
        this.modal.classList.remove('active');
        this.currentOrder = null;
        this.items = [];
    },
    
    renderProducts: function(term) {
        if (!this.productsContainer) return;
        const t = term.toLowerCase();
        // Use global products array if available
        const allProducts = window.products || []; 
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(t) || p.id.toLowerCase().includes(t));
        
        this.productsContainer.innerHTML = filtered.map(p => `
            <div onclick="EditOrder.addItem('${p.id}')" style="border:1px solid #eee; padding:8px; border-radius:6px; cursor:pointer; background:white; font-size:0.9rem; display:flex; flex-direction:column; justify-content:space-between;">
                <div style="font-weight:600; margin-bottom:4px; font-size:0.85rem;">${p.name}</div>
                <div style="color:#2e7d32; font-weight:bold;">$${p.price}</div>
            </div>
        `).join('');
    },
    
    addItem: function(prodId) {
        const prod = (window.products || []).find(p => p.id === prodId);
        if (!prod) return;
        
        const existing = this.items.find(i => i.id === prod.id);
        if (existing) {
            existing.qty++;
        } else {
            this.items.push({
                id: prod.id,
                name: prod.name,
                price: parseFloat(prod.price),
                qty: 1,
                notes: ''
            });
        }
        this.renderItems();
    },
    
    updateQty: function(idx, delta) {
        const item = this.items[idx];
        item.qty += delta;
        if (item.qty <= 0) {
            this.items.splice(idx, 1);
        }
        this.renderItems();
    },

    updateItemNote: function(idx, val) {
        if (this.items[idx]) {
            this.items[idx].notes = val;
        }
    },
    
    renderItems: function() {
        if (!this.itemsContainer) return;
        let total = 0;
        this.itemsContainer.innerHTML = this.items.map((item, idx) => {
            total += item.price * item.qty;
            return `
                <div style="background:white; padding:8px; border-radius:6px; border:1px solid #eee; display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:0.9rem;">${item.name}</div>
                            <div style="font-size:0.8rem; color:#666;">$${item.price} x ${item.qty}</div>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <button onclick="EditOrder.updateQty(${idx}, -1)" style="width:24px; height:24px; background:#eee; border:none; border-radius:4px; cursor:pointer;">-</button>
                            <span style="width:20px; text-align:center; font-size:0.9rem;">${item.qty}</span>
                            <button onclick="EditOrder.updateQty(${idx}, 1)" style="width:24px; height:24px; background:#eee; border:none; border-radius:4px; cursor:pointer;">+</button>
                        </div>
                    </div>
                    <div>
                        <input type="text" placeholder="Nota del producto..." value="${item.notes || ''}" onchange="EditOrder.updateItemNote(${idx}, this.value)" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;">
                    </div>
                </div>
            `;
        }).join('');
        if (this.totalEl) this.totalEl.textContent = '$' + total;
    },
    
    save: async function() {
        if (!this.currentOrder) return;
        this.saveBtn.textContent = 'Guardando...';
        this.saveBtn.disabled = true;
        
        try {
            const payload = {
                items: this.items,
                order_notes: this.notesEl ? this.notesEl.value : ''
            };

            const resp = await wFetch('/api/orders/' + this.currentOrder.id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (resp.ok) {
                // Refresh logic
                alert('Pedido actualizado correctamente');
                this.close();
                
                // Close parent modal (Table Detail)
                const parentModal = document.getElementById('table-detail-modal');
                if (parentModal) {
                    parentModal.style.display = 'none';
                    parentModal.classList.remove('active');
                }
                
                // Reload global data
                if (typeof load === 'function') load();
            } else {
                const err = await resp.json();
                alert('Error al actualizar: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            alert('Error de conexión al guardar');
            console.error(e);
        } finally {
            if (this.saveBtn) {
                this.saveBtn.textContent = 'Guardar Cambios';
                this.saveBtn.disabled = false;
            }
        }
    }
};

async function loadGlobalProducts() {
    try {
        if (typeof wFetch !== 'function') return;
        const tenantInput = document.getElementById('tenant-input');
        const slug = (tenantInput && tenantInput.value.trim()) || defaultSlug();
        const url = new URL('/api/products', API_BASE);
        url.searchParams.set('tenant_slug', slug);
        const resp = await wFetch(url.toString());
        if (resp.ok) {
            const data = await resp.json();
            const raw = data.products || [];
            // Deduplicate
            const seen = new Set();
            const unique = [];
            for (const p of raw) {
                if (!seen.has(p.id)) {
                    seen.add(p.id);
                    unique.push(p);
                }
            }
            window.products = unique;
        }
    } catch(e) { console.error(e); }
}

document.addEventListener('DOMContentLoaded', () => {
     EditOrder.init();
     loadGlobalProducts();
});
</script>
<script>
(function() {
  const createModal = document.getElementById('product-create-modal');
  const createBtn = document.getElementById('inv-create-btn');
  const closeCreateBtn = document.querySelector('.close-create-modal');
  const cancelCreateBtn = document.querySelector('.cancel-create-btn');
  const doCreateBtn = document.getElementById('do-create-product');
  
  const pId = document.getElementById('create-prod-id');
  const pName = document.getElementById('create-prod-name');
  const pDetails = document.getElementById('create-prod-details');
  const pPrice = document.getElementById('create-prod-price');
  const pStock = document.getElementById('create-prod-stock');
  const pSection = document.getElementById('create-prod-section');
  const pInterest = document.getElementById('create-prod-interest');
  const pFoodCats = document.getElementById('create-prod-food-cats');
  const pFile = document.getElementById('create-prod-file');
  const pImgUrl = document.getElementById('create-prod-image-url');
  
  const previewTitle = document.getElementById('create-preview-title');
  const previewDesc = document.getElementById('create-preview-desc');
  const previewPrice = document.getElementById('create-preview-price');
  const previewImg = document.getElementById('create-preview-img');
  const previewPlaceholder = document.getElementById('create-preview-img-placeholder');

  if (createBtn) {
    createBtn.addEventListener('click', () => {
      pId.value = '';
      pName.value = '';
      pDetails.value = '';
      pPrice.value = '';
      pStock.value = '';
      pSection.value = '';
      if (pInterest) pInterest.value = '';
      if (pFoodCats) Array.from(pFoodCats.options || []).forEach(o => { o.selected = false; });
      pFile.value = '';
      pImgUrl.value = '';
      previewImg.style.display = 'none';
      previewPlaceholder.style.display = 'block';
      updatePreview();
      
      if (document.getElementById('create-prod-upload-status')) {
        document.getElementById('create-prod-upload-status').textContent = '';
      }
      
      createModal.style.display = 'block';
    });
  }

  function closeModal() {
    if (createModal) createModal.style.display = 'none';
  }

  if (closeCreateBtn) closeCreateBtn.addEventListener('click', closeModal);
  if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', closeModal);

  function updatePreview() {
    previewTitle.textContent = pName.value || 'Título Producto';
    previewDesc.textContent = pDetails.value || 'Descripción del producto...';
    previewPrice.textContent = '$' + (pPrice.value || '0') + ' ARS';
  }

  [pName, pDetails, pPrice].forEach(el => {
    if (el) el.addEventListener('input', updatePreview);
  });

  if (pFile) {
    pFile.addEventListener('change', async () => {
      const file = pFile.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.style.display = 'block';
        previewPlaceholder.style.display = 'none';
      };
      reader.readAsDataURL(file);
      
      const formData = new FormData();
      formData.append('file', file);
      
      const statusEl = document.getElementById('create-prod-upload-status');
      if (statusEl) statusEl.textContent = 'Subiendo imagen...';
      
      try {
        const resp = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        if (resp.ok) {
           const json = await resp.json();
           pImgUrl.value = json.url;
           if (statusEl) statusEl.textContent = 'Imagen lista';
        } else {
           if (statusEl) statusEl.textContent = 'Error al subir imagen';
        }
      } catch (e) {
        if (statusEl) statusEl.textContent = 'Error de conexión';
      }
    });
  }

  if (doCreateBtn) {
    doCreateBtn.addEventListener('click', async () => {
      const id = pId.value.trim();
      const name = pName.value.trim();
      const price = parseInt(pPrice.value) || 0;
      const stock = parseInt(pStock.value) || 0;
      const tenantSelect = document.getElementById('tenant-select');
      const tenant = tenantSelect ? tenantSelect.value : (window.BUSINESS_SLUG || 'gastronomia-local1');
      
      // Recolección robusta de categorías seleccionadas
      let selectedCats = [];
      if (pFoodCats) {
         for (let i = 0; i < pFoodCats.options.length; i++) {
             if (pFoodCats.options[i].selected) {
                 selectedCats.push(pFoodCats.options[i].value);
             }
         }
      }

      // Advertencia si es Menú Principal pero no hay filtros
      if (pSection.value === 'main' && selectedCats.length === 0) {
          if (!confirm("ADVERTENCIA: No has seleccionado ninguna 'Categoría de filtro' (ej: Pizzas, Sándwich). El producto aparecerá en la carta pero NO responderá a los botones de filtro. ¿Deseas continuar sin filtros?")) {
              return;
          }
      } else if (pSection.value === 'main') {
          // DEBUG TEMPORAL: Confirmar categorías
          if (!confirm("DEBUG: Se guardarán las siguientes categorías: " + selectedCats.join(', ') + ". ¿Continuar?")) {
              return;
          }
      }
      
      if (!id || !name || price < 0) {
        alert('Por favor complete ID, Nombre y Precio válido.');
        return;
      }
      
      const payload = {
        tenant_slug: tenant,
        id: id,
        name: name,
        details: pDetails.value,
        price: price,
        stock: stock,
        section: pSection.value,
        interest_tag: pInterest ? pInterest.value : '',
        food_categories: selectedCats,
        image_url: pImgUrl.value
      };
      
      doCreateBtn.disabled = true;
      doCreateBtn.textContent = 'Guardando...';
      
      try {
        const resp = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (resp.ok) {
          alert('Producto creado correctamente');
          closeModal();
          // Reload inventory
          const reloadBtn = document.getElementById('inv-reload');
          if (reloadBtn) reloadBtn.click();
        } else {
          const err = await resp.json();
          alert('Error: ' + (err.error || 'Desconocido'));
        }
      } catch (e) {
        alert('Error de conexión');
      } finally {
        doCreateBtn.disabled = false;
        doCreateBtn.textContent = 'Crear Producto';
      }
    });
  }
})();
</script>
</body>
</html>
